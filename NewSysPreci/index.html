<!DOCTYPE html><html lang="pt-BR"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://accounts.google.com https://apis.google.com https://www.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com https://accounts.google.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; connect-src 'self' https://accounts.google.com https://www.googleapis.com https://oauth2.googleapis.com; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APS - Sistema de Precifica√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#1a1a1a'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .dark .card-hover:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }

        .tab-button {
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background-color: #1a1a1a;
            color: white;
        }

        .tab-button:not(.active) {
            background-color: transparent;
            color: #6b7280;
        }

        .dark .tab-button:not(.active) {
            color: #9ca3af;
        }
    
        /* Sidebar Navigation */
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item.active {
            background-color: #374151;
            border-left: 3px solid #f59e0b;
        }
        
        .nav-item:not(.active) {
            border-left: 3px solid transparent;
        }
        
        /* Hide tab buttons since we use sidebar */
        .tab-button {
            display: none;
        }

        /* Cream accent for inputs */
        input:focus, select:focus, textarea:focus {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
        }

        /* Google Auth Styles */
        .login-overlay { backdrop-filter: blur(8px); background: rgba(0, 0, 0, 0.7); }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #f59e0b; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sync-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>

    <!-- Google Identity Services -->
    <script>
        // Flag to track Google API load status
        window.googleApiLoaded = false;
        window.googleApiLoadError = null;

        function onGoogleApiLoad() {
            window.googleApiLoaded = true;
            console.log('Google API loaded successfully');
            if (window.onGoogleReady) window.onGoogleReady();
        }

        function onGoogleApiError(e) {
            window.googleApiLoadError = e || 'Failed to load Google API';
            console.error('Google API load error:', e);
        }
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="onGoogleApiLoad()" onerror="onGoogleApiError(event)"></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body class="bg-gray-100 transition-colors duration-200">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 login-overlay z-[100] flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-[#1a1a1a] rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">APS - Sistema de Precifica√ß√£o</h1>
                <p class="text-gray-500 mt-2">Fa√ßa login para sincronizar com Google Drive</p>
            </div>
            <div id="loginContent">
                <button id="googleLoginBtn" onclick="GoogleAuth.signIn()" class="w-full flex items-center justify-center gap-3 px-6 py-3 bg-white border-2 border-gray-200 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all font-medium text-gray-700">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Entrar com Google
                </button>
                <div class="mt-6 text-center">
                    <button onclick="GoogleAuth.continueOffline()" class="text-sm text-gray-500 hover:text-gray-700 underline">Continuar sem login (modo offline)</button>
                </div>
            </div>
            <div id="loginLoading" class="hidden text-center py-4">
                <div class="spinner mx-auto mb-3"></div>
                <p class="text-gray-500">Autenticando...</p>
            </div>
            <div id="loginError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-600 text-sm" id="loginErrorText"></p>
                <button onclick="GoogleAuth.resetLogin()" class="mt-2 text-sm text-red-500 hover:text-red-700 underline">Tentar novamente</button>
            </div>
            <div class="mt-8 pt-6 border-t border-gray-200">
                <p class="text-xs text-gray-400 text-center">Seus dados ser√£o sincronizados com o Google Drive.</p>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-60 bg-[#1a1a1a] text-gray-900 z-50 flex flex-col shadow-xl">
        <!-- Logo -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-[#1a1a1a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white">APS</h1>
                    <p class="text-xs text-gray-400">Sistema de Precifica√ß√£o</p>
                </div>
            </div>
        </div>

        <!-- User Info Section -->
        <div id="userInfoSection" class="hidden p-3 border-b border-gray-700 bg-gray-800/50">
            <div class="flex items-center space-x-3">
                <img id="userAvatar" src="" alt="Avatar" class="w-8 h-8 rounded-full">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-sm font-medium text-white truncate"></p>
                    <div class="flex items-center space-x-1">
                        <span id="syncStatusDot" class="w-2 h-2 rounded-full bg-green-500"></span>
                        <span id="syncStatusText" class="text-xs text-gray-400">Sincronizado</span>
                    </div>
                </div>
                <button onclick="GoogleAuth.signOut()" class="p-1 text-gray-400 hover:text-white" title="Sair">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                </button>
            </div>
        </div>

        <!-- Offline Mode Banner -->
        <div id="offlineModeBanner" class="hidden p-2 bg-yellow-600/20 border-b border-yellow-600/30">
            <p class="text-xs text-yellow-400 text-center">‚ö†Ô∏è Modo Offline - Dados n√£o sincronizados</p>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-4 custom-scrollbar">
            <div class="px-3 mb-2">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Menu Principal</p>
            </div>
            <div onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üìä</span> Dashboard
            </div>
            
            <div class="px-3 mt-4 mb-2">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Cadastros</p>
            </div>
            <div onclick="switchTab('fornecedores')" id="nav-fornecedores" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üè¢</span> Fornecedores
            </div>
            <div onclick="switchTab('ingredientes')" id="nav-ingredientes" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üì¶</span> Ingredientes
            </div>
            <div onclick="switchTab('preparacoes')" id="nav-preparacoes" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üç¥</span> Prepara√ß√µes
            </div>
            <div onclick="switchTab('pizzas')" id="nav-pizzas" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üçï</span> Pizzas
            </div>
            <div onclick="switchTab('combos')" id="nav-combos" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üéÅ</span> Combos
            </div>
            
            <div class="px-3 mt-4 mb-2">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Configura√ß√µes</p>
            </div>
            <div onclick="switchTab('plataformas')" id="nav-plataformas" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üì±</span> Plataformas
            </div>
            <div onclick="switchTab('custos')" id="nav-custos" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üíº</span> Custos Operacionais
            </div>
            
            <div class="px-3 mt-4 mb-2">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Relat√≥rios</p>
            </div>
            <div onclick="switchTab('gerencial')" id="nav-gerencial" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üìà</span> √Årea Gerencial
            </div>
            <div onclick="switchTab('analise')" id="nav-analise" class="nav-item flex items-center px-4 py-3 mx-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-gray-300">
                <span class="mr-3">üìä</span> An√°lise de Produtos
            </div>
        </nav>

        <!-- Sync & Export/Import Buttons -->
        <div class="p-3 border-t border-gray-700 space-y-2">
            <!-- Sync Status (only when logged in) -->
            <div id="syncSection" class="hidden">
                <div class="flex items-center justify-between text-xs text-gray-400 mb-2">
                    <span>√öltima sincroniza√ß√£o:</span>
                    <span id="lastSyncTime">--</span>
                </div>
                <button onclick="DriveSync.syncNow()" id="syncNowBtn" class="w-full px-3 py-2 bg-blue-600 text-white text-sm rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2 mb-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <span>Sincronizar Agora</span>
                </button>
            </div>
            <!-- Export/Import -->
            <div class="flex space-x-2">
                <button onclick="exportProject()" class="flex-1 px-3 py-2 bg-green-600 text-white text-sm rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center space-x-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span>Exportar</span>
                </button>
                <button onclick="triggerImport()" class="flex-1 px-3 py-2 bg-orange-500 text-white text-sm rounded-lg font-medium hover:bg-orange-600 transition-colors flex items-center justify-center space-x-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>Importar</span>
                </button>
            </div>
            <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="importProject(event)">
            <!-- Restore Backup Button -->
            <button id="restoreBackupBtn" onclick="DriveSync.showRestoreBackupModal()" class="hidden w-full px-3 py-2 bg-gray-600 text-white text-sm rounded-lg font-medium hover:bg-gray-500 transition-colors flex items-center justify-center space-x-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                <span>Restaurar Backup</span>
            </button>
        </div>
    </aside>

    <!-- Sync Notification Bar -->
    <div id="syncNotificationBar" class="hidden fixed top-0 left-60 right-0 bg-blue-600 text-white py-2 px-4 z-40 flex items-center justify-center space-x-2">
        <div class="spinner border-white border-t-transparent"></div>
        <span id="syncNotificationText">Sincronizando com Google Drive...</span>
    </div>

    <!-- Main Content -->
    <main class="ml-60 p-8">

        <!-- Dashboard Tab -->
        <div id="content-dashboard" class="tab-content">
            

            <!-- Vis√£o Geral - Cards de Totais -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-50 bg-white rounded-xl shadow-lg p-6 border border-gray-300 border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">Fornecedores</p>
                            <p id="dash-suppliers-count" class="text-3xl font-bold text-gray-800 text-gray-600">0</p>
                        </div>
                        <div class="w-12 h-12 bg-gray-100 bg-gray-50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üè¢</span>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 bg-white rounded-xl shadow-lg p-6 border border-blue-200 dark:border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">Ingredientes</p>
                            <p id="dash-ingredients-count" class="text-3xl font-bold text-blue-600 dark:text-blue-400">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üì¶</span>
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 bg-white rounded-xl shadow-lg p-6 border border-green-200 dark:border-green-900">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">Prepara√ß√µes</p>
                            <p id="dash-preparations-count" class="text-3xl font-bold text-green-600 dark:text-green-400">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 dark:bg-green-900/50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üç¥</span>
                        </div>
                    </div>
                </div>

                <div class="bg-orange-50 bg-white rounded-xl shadow-lg p-6 border border-orange-200 dark:border-orange-900">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">Pizzas</p>
                            <p id="dash-pizzas-count" class="text-3xl font-bold text-orange-600 dark:text-orange-400">0</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üçï</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- An√°lise Financeira -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üí∞ An√°lise Financeira</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="dash-financial-analysis"></div>
            </div>

            <!-- Configura√ß√µes de Alertas -->
            <div class="bg-indigo-50 bg-white rounded-xl shadow-lg p-6 mb-6 border border-indigo-200 dark:border-indigo-900">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 text-gray-900 mb-1">‚öôÔ∏è Configura√ß√µes de Monitoramento</h3>
                        <p class="text-sm text-gray-600 text-gray-500 mb-3">Defina os par√¢metros para alertas do sistema</p>
                        <div class="flex items-center space-x-3 bg-white bg-white rounded-lg p-3 border border-indigo-200 dark:border-indigo-800">
                            <label class="text-sm font-medium text-gray-700 text-gray-600 whitespace-nowrap">Margem m√≠nima de lucro aceit√°vel:</label>
                            <input type="number" id="minProfitMargin" value="40" min="0" max="100" step="5" class="w-24 px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-gray-50 text-gray-900 font-semibold" onchange="renderDashboard()">
                            <span class="text-base font-medium text-gray-700 text-gray-600">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas e Avisos -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">‚ö†Ô∏è Status do Sistema</h3>
                <div id="dash-alerts" class="space-y-3"></div>
            </div>

            <!-- Informa√ß√µes Adicionais -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Distribui√ß√£o de Pizzas -->
                <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üìä Distribui√ß√£o de Pizzas</h3>
                    <div id="dash-pizza-distribution"></div>
                </div>

                <!-- Pr√≥ximos Pedidos -->
                <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üìÖ Pr√≥ximos Pedidos</h3>
                    <div id="dash-next-orders"></div>
                </div>
            </div>
        </div>

        <!-- Fornecedores Tab -->
        <div id="content-fornecedores" class="tab-content">
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome do Fornecedor *</label>
                        <input type="text" id="supplierName" placeholder="Ex: Distribuidora ABC" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">CNPJ</label>
                        <input type="text" id="supplierCNPJ" placeholder="00.000.000/0000-00" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Telefone</label>
                        <input type="text" id="supplierPhone" placeholder="(00) 0000-0000" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Email</label>
                        <input type="email" id="supplierEmail" placeholder="contato@fornecedor.com" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Pessoa de Contato</label>
                        <input type="text" id="supplierContact" placeholder="Nome do contato" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Endere√ßo</label>
                        <input type="text" id="supplierAddress" placeholder="Rua, n√∫mero" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Cidade</label>
                        <input type="text" id="supplierCity" placeholder="Cidade" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Estado</label>
                        <input type="text" id="supplierState" placeholder="UF" maxlength="2" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">CEP</label>
                        <input type="text" id="supplierCEP" placeholder="00000-000" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Dia do Pedido</label>
                        <select id="supplierOrderDay" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                            <option value="">Selecione...</option>
                            <option value="Segunda">Segunda-feira</option>
                            <option value="Ter√ßa">Ter√ßa-feira</option>
                            <option value="Quarta">Quarta-feira</option>
                            <option value="Quinta">Quinta-feira</option>
                            <option value="Sexta">Sexta-feira</option>
                            <option value="S√°bado">S√°bado</option>
                            <option value="Domingo">Domingo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Dia de Entrega</label>
                        <select id="supplierDeliveryDay" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                            <option value="">Selecione...</option>
                            <option value="Segunda">Segunda-feira</option>
                            <option value="Ter√ßa">Ter√ßa-feira</option>
                            <option value="Quarta">Quarta-feira</option>
                            <option value="Quinta">Quinta-feira</option>
                            <option value="Sexta">Sexta-feira</option>
                            <option value="S√°bado">S√°bado</option>
                            <option value="Domingo">Domingo</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Data do √öltimo Pedido</label>
                        <input type="date" id="supplierLastOrderDate" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Imagem do √öltimo Pedido</label>
                        <input type="file" id="supplierLastOrderImage" accept="image/*" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Observa√ß√µes</label>
                    <textarea id="supplierNotes" rows="3" placeholder="Informa√ß√µes adicionais sobre o fornecedor..." class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900 resize-vertical"></textarea>
                </div>

                <button onclick="addSupplier()" class="w-full md:w-auto px-6 py-3 bg-green-600 text-white text-base rounded-lg font-medium hover:bg-gray-50hover:bg-green-700 transition-colors">
                    + Adicionar Fornecedor
                </button>

                <!-- Lista de Fornecedores -->
                <div id="suppliersList" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- Ingredientes Tab -->
        <div id="content-ingredientes" class="tab-content">
            <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome do Ingrediente</label>
                        <input type="text" id="ingredientName" placeholder="Ex: Mussarela" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Custo (R$)</label>
                        <input type="number" id="ingredientCost" placeholder="0.00" step="0.01" min="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Unidade</label>
                        <select id="ingredientUnit" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                            <option>kg</option>
                            <option>g</option>
                            <option>L</option>
                            <option>ml</option>
                            <option>unidade</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Fornecedor</label>
                        <select id="ingredientSupplier" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                </div>

                <button onclick="addIngredient()" class="w-full md:w-auto px-6 py-3 bg-green-600 text-white text-base rounded-lg font-medium hover:bg-gray-50hover:bg-green-700 transition-colors">
                    + Adicionar Ingrediente
                </button>

                <!-- Lista de Ingredientes -->
                <div id="ingredientsList" class="mt-6 space-y-2"></div>
            </div>
        </div>

        <!-- Prepara√ß√µes Tab -->
        <div id="content-preparacoes" class="tab-content hidden">
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome da Prepara√ß√£o</label>
                        <input type="text" id="preparationName" placeholder="Ex: Massa de Pizza" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Rendimento (quantas unidades)</label>
                        <input type="number" id="preparationYield" placeholder="1" step="1" min="1" value="1" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 text-gray-900 mb-4">Ingredientes da Prepara√ß√£o</h3>
                    <div id="preparationIngredients" class="space-y-3"></div>
                    <button onclick="addPreparationIngredient()" class="mt-3 px-4 py-2 text-base border-2 border-dashed border-gray-300 border-gray-300 text-gray-600 text-gray-500 rounded-lg hover:border-primary hover:text-primary transition-colors w-full">
                        + Adicionar Ingrediente √† Prepara√ß√£o
                    </button>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Modo de Preparo (opcional)</label>
                    <textarea id="preparationInstructions" rows="4" placeholder="Ex: Misture todos os ingredientes, deixe descansar por 30 minutos, amasse at√© ficar homog√™neo..." class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900 resize-vertical"></textarea>
                </div>

                <button onclick="addPreparation()" class="w-full px-6 py-3 bg-green-600 text-white text-base rounded-lg font-medium hover:bg-green-700 transition-colors">
                    ‚úì Criar Prepara√ß√£o
                </button>
            </div>

            <!-- Lista de Prepara√ß√µes -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">Suas Prepara√ß√µes</h3>
                <div id="preparationsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- Pizzas Tab -->
        <div id="content-pizzas" class="tab-content hidden">
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome da Pizza</label>
                        <input type="text" id="pizzaName" placeholder="Ex: Margherita" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Tamanho</label>
                        <select id="pizzaSize" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                            <option>Pequena</option>
                            <option>M√©dia</option>
                            <option>Grande</option>
                            <option>Gigante</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Tipo</label>
                        <select id="pizzaType" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                            <option value="salgada">Salgada</option>
                            <option value="doce">Doce</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üì∏ Foto da Pizza (opcional)</label>
                    <input type="file" id="pizzaImage" accept="image/*" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 text-gray-900 mb-4">Componentes da Pizza</h3>

                    <!-- Prepara√ß√µes -->
                    <div class="mb-4">
                        <h4 class="text-md font-medium text-gray-700 text-gray-600 mb-3">Prepara√ß√µes</h4>
                        <div id="pizzaPreparations" class="space-y-3"></div>
                        <button onclick="addPizzaPreparation()" class="mt-3 px-4 py-2 text-base border-2 border-dashed border-blue-300 dark:border-blue-600 text-blue-600 dark:text-blue-400 rounded-lg hover:border-blue-500 hover:text-blue-700 transition-colors w-full">
                            + Adicionar Prepara√ß√£o
                        </button>
                    </div>

                    <!-- Ingredientes Diretos -->
                    <div>
                        <h4 class="text-md font-medium text-gray-700 text-gray-600 mb-3">Ingredientes Diretos</h4>
                        <div id="pizzaIngredients" class="space-y-3"></div>
                        <button onclick="addPizzaIngredient()" class="mt-3 px-4 py-2 text-base border-2 border-dashed border-gray-300 border-gray-300 text-gray-600 text-gray-500 rounded-lg hover:border-primary hover:text-primary transition-colors w-full">
                            + Adicionar Ingrediente
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Custo Adicional (R$)</label>
                        <input type="number" id="additionalCost" placeholder="G√°s, luz, embalagem..." step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Margem de Lucro (%)</label>
                        <input type="number" id="profitMargin" placeholder="60" step="1" min="0" value="60" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Desperd√≠cio (%)</label>
                        <input type="number" id="wastePercentage" placeholder="10" step="1" min="0" value="10" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                </div>

                <button onclick="addPizza()" class="w-full px-6 py-3 bg-green-600 text-white text-base rounded-lg font-medium hover:bg-green-700 transition-colors">
                    ‚úì Criar Pizza
                </button>
            </div>

            <!-- Lista de Pizzas -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 text-gray-900">üìä Suas Pizzas</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto">
                        <button onclick="printTechnicalSheets()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2 text-sm font-medium whitespace-nowrap">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                            </svg>
                            <span>Imprimir Fichas</span>
                        </button>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <label class="text-sm font-medium text-gray-700 text-gray-600 whitespace-nowrap">Ordenar por:</label>
                            <select id="pizzaSortSelect" onchange="changePizzaSort()" class="px-3 py-2 text-sm border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900 w-full sm:w-auto">
                                <option value="name-asc">Nome (A-Z)</option>
                                <option value="name-desc">Nome (Z-A)</option>
                                <option value="price-asc">Pre√ßo (Menor)</option>
                                <option value="price-desc">Pre√ßo (Maior)</option>
                                <option value="profit-asc">Lucro (Menor)</option>
                                <option value="profit-desc">Lucro (Maior)</option>
                            </select>
                        </div>
                        <div class="text-sm text-gray-500 text-gray-500 whitespace-nowrap">
                            Total: <span id="totalPizzas" class="font-semibold text-primary">0</span> pizzas
                        </div>
                    </div>
                </div>

                <div id="pizzasList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

                <div id="emptyState" class="text-center py-12">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 bg-gray-50 rounded-full flex items-center justify-center">
                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 text-gray-900 mb-2">Nenhuma pizza cadastrada</h3>
                    <p class="text-gray-500 text-gray-500 mb-4">Comece adicionando ingredientes, prepara√ß√µes e criando sua primeira pizza!</p>
                </div>
            </div>
        </div>

        <!-- Plataformas Tab -->
        <div id="content-plataformas" class="tab-content hidden">
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome da Plataforma *</label>
                        <input type="text" id="platformName" placeholder="Ex: iFood, Uber Eats" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Taxa Padr√£o (%)</label>
                        <input type="number" id="platformDefaultTax" placeholder="Ex: 27" step="0.01" min="0" max="100" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Modo de Taxa</label>
                        <select id="platformTaxMode" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                            <option value="unique">Taxa √önica (para todas as pizzas)</option>
                            <option value="variable">Taxa Vari√°vel (por pizza/categoria)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Cor da Plataforma</label>
                    <select id="platformColor" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option value="red">üî¥ Vermelho (iFood)</option>
                        <option value="green">üü¢ Verde (Uber Eats)</option>
                        <option value="yellow">üü° Amarelo (Rappi)</option>
                        <option value="blue">üîµ Azul</option>
                        <option value="purple">üü£ Roxo</option>
                        <option value="orange">üü† Laranja</option>
                        <option value="pink">ü©∑ Rosa</option>
                        <option value="gray">‚ö´ Cinza</option>
                    </select>
                </div>

                <button onclick="addPlatform()" class="w-full bg-green-600 text-white px-6 py-3 text-base rounded-lg font-medium hover:bg-green-700 transition-colors">
                    ‚ûï Adicionar Plataforma
                </button>
            </div>

            <!-- Lista de Plataformas -->
            <div id="platformsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <!-- Empty State -->
            <div id="emptyPlatformsState" class="bg-white bg-white rounded-xl shadow-lg p-12 text-center">
                <div class="flex justify-center mb-4">
                    <svg class="w-24 h-24 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 text-gray-900 mb-2">Nenhuma plataforma cadastrada</h3>
                <p class="text-gray-500 text-gray-500 mb-4">Comece adicionando suas plataformas de delivery!</p>
            </div>
        </div>

        <!-- Custos Operacionais Tab -->
        <div id="content-custos" class="tab-content hidden">
            

            <!-- M√©todo de Rateio -->
            <div class="bg-indigo-50 bg-white rounded-xl shadow-lg p-6 mb-6 border border-indigo-200 dark:border-indigo-900">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">‚öôÔ∏è M√©todo de Rateio</h3>
                <p class="text-sm text-gray-600 text-gray-500 mb-4">Escolha como os custos operacionais ser√£o distribu√≠dos nas pizzas</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="relative flex items-start p-4 bg-white bg-gray-50 rounded-lg border-2 border-gray-200 border-gray-300 cursor-pointer hover:border-indigo-500 dark:hover:border-indigo-400 transition-colors">
                        <input type="radio" name="costMethod" value="fixed" id="costMethodFixed" class="mt-1 mr-3" onchange="updateCostMethod()">
                        <div>
                            <div class="font-semibold text-gray-900 text-gray-900 mb-1">üí∞ Custo Fixo por Pizza</div>
                            <div class="text-sm text-gray-600 text-gray-500">Divide o custo total mensal pelo n√∫mero estimado de pizzas produzidas</div>
                            <div class="mt-2 text-xs font-medium text-indigo-600 dark:text-indigo-400">Exemplo: R$ 10.000 √∑ 500 pizzas = R$ 20,00/pizza</div>
                        </div>
                    </label>

                    <label class="relative flex items-start p-4 bg-white bg-gray-50 rounded-lg border-2 border-gray-200 border-gray-300 cursor-pointer hover:border-indigo-500 dark:hover:border-indigo-400 transition-colors">
                        <input type="radio" name="costMethod" value="percentage" id="costMethodPercentage" class="mt-1 mr-3" onchange="updateCostMethod()">
                        <div>
                            <div class="font-semibold text-gray-900 text-gray-900 mb-1">üìä Percentual sobre CMV</div>
                            <div class="text-sm text-gray-600 text-gray-500">Aplica um percentual sobre o custo de produ√ß√£o de cada pizza</div>
                            <div class="mt-2 text-xs font-medium text-indigo-600 dark:text-indigo-400">Exemplo: CMV R$ 10,00 √ó 30% = R$ 3,00/pizza</div>
                        </div>
                    </label>
                </div>

                <!-- Configura√ß√£o do M√©todo Fixo -->
                <div id="fixedMethodConfig" class="mt-4 p-4 bg-blue-50 dark:bg-gray-100 rounded-lg border border-blue-200 dark:border-blue-200 hidden">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Produ√ß√£o Mensal Estimada (quantidade de pizzas)</label>
                    <input type="number" id="estimatedMonthlyProduction" placeholder="Ex: 500" min="1" step="1" value="500" class="w-full md:w-64 px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                </div>

                <!-- Configura√ß√£o do M√©todo Percentual -->
                <div id="percentageMethodConfig" class="mt-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800 hidden">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Percentual sobre o CMV (%)</label>
                    <input type="number" id="operationalCostPercentage" placeholder="Ex: 30" min="0" max="100" step="0.1" value="30" class="w-full md:w-64 px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                </div>
            </div>

            <!-- Cadastro de Custos -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-6">üìã Custos Mensais</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üè¢ Aluguel (R$)</label>
                        <input type="number" id="costRent" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">‚ö° Energia El√©trica (R$)</label>
                        <input type="number" id="costElectricity" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üíß √Ågua (R$)</label>
                        <input type="number" id="costWater" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üî• G√°s (R$)</label>
                        <input type="number" id="costGas" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üë• Sal√°rios e Encargos (R$)</label>
                        <input type="number" id="costSalaries" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üì± Internet/Telefone (R$)</label>
                        <input type="number" id="costInternet" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üßπ Limpeza e Manuten√ß√£o (R$)</label>
                        <input type="number" id="costCleaning" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üì¢ Marketing (R$)</label>
                        <input type="number" id="costMarketing" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üí≥ Taxas Banc√°rias (R$)</label>
                        <input type="number" id="costBankFees" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üìÑ Impostos Fixos (R$)</label>
                        <input type="number" id="costTaxes" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üõ†Ô∏è Outros Custos (R$)</label>
                        <input type="number" id="costOthers" placeholder="0.00" step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900" onchange="calculateOperationalCosts()">
                    </div>
                </div>
            </div>

            <!-- Resumo dos Custos -->
            <div class="bg-gray-50 bg-white rounded-xl shadow-lg p-6 border border-gray-300 border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-6">üìä Resumo dos Custos Operacionais</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üí∞ Custo Total Mensal</p>
                        <p id="totalMonthlyCost" class="text-2xl font-bold text-gray-800 text-gray-600">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üçï Custo por Pizza</p>
                        <p id="costPerPizza" class="text-2xl font-bold text-blue-600 dark:text-blue-400">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üìà M√©todo Atual</p>
                        <p id="currentMethod" class="text-lg font-bold text-gray-700 text-gray-600">Nenhum</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üéØ Status</p>
                        <p id="costStatus" class="text-lg font-bold text-green-600 dark:text-green-400">Configurado</p>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-sm text-gray-700 text-gray-600">
                            <strong>Importante:</strong> Os custos operacionais ser√£o automaticamente inclu√≠dos no c√°lculo de todas as pizzas.
                            Voc√™ pode alternar entre os m√©todos de rateio a qualquer momento.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- √Årea Gerencial Tab -->
        <div id="content-gerencial" class="tab-content hidden">
            

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="gerencial-kpi-cards">
                <div class="bg-green-50 bg-white rounded-xl shadow-lg p-6 border border-green-200 dark:border-green-900">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üí∞ Faturamento Total</p>
                            <p id="kpi-total-revenue" class="text-2xl font-bold text-green-600 dark:text-green-400">R$ 0,00</p>
                            <p id="kpi-revenue-trend" class="text-xs text-gray-500 text-gray-500 mt-1"></p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 dark:bg-green-900/50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üíµ</span>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 bg-white rounded-xl shadow-lg p-6 border border-blue-200 dark:border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üì¶ Total de Pedidos</p>
                            <p id="kpi-total-orders" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</p>
                            <p id="kpi-orders-trend" class="text-xs text-gray-500 text-gray-500 mt-1"></p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üìã</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 bg-white rounded-xl shadow-lg p-6 border border-gray-300 border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üéØ M√©dia Atingimento</p>
                            <p id="kpi-avg-goal" class="text-2xl font-bold text-gray-800 text-gray-600">0%</p>
                            <p id="kpi-goal-trend" class="text-xs text-gray-500 text-gray-500 mt-1"></p>
                        </div>
                        <div class="w-12 h-12 bg-gray-100 bg-gray-50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üéØ</span>
                        </div>
                    </div>
                </div>

                <div class="bg-orange-50 bg-white rounded-xl shadow-lg p-6 border border-orange-200 dark:border-orange-900">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üßæ Ticket M√©dio</p>
                            <p id="kpi-avg-ticket" class="text-2xl font-bold text-orange-600 dark:text-orange-400">R$ 0,00</p>
                            <p id="kpi-ticket-trend" class="text-xs text-gray-500 text-gray-500 mt-1"></p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üßæ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formul√°rio de Cadastro de Vendas -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">‚ûï Registrar Vendas do M√™s</h3>

                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">M√™s *</label>
                        <select id="salesMonth" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Mar√ßo</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Ano *</label>
                        <input type="number" id="salesYear" placeholder="2025" min="2020" max="2100" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Pedidos *</label>
                        <input type="number" id="salesOrders" placeholder="Ex: 150" min="0" step="1" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Meta de Pedidos</label>
                        <input type="number" id="salesGoal" placeholder="Ex: 200" min="0" step="1" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Faturamento (R$) *</label>
                        <input type="number" id="salesRevenue" placeholder="Ex: 15000" min="0" step="0.01" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Pizzas Vendidas *</label>
                        <input type="number" id="salesPizzas" placeholder="Ex: 300" min="0" step="1" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üìù Observa√ß√µes (opcional)</label>
                    <textarea id="salesNotes" rows="2" placeholder="Ex: Promo√ß√£o de anivers√°rio, reforma da loja, etc." class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900 resize-vertical"></textarea>
                </div>

                <button onclick="addSalesRecord()" class="w-full md:w-auto px-6 py-3 bg-green-600 text-white text-base rounded-lg font-medium hover:bg-gray-50hover:bg-green-700 transition-colors">
                    ‚ûï Adicionar Registro
                </button>
            </div>

            <!-- Filtros -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <h3 class="text-xl font-bold text-gray-900 text-gray-900">üîç Filtros</h3>
                    <div class="flex flex-wrap items-center gap-3">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700 text-gray-600">Ano:</label>
                            <select id="filterYear" onchange="renderManagementData()" class="px-3 py-2 text-sm border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700 text-gray-600">Per√≠odo:</label>
                            <select id="filterPeriod" onchange="renderManagementData()" class="px-3 py-2 text-sm border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                                <option value="all">Todo o per√≠odo</option>
                                <option value="last3">√öltimos 3 meses</option>
                                <option value="last6">√öltimos 6 meses</option>
                                <option value="last12">√öltimos 12 meses</option>
                                <option value="q1">1¬∫ Trimestre</option>
                                <option value="q2">2¬∫ Trimestre</option>
                                <option value="q3">3¬∫ Trimestre</option>
                                <option value="q4">4¬∫ Trimestre</option>
                            </select>
                        </div>
                        <button onclick="printManagementReport()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2 text-sm font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                            </svg>
                            <span>Imprimir Relat√≥rio</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- An√°lise de Rentabilidade -->
            <div class="bg-emerald-50 bg-white rounded-xl shadow-lg p-6 mb-6 border border-emerald-200 dark:border-emerald-900">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üíπ An√°lise de Rentabilidade Te√≥rica</h3>
                <p class="text-sm text-gray-600 text-gray-500 mb-4">Compara√ß√£o entre faturamento real e custo te√≥rico baseado nas pizzas cadastradas</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="profitability-analysis">
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üí∞ Faturamento Total</p>
                        <p id="profit-total-revenue" class="text-xl font-bold text-green-600 dark:text-green-400">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üìä CMV Te√≥rico Estimado</p>
                        <p id="profit-cmv-estimate" class="text-xl font-bold text-red-600 dark:text-red-400">R$ 0,00</p>
                        <p class="text-xs text-gray-500 text-gray-500">Baseado no custo m√©dio das pizzas</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üìà Lucro Bruto Estimado</p>
                        <p id="profit-gross-profit" class="text-xl font-bold text-blue-600 dark:text-blue-400">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üìâ Margem Bruta</p>
                        <p id="profit-margin" class="text-xl font-bold text-gray-800 text-gray-600">0%</p>
                    </div>
                </div>
            </div>

            <!-- Destaques de Performance -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-green-50 bg-white rounded-xl shadow-lg p-6 border border-green-200 dark:border-green-900">
                    <h3 class="text-lg font-bold text-gray-900 text-gray-900 mb-4">üèÜ Melhor M√™s</h3>
                    <div id="best-month-info" class="text-gray-600 text-gray-500">
                        <p class="text-sm">Nenhum dado dispon√≠vel</p>
                    </div>
                </div>
                <div class="bg-red-50 bg-white rounded-xl shadow-lg p-6 border border-red-200 dark:border-red-900">
                    <h3 class="text-lg font-bold text-gray-900 text-gray-900 mb-4">üìâ Pior M√™s</h3>
                    <div id="worst-month-info" class="text-gray-600 text-gray-500">
                        <p class="text-sm">Nenhum dado dispon√≠vel</p>
                    </div>
                </div>
            </div>

            <!-- Tabela de Performance -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6 overflow-x-auto">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üìä Tabela de Performance</h3>
                <table class="w-full min-w-[800px]">
                    <thead>
                        <tr class="border-b border-gray-200 border-gray-200">
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 text-gray-600">M√™s/Ano</th>
                            <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Pedidos</th>
                            <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Meta</th>
                            <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">√çndice %</th>
                            <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Faturamento</th>
                            <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Pizzas</th>
                            <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Ticket M√©dio</th>
                            <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Pizzas/Pedido</th>
                            <th class="py-3 px-4 text-center text-sm font-semibold text-gray-700 text-gray-600">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body">
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-500 text-gray-500">
                                Nenhum registro de vendas cadastrado
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Gr√°ficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Gr√°fico de Barras: Pedidos vs Meta vs Pizzas -->
                <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 text-gray-900 mb-4">üìä Pedidos vs Meta vs Pizzas</h3>
                    <div id="chart-orders-goal" class="h-64">
                        <div class="flex items-center justify-center h-full text-gray-500 text-gray-500">
                            <p>Adicione registros de vendas para ver o gr√°fico</p>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Linha: Faturamento vs Pedidos -->
                <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 text-gray-900 mb-4">üìà Evolu√ß√£o do Faturamento</h3>
                    <div id="chart-revenue" class="h-64">
                        <div class="flex items-center justify-center h-full text-gray-500 text-gray-500">
                            <p>Adicione registros de vendas para ver o gr√°fico</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Proje√ß√£o Anual -->
            <div class="bg-indigo-50 bg-white rounded-xl shadow-lg p-6 border border-indigo-200 dark:border-indigo-900">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üîÆ Proje√ß√£o Anual</h3>
                <p class="text-sm text-gray-600 text-gray-500 mb-4">Baseada na m√©dia dos meses registrados no ano corrente</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="annual-projection">
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üìÖ Meses Registrados</p>
                        <p id="projection-months" class="text-xl font-bold text-indigo-600 dark:text-indigo-400">0</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üí∞ Faturamento Projetado (Anual)</p>
                        <p id="projection-revenue" class="text-xl font-bold text-green-600 dark:text-green-400">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üì¶ Pedidos Projetados (Anual)</p>
                        <p id="projection-orders" class="text-xl font-bold text-blue-600 dark:text-blue-400">0</p>
                    </div>
                    <div class="p-4 bg-white bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üçï Pizzas Projetadas (Anual)</p>
                        <p id="projection-pizzas" class="text-xl font-bold text-orange-600 dark:text-orange-400">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combos Tab -->
        <div id="content-combos" class="tab-content hidden">
            

            <!-- Formul√°rio de Combo -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">‚ûï Criar Novo Combo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome do Combo *</label>
                        <input type="text" id="comboName" placeholder="Ex: Combo Fam√≠lia" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Pre√ßo Promocional (R$) *</label>
                        <input type="number" id="comboPrice" placeholder="Ex: 89.90" step="0.01" min="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üçï Pizzas do Combo</label>
                    <div id="comboPizzasList" class="space-y-2 mb-2"></div>
                    <button onclick="addComboPizza()" class="px-4 py-2 text-base border-2 border-dashed border-gray-300 border-gray-300 text-gray-600 text-gray-500 rounded-lg hover:border-primary hover:text-primary transition-colors w-full">
                        + Adicionar Pizza ao Combo
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">ü•§ Itens Extras (Bebidas, etc.)</label>
                    <div id="comboExtrasList" class="space-y-2 mb-2"></div>
                    <button onclick="addComboExtra()" class="px-4 py-2 text-base border-2 border-dashed border-gray-300 border-gray-300 text-gray-600 text-gray-500 rounded-lg hover:border-primary hover:text-primary transition-colors w-full">
                        + Adicionar Item Extra
                    </button>
                </div>

                <!-- Preview do Combo -->
                <div id="comboPreview" class="bg-gray-50 bg-white rounded-lg p-4 mb-4 border border-gray-300 border-gray-200 hidden">
                    <h4 class="font-bold text-gray-900 text-gray-900 mb-2">üìä Pr√©via do Combo</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600 text-gray-500">Custo Total</p>
                            <p id="comboCostPreview" class="font-bold text-red-600">R$ 0,00</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-gray-500">Pre√ßo Normal</p>
                            <p id="comboNormalPrice" class="font-bold text-gray-600">R$ 0,00</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-gray-500">Desconto</p>
                            <p id="comboDiscount" class="font-bold text-orange-600">0%</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-gray-500">Lucro</p>
                            <p id="comboProfitPreview" class="font-bold text-green-600">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <button onclick="addCombo()" class="w-full md:w-auto px-6 py-3 bg-green-600 text-white text-base rounded-lg font-medium hover:bg-gray-50hover:bg-green-700 transition-colors">
                    ‚úî Criar Combo
                </button>
            </div>

            <!-- Lista de Combos -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üìù Seus Combos</h3>
                <div id="combosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-500 text-gray-500 col-span-full text-center py-8">Nenhum combo cadastrado ainda</p>
                </div>
            </div>
        </div>

        <!-- An√°lise de Produtos Tab -->
        <div id="content-analise" class="tab-content hidden">
            

            <!-- KPIs de An√°lise -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-green-50 bg-white rounded-xl shadow-lg p-6 border border-green-200 dark:border-green-900">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üèÜ Ponto de Equil√≠brio</p>
                            <p id="kpi-breakeven" class="text-2xl font-bold text-green-600 dark:text-green-400">R$ 0,00</p>
                            <p class="text-xs text-gray-500 text-gray-500 mt-1">Faturamento m√≠nimo mensal</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 dark:bg-green-900/50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">‚öñÔ∏è</span>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 bg-white rounded-xl shadow-lg p-6 border border-blue-200 dark:border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üçï Pizzas p/ Equil√≠brio</p>
                            <p id="kpi-breakeven-pizzas" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</p>
                            <p class="text-xs text-gray-500 text-gray-500 mt-1">Quantidade m√≠nima mensal</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üìä</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 bg-white rounded-xl shadow-lg p-6 border border-gray-300 border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üí∞ Margem M√©dia</p>
                            <p id="kpi-avg-margin" class="text-2xl font-bold text-gray-800 text-gray-600">0%</p>
                            <p class="text-xs text-gray-500 text-gray-500 mt-1">Margem de contribui√ß√£o</p>
                        </div>
                        <div class="w-12 h-12 bg-gray-100 bg-gray-50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üìà</span>
                        </div>
                    </div>
                </div>

                <div class="bg-orange-50 bg-white rounded-xl shadow-lg p-6 border border-orange-200 dark:border-orange-900">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üéØ Produtos Classe A</p>
                            <p id="kpi-class-a" class="text-2xl font-bold text-orange-600 dark:text-orange-400">0</p>
                            <p class="text-xs text-gray-500 text-gray-500 mt-1">Top performers</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/50 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">‚≠ê</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Curva ABC -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900 text-gray-900">üìâ Curva ABC de Produtos</h3>
                    <button onclick="exportAnalysisCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2 text-sm font-medium">
                        <span>üì• Exportar CSV</span>
                    </button>
                </div>
                <p class="text-sm text-gray-600 text-gray-500 mb-4">Classifica√ß√£o dos produtos por contribui√ß√£o no faturamento potencial</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200 border-gray-200">
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 text-gray-600">Classe</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 text-gray-600">Pizza</th>
                                <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Pre√ßo Venda</th>
                                <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Lucro Unit.</th>
                                <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Margem %</th>
                                <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">% Acumulado</th>
                            </tr>
                        </thead>
                        <tbody id="curvaAbcTable">
                            <tr><td colspan="6" class="py-8 text-center text-gray-500 text-gray-500">Cadastre pizzas para ver a an√°lise</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lista de Compras -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üõí Gerador de Lista de Compras</h3>
                <p class="text-sm text-gray-600 text-gray-500 mb-4">Informe a previs√£o de vendas para gerar uma lista de compras de ingredientes</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Previs√£o de Vendas por Pizza</label>
                    <div id="salesForecastList" class="space-y-2 mb-4"></div>
                </div>

                <div class="flex gap-2 mb-4">
                    <button onclick="generateShoppingList()" class="px-6 py-3 bg-green-600 text-white text-base rounded-lg font-medium hover:bg-gray-50hover:bg-green-700 transition-colors">
                        üìù Gerar Lista de Compras
                    </button>
                    <button onclick="exportShoppingListCSV()" class="px-6 py-3 bg-green-600 text-white text-base rounded-lg font-medium hover:bg-green-700 transition-colors">
                        üì• Exportar CSV
                    </button>
                </div>

                <div id="shoppingListResult" class="hidden">
                    <h4 class="font-bold text-gray-900 text-gray-900 mb-2">üìã Lista de Compras Gerada</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200 border-gray-200">
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 text-gray-600">Ingrediente</th>
                                    <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Quantidade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 text-gray-600">Unidade</th>
                                    <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700 text-gray-600">Custo Estimado</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 text-gray-600">Fornecedor</th>
                                </tr>
                            </thead>
                            <tbody id="shoppingListTable"></tbody>
                            <tfoot>
                                <tr class="border-t-2 border-gray-300 border-gray-300 font-bold">
                                    <td colspan="3" class="py-3 px-4 text-right">Total Estimado:</td>
                                    <td id="shoppingListTotal" class="py-3 px-4 text-right text-green-600">R$ 0,00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Hist√≥rico de Pre√ßos -->
            <div class="bg-white bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 text-gray-900 mb-4">üìà Hist√≥rico de Pre√ßos de Ingredientes</h3>
                <p class="text-sm text-gray-600 text-gray-500 mb-4">Acompanhe a varia√ß√£o de pre√ßos dos seus ingredientes ao longo do tempo. Clique em um ingrediente para ver o hist√≥rico detalhado.</p>
                
                <div id="priceHistoryList" class="space-y-2">
                    <p class="text-center py-8 text-gray-500 text-gray-500">Nenhum ingrediente com hist√≥rico de pre√ßos</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal de Restaurar Backup -->
    <div id="restoreBackupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 slide-in">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üîÑ Restaurar Backup</h3>
            <p class="text-gray-500 mb-4">Selecione um backup para restaurar:</p>
            <div id="backupList" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                <p class="text-gray-400 text-center py-4">Carregando backups...</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="DriveSync.hideRestoreBackupModal()" class="px-4 py-2 text-base text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white bg-white rounded-xl shadow-xl max-w-md w-full p-6 slide-in">
            <h3 class="text-lg font-semibold text-gray-900 text-gray-900 mb-3" id="confirmTitle">Confirmar a√ß√£o</h3>
            <p class="text-gray-600 text-gray-500 mb-6" id="confirmMessage"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideConfirmModal()" class="px-4 py-2 text-base text-gray-600 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-50 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button id="confirmButton" class="px-4 py-2 text-base bg-red-500 text-gray-900 hover:bg-red-600 rounded-lg transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta -->
    <div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white bg-white rounded-xl shadow-xl max-w-md w-full p-6 slide-in">
            <h3 class="text-lg font-semibold text-gray-900 text-gray-900 mb-3" id="alertTitle">Aten√ß√£o</h3>
            <p class="text-gray-600 text-gray-500 mb-6" id="alertMessage"></p>
            <div class="flex justify-end">
                <button onclick="hideAlertModal()" class="px-4 py-2 text-base bg-green-600 text-white hover:bg-gray-50hover:bg-green-700 rounded-lg transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Ingrediente -->
    <div id="editIngredientModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white bg-white rounded-xl shadow-xl max-w-lg w-full p-6 slide-in custom-scrollbar" style="max-height: 90vh; overflow-y: auto;">
            <h3 class="text-xl font-semibold text-gray-900 text-gray-900 mb-6">‚úèÔ∏è Editar Ingrediente</h3>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome do Ingrediente</label>
                    <input type="text" id="editIngredientName" placeholder="Ex: Mussarela" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Custo (R$)</label>
                    <input type="number" id="editIngredientCost" placeholder="0.00" step="0.01" min="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Unidade</label>
                    <select id="editIngredientUnit" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option>kg</option>
                        <option>g</option>
                        <option>L</option>
                        <option>ml</option>
                        <option>unidade</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Fornecedor</label>
                    <select id="editIngredientSupplier" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option value="">Nenhum</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="hideEditIngredientModal()" class="px-4 py-2 text-base text-gray-600 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-50 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button onclick="saveEditIngredient()" class="px-4 py-2 text-base bg-green-600 text-white hover:bg-gray-50hover:bg-green-700 rounded-lg transition-colors">
                    ‚úì Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Prepara√ß√£o -->
    <div id="editPreparationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white bg-white rounded-xl shadow-xl max-w-2xl w-full p-6 slide-in custom-scrollbar" style="max-height: 90vh; overflow-y: auto;">
            <h3 class="text-xl font-semibold text-gray-900 text-gray-900 mb-6">‚úèÔ∏è Editar Prepara√ß√£o</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome da Prepara√ß√£o</label>
                    <input type="text" id="editPreparationName" placeholder="Ex: Massa de Pizza" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Rendimento (quantas unidades)</label>
                    <input type="number" id="editPreparationYield" placeholder="1" step="1" min="1" value="1" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
            </div>

            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-900 text-gray-900 mb-4">Ingredientes da Prepara√ß√£o</h4>
                <div id="editPreparationIngredients" class="space-y-3"></div>
                <button onclick="addEditPreparationIngredient()" class="mt-3 px-4 py-2 text-base border-2 border-dashed border-gray-300 border-gray-300 text-gray-600 text-gray-500 rounded-lg hover:border-primary hover:text-primary transition-colors w-full">
                    + Adicionar Ingrediente
                </button>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Modo de Preparo (opcional)</label>
                <textarea id="editPreparationInstructions" rows="4" placeholder="Ex: Misture todos os ingredientes, deixe descansar por 30 minutos, amasse at√© ficar homog√™neo..." class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900 resize-vertical"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="hideEditPreparationModal()" class="px-4 py-2 text-base text-gray-600 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-50 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button onclick="saveEditPreparation()" class="px-4 py-2 text-base bg-green-600 text-white hover:bg-gray-50hover:bg-green-700 rounded-lg transition-colors">
                    ‚úì Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Fornecedor -->
    <div id="editSupplierModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white bg-white rounded-xl shadow-xl max-w-4xl w-full p-6 slide-in custom-scrollbar" style="max-height: 90vh; overflow-y: auto;">
            <h3 class="text-xl font-semibold text-gray-900 text-gray-900 mb-6">‚úèÔ∏è Editar Fornecedor</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome do Fornecedor *</label>
                    <input type="text" id="editSupplierName" placeholder="Ex: Distribuidora ABC" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">CNPJ</label>
                    <input type="text" id="editSupplierCNPJ" placeholder="00.000.000/0000-00" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Telefone</label>
                    <input type="text" id="editSupplierPhone" placeholder="(00) 0000-0000" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Email</label>
                    <input type="email" id="editSupplierEmail" placeholder="contato@fornecedor.com" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Pessoa de Contato</label>
                    <input type="text" id="editSupplierContact" placeholder="Nome do contato" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Endere√ßo</label>
                    <input type="text" id="editSupplierAddress" placeholder="Rua, n√∫mero" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Cidade</label>
                    <input type="text" id="editSupplierCity" placeholder="Cidade" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Estado</label>
                    <input type="text" id="editSupplierState" placeholder="UF" maxlength="2" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">CEP</label>
                    <input type="text" id="editSupplierCEP" placeholder="00000-000" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Dia do Pedido</label>
                    <select id="editSupplierOrderDay" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option value="">Selecione...</option>
                        <option value="Segunda">Segunda-feira</option>
                        <option value="Ter√ßa">Ter√ßa-feira</option>
                        <option value="Quarta">Quarta-feira</option>
                        <option value="Quinta">Quinta-feira</option>
                        <option value="Sexta">Sexta-feira</option>
                        <option value="S√°bado">S√°bado</option>
                        <option value="Domingo">Domingo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Dia de Entrega</label>
                    <select id="editSupplierDeliveryDay" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option value="">Selecione...</option>
                        <option value="Segunda">Segunda-feira</option>
                        <option value="Ter√ßa">Ter√ßa-feira</option>
                        <option value="Quarta">Quarta-feira</option>
                        <option value="Quinta">Quinta-feira</option>
                        <option value="Sexta">Sexta-feira</option>
                        <option value="S√°bado">S√°bado</option>
                        <option value="Domingo">Domingo</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Data do √öltimo Pedido</label>
                    <input type="date" id="editSupplierLastOrderDate" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Atualizar Imagem do √öltimo Pedido</label>
                    <input type="file" id="editSupplierLastOrderImage" accept="image/*" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Observa√ß√µes</label>
                <textarea id="editSupplierNotes" rows="3" placeholder="Informa√ß√µes adicionais sobre o fornecedor..." class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900 resize-vertical"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="hideEditSupplierModal()" class="px-4 py-2 text-base text-gray-600 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-50 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button onclick="saveEditSupplier()" class="px-4 py-2 text-base bg-green-600 text-white hover:bg-gray-50hover:bg-green-700 rounded-lg transition-colors">
                    ‚úì Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Visualiza√ß√£o de Imagem -->
    <div id="imageViewModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4" onclick="hideImageViewModal()">
        <div class="relative max-w-6xl w-full max-h-screen" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-900">Imagem do √öltimo Pedido</h3>
                <div class="flex items-center space-x-3">
                    <button onclick="downloadCurrentImage()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span>Download</span>
                    </button>
                    <button onclick="hideImageViewModal()" class="text-gray-900 hover:text-gray-300 p-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-lg p-2 overflow-auto custom-scrollbar" style="max-height: 85vh;">
                <img id="imageViewContent" src="" alt="Imagem do pedido" class="w-full h-auto">
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Pizza -->
    <div id="editPizzaModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white bg-white rounded-xl shadow-xl max-w-3xl w-full p-6 slide-in custom-scrollbar" style="max-height: 90vh; overflow-y: auto;">
            <h3 class="text-xl font-semibold text-gray-900 text-gray-900 mb-6">‚úèÔ∏è Editar Pizza</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome da Pizza</label>
                    <input type="text" id="editPizzaName" placeholder="Ex: Margherita" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Tamanho</label>
                    <select id="editPizzaSize" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option>Pequena</option>
                        <option>M√©dia</option>
                        <option>Grande</option>
                        <option>Gigante</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Tipo</label>
                    <select id="editPizzaType" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option value="salgada">Salgada</option>
                        <option value="doce">Doce</option>
                    </select>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">üì∏ Atualizar Foto da Pizza (opcional)</label>
                <input type="file" id="editPizzaImage" accept="image/*" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
            </div>

            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-900 text-gray-900 mb-4">Componentes da Pizza</h4>

                <!-- Prepara√ß√µes -->
                <div class="mb-4">
                    <h5 class="text-md font-medium text-gray-700 text-gray-600 mb-3">Prepara√ß√µes</h5>
                    <div id="editPizzaPreparations" class="space-y-3"></div>
                    <button onclick="addEditPizzaPreparation()" class="mt-3 px-4 py-2 text-base border-2 border-dashed border-blue-300 dark:border-blue-600 text-blue-600 dark:text-blue-400 rounded-lg hover:border-blue-500 hover:text-blue-700 transition-colors w-full">
                        + Adicionar Prepara√ß√£o
                    </button>
                </div>

                <!-- Ingredientes Diretos -->
                <div>
                    <h5 class="text-md font-medium text-gray-700 text-gray-600 mb-3">Ingredientes Diretos</h5>
                    <div id="editPizzaIngredients" class="space-y-3"></div>
                    <button onclick="addEditPizzaIngredient()" class="mt-3 px-4 py-2 text-base border-2 border-dashed border-gray-300 border-gray-300 text-gray-600 text-gray-500 rounded-lg hover:border-primary hover:text-primary transition-colors w-full">
                        + Adicionar Ingrediente
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Custo Adicional (R$)</label>
                    <input type="number" id="editAdditionalCost" placeholder="G√°s, luz, embalagem..." step="0.01" min="0" value="0" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Margem de Lucro (%)</label>
                    <input type="number" id="editProfitMargin" placeholder="60" step="1" min="0" value="60" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Desperd√≠cio (%)</label>
                    <input type="number" id="editWastePercentage" placeholder="10" step="1" min="0" value="10" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="hideEditPizzaModal()" class="px-4 py-2 text-base text-gray-600 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-50 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button onclick="saveEditPizza()" class="px-4 py-2 text-base bg-green-600 text-white hover:bg-gray-50hover:bg-green-700 rounded-lg transition-colors">
                    ‚úì Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o de Taxas Vari√°veis -->
    <div id="variableTaxModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white bg-white rounded-xl shadow-xl max-w-3xl w-full p-6 slide-in custom-scrollbar" style="max-height: 90vh; overflow-y: auto;">
            <h3 class="text-xl font-semibold text-gray-900 text-gray-900 mb-4">üîÑ Configurar Taxas Vari√°veis</h3>
            <p class="text-sm text-gray-600 text-gray-500 mb-6">Configure taxas personalizadas para cada pizza. Deixe vazio para usar a taxa padr√£o.</p>

            <div id="variableTaxList" class="space-y-3"></div>

            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideVariableTaxModal()" class="px-4 py-2 text-base text-gray-600 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-50 rounded-lg transition-colors">
                    Fechar
                </button>
                <button onclick="saveVariableTaxes()" class="px-4 py-2 text-base bg-green-600 text-white hover:bg-gray-50hover:bg-green-700 rounded-lg transition-colors">
                    ‚úì Salvar Taxas
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Plataforma -->
    <div id="editPlatformModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white bg-white rounded-xl shadow-xl max-w-lg w-full p-6 slide-in">
            <h3 class="text-xl font-semibold text-gray-900 text-gray-900 mb-6">‚úèÔ∏è Editar Plataforma</h3>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Nome da Plataforma</label>
                    <input type="text" id="editPlatformName" placeholder="Ex: iFood" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Taxa Padr√£o (%)</label>
                    <input type="number" id="editPlatformDefaultTax" placeholder="Ex: 27" step="0.01" min="0" max="100" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Modo de Taxa</label>
                    <select id="editPlatformTaxMode" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option value="unique">Taxa √önica (para todas as pizzas)</option>
                        <option value="variable">Taxa Vari√°vel (por pizza/categoria)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-gray-600 mb-2">Cor da Plataforma</label>
                    <select id="editPlatformColor" class="w-full px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50 text-gray-900">
                        <option value="red">üî¥ Vermelho (iFood)</option>
                        <option value="green">üü¢ Verde (Uber Eats)</option>
                        <option value="yellow">üü° Amarelo (Rappi)</option>
                        <option value="blue">üîµ Azul</option>
                        <option value="purple">üü£ Roxo</option>
                        <option value="orange">üü† Laranja</option>
                        <option value="pink">ü©∑ Rosa</option>
                        <option value="gray">‚ö´ Cinza</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="hideEditPlatformModal()" class="px-4 py-2 text-base text-gray-600 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-50 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button onclick="saveEditPlatform()" class="px-4 py-2 text-base bg-green-600 text-white hover:bg-gray-50hover:bg-green-700 rounded-lg transition-colors">
                    ‚úì Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data storage
        let suppliers = [];
        let ingredients = [];
        let preparations = [];
        let pizzas = [];
        let platforms = [];
        let preparationIngredientsCount = 0;
        let pizzaPreparationsCount = 0;
        let pizzaIngredientsCount = 0;
        let editingIngredientId = null;
        let editingPreparationId = null;
        let editingPizzaId = null;
        let editingSupplierId = null;
        let editingPlatformId = null;
        let configuringTaxesPlatformId = null;
        let editPreparationIngredientsCount = 0;
        let editPizzaPreparationsCount = 0;
        let editPizzaIngredientsCount = 0;
        let pizzaSortCriteria = 'name-asc'; // default sort

        // Operational Costs data
        let operationalCosts = {
            method: null, // 'fixed' or 'percentage'
            estimatedMonthlyProduction: 500,
            percentage: 30,
            rent: 0,
            electricity: 0,
            water: 0,
            gas: 0,
            salaries: 0,
            internet: 0,
            cleaning: 0,
            marketing: 0,
            bankFees: 0,
            taxes: 0,
            others: 0
        };

        // Management Data (√Årea Gerencial)
        let managementData = [];
        let editingSalesRecordId = null;

        // Combos Data
        let combos = [];
        let comboPizzas = [];
        let comboExtras = [];
        let comboPizzaCount = 0;
        let comboExtraCount = 0;

        // Price History Data
        let priceHistory = {}; // { ingredientId: [{ date, oldPrice, newPrice }] }

        // ==============================================
        // GOOGLE DRIVE CONFIGURATION
        // ==============================================
        const CONFIG = {
            GOOGLE_CLIENT_ID: '79964786212-cop9djj048lrpsnvqk4vvcd8ncfeafd5.apps.googleusercontent.com',
            GOOGLE_API_KEY: 'AIzaSyDlCUGIbfvvQQuQIyy7EoYgpdX-FeHXKKM',
            PIZZARIA_NAME: 'APS',
            DRIVE_FOLDER_NAME: 'APS_Precificacao',
            AUTO_SYNC_INTERVAL: 5,
            MAX_BACKUPS: 5,
            DATA_VERSION: '2.0'
        };

        // Google Auth State
        let isLoggedIn = false;
        let isOfflineMode = false;
        let currentUser = null;
        let lastSyncTime = null;
        let autoSyncInterval = null;

        // ==============================================
        // GOOGLE AUTHENTICATION MODULE
        // ==============================================
        const GoogleAuth = {
            tokenClient: null,
            accessToken: null,

            init() {
                // Always show login overlay - no session persistence in iframe
                document.getElementById('loginOverlay').classList.remove('hidden');
            },

            signIn() {
                document.getElementById('loginContent').classList.add('hidden');
                document.getElementById('loginLoading').classList.remove('hidden');
                document.getElementById('loginError').classList.add('hidden');
                try {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CONFIG.GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
                        callback: (response) => {
                            if (response.error) { this.onSignInError(response.error); return; }
                            this.accessToken = response.access_token;
                            // Token stored in memory only (no localStorage in iframe)
                            this.getUserInfo();
                        }
                    });
                    this.tokenClient.requestAccessToken();
                } catch (error) { this.onSignInError(error.message); }
            },

            async getUserInfo() {
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    if (!response.ok) throw new Error('Failed to get user info');
                    currentUser = await response.json();
                    // User stored in memory only (no localStorage in iframe)
                    this.onSignInSuccess();
                } catch (error) { this.onSignInError(error.message); }
            },

            onSignInSuccess() {
                isLoggedIn = true;
                isOfflineMode = false;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('userInfoSection').classList.remove('hidden');
                document.getElementById('offlineModeBanner').classList.add('hidden');
                document.getElementById('syncSection').classList.remove('hidden');
                document.getElementById('restoreBackupBtn').classList.remove('hidden');
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                document.getElementById('userAvatar').src = currentUser.picture || '';
                DriveSync.init();
            },

            onSignInError(error) {
                document.getElementById('loginContent').classList.remove('hidden');
                document.getElementById('loginLoading').classList.add('hidden');
                document.getElementById('loginError').classList.remove('hidden');
                document.getElementById('loginErrorText').textContent = `Erro: ${error}`;
            },

            resetLogin() {
                document.getElementById('loginContent').classList.remove('hidden');
                document.getElementById('loginLoading').classList.add('hidden');
                document.getElementById('loginError').classList.add('hidden');
            },

            signOut() {
                showConfirmDialog('Deseja realmente sair?', () => {
                    // Clear in-memory data only (no localStorage in iframe)
                    this.accessToken = null;
                    currentUser = null;
                    isLoggedIn = false;
                    if (autoSyncInterval) clearInterval(autoSyncInterval);
                    location.reload();
                });
            },

            continueOffline() {
                isOfflineMode = true;
                isLoggedIn = false;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('offlineModeBanner').classList.remove('hidden');
                document.getElementById('userInfoSection').classList.add('hidden');
                document.getElementById('syncSection').classList.add('hidden');
                document.getElementById('restoreBackupBtn').classList.add('hidden');
            },

            getAccessToken() { return this.accessToken; }
        };

        // ==============================================
        // GOOGLE DRIVE SYNC MODULE
        // ==============================================
        const DriveSync = {
            folderId: null,
            mainFileId: null,
            isSyncing: false,

            async init() {
                this.showSyncNotification('Conectando ao Google Drive...');
                try {
                    this.folderId = await this.findOrCreateFolder();
                    await this.loadFromDrive();
                    this.startAutoSync();
                    this.hideSyncNotification();
                    this.updateSyncStatus('Sincronizado', 'green');
                } catch (error) {
                    console.error('Drive init error:', error);
                    this.hideSyncNotification();
                    this.updateSyncStatus('Erro de conex√£o', 'red');
                    showAlert('Erro ao conectar com o Google Drive: ' + error.message);
                }
            },

            async findOrCreateFolder() {
                const token = GoogleAuth.getAccessToken();
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='${CONFIG.DRIVE_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const searchData = await searchResponse.json();
                if (searchData.files && searchData.files.length > 0) return searchData.files[0].id;
                const createResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: CONFIG.DRIVE_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' })
                });
                const createData = await createResponse.json();
                return createData.id;
            },

            async loadFromDrive() {
                const token = GoogleAuth.getAccessToken();
                const fileName = `${CONFIG.PIZZARIA_NAME}.json`;
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='${fileName}' and '${this.folderId}' in parents and trashed=false`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const searchData = await searchResponse.json();
                if (searchData.files && searchData.files.length > 0) {
                    this.mainFileId = searchData.files[0].id;
                    const contentResponse = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${this.mainFileId}?alt=media`,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );
                    const data = await contentResponse.json();
                    this.loadDataFromJSON(data);
                    lastSyncTime = new Date();
                    this.updateLastSyncTime();
                }
                // Render all components
                renderSuppliers();
                renderIngredients();
                renderPreparations();
                renderPizzas();
                renderPlatforms();
                if (typeof renderCombos === 'function') renderCombos();
                if (typeof renderAnalysis === 'function') renderAnalysis();
                if (typeof renderOperationalCosts === 'function') renderOperationalCosts();
                if (typeof renderManagementData === 'function') renderManagementData();
                renderDashboard();
            },

            loadDataFromJSON(data) {
                const sourceData = data.data || data;
                suppliers = sourceData.suppliers || [];
                ingredients = sourceData.ingredients || [];
                preparations = sourceData.preparations || [];
                pizzas = sourceData.pizzas || [];
                platforms = sourceData.platforms || [];
                combos = sourceData.combos || [];
                managementData = sourceData.managementData || [];
                priceHistory = sourceData.priceHistory || {};
                if (sourceData.operationalCosts) operationalCosts = { ...operationalCosts, ...sourceData.operationalCosts };
            },

            async saveToDrive() {
                if (this.isSyncing || !isLoggedIn) return;
                this.isSyncing = true;
                this.showSyncNotification('Salvando no Google Drive...');
                this.updateSyncStatus('Sincronizando...', 'yellow');
                try {
                    const token = GoogleAuth.getAccessToken();
                    const fileName = `${CONFIG.PIZZARIA_NAME}.json`;
                    if (this.mainFileId) await this.createBackup();
                    const data = {
                        version: CONFIG.DATA_VERSION,
                        exportDate: new Date().toISOString(),
                        suppliers, ingredients, preparations, pizzas, platforms, combos, operationalCosts, managementData, priceHistory
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    if (this.mainFileId) {
                        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${this.mainFileId}?uploadType=media`, {
                            method: 'PATCH',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: blob
                        });
                    } else {
                        const metadata = { name: fileName, parents: [this.folderId] };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', blob);
                        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form
                        });
                        const result = await response.json();
                        this.mainFileId = result.id;
                    }
                    lastSyncTime = new Date();
                    this.updateLastSyncTime();
                    this.updateSyncStatus('Sincronizado', 'green');
                    this.hideSyncNotification();
                } catch (error) {
                    console.error('Save error:', error);
                    this.updateSyncStatus('Erro ao salvar', 'red');
                    this.hideSyncNotification();
                    showAlert('Erro ao salvar: ' + error.message);
                } finally { this.isSyncing = false; }
            },

            async createBackup() {
                const token = GoogleAuth.getAccessToken();
                const backupName = `${CONFIG.PIZZARIA_NAME}_backup_${Date.now()}.json`;
                try {
                    await fetch(`https://www.googleapis.com/drive/v3/files/${this.mainFileId}/copy`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: backupName, parents: [this.folderId] })
                    });
                    await this.cleanOldBackups();
                } catch (error) { console.error('Backup error:', error); }
            },

            async cleanOldBackups() {
                const token = GoogleAuth.getAccessToken();
                try {
                    const response = await fetch(
                        `https://www.googleapis.com/drive/v3/files?q=name contains '${CONFIG.PIZZARIA_NAME}_backup_' and '${this.folderId}' in parents and trashed=false&orderBy=createdTime desc`,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );
                    const data = await response.json();
                    if (data.files && data.files.length > CONFIG.MAX_BACKUPS) {
                        const toDelete = data.files.slice(CONFIG.MAX_BACKUPS);
                        for (const file of toDelete) {
                            await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}`, {
                                method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                            });
                        }
                    }
                } catch (error) { console.error('Cleanup error:', error); }
            },

            async getBackupList() {
                const token = GoogleAuth.getAccessToken();
                try {
                    const response = await fetch(
                        `https://www.googleapis.com/drive/v3/files?q=name contains '${CONFIG.PIZZARIA_NAME}_backup_' and '${this.folderId}' in parents and trashed=false&orderBy=createdTime desc&fields=files(id,name,createdTime)`,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );
                    const data = await response.json();
                    return data.files || [];
                } catch (error) { console.error('Get backups error:', error); return []; }
            },

            async restoreBackup(fileId) {
                const token = GoogleAuth.getAccessToken();
                this.showSyncNotification('Restaurando backup...');
                try {
                    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    this.loadDataFromJSON(data);
                    renderSuppliers(); renderIngredients(); renderPreparations(); renderPizzas();
                    renderPlatforms(); renderDashboard();
                    if (typeof renderCombos === 'function') renderCombos();
                    if (typeof renderAnalysis === 'function') renderAnalysis();
                    if (typeof renderOperationalCosts === 'function') renderOperationalCosts();
                    if (typeof renderManagementData === 'function') renderManagementData();
                    await this.saveToDrive();
                    this.hideRestoreBackupModal();
                    showAlert('Backup restaurado com sucesso!');
                } catch (error) {
                    console.error('Restore error:', error);
                    showAlert('Erro ao restaurar: ' + error.message);
                }
                this.hideSyncNotification();
            },

            showRestoreBackupModal() {
                document.getElementById('restoreBackupModal').classList.remove('hidden');
                this.loadBackupList();
            },

            hideRestoreBackupModal() {
                document.getElementById('restoreBackupModal').classList.add('hidden');
            },

            async loadBackupList() {
                const container = document.getElementById('backupList');
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Carregando...</p>';
                const backups = await this.getBackupList();
                if (backups.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum backup encontrado</p>';
                    return;
                }
                container.innerHTML = backups.map(backup => {
                    const date = new Date(backup.createdTime);
                    return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div><p class="font-medium text-gray-900">${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR')}</p></div>
                        <button onclick="DriveSync.restoreBackup('${backup.id}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Restaurar</button>
                    </div>`;
                }).join('');
            },

            syncNow() {
                if (!isLoggedIn) { showAlert('Fa√ßa login para sincronizar'); return; }
                this.saveToDrive();
            },

            startAutoSync() {
                if (autoSyncInterval) clearInterval(autoSyncInterval);
                autoSyncInterval = setInterval(() => {
                    if (isLoggedIn && !this.isSyncing) this.saveToDrive();
                }, CONFIG.AUTO_SYNC_INTERVAL * 60 * 1000);
            },

            showSyncNotification(message) {
                document.getElementById('syncNotificationText').textContent = message;
                document.getElementById('syncNotificationBar').classList.remove('hidden');
            },

            hideSyncNotification() {
                document.getElementById('syncNotificationBar').classList.add('hidden');
            },

            updateSyncStatus(status, color) {
                const dot = document.getElementById('syncStatusDot');
                const text = document.getElementById('syncStatusText');
                dot.className = `w-2 h-2 rounded-full bg-${color}-500`;
                if (color === 'yellow') dot.classList.add('sync-pulse');
                text.textContent = status;
            },

            updateLastSyncTime() {
                if (lastSyncTime) document.getElementById('lastSyncTime').textContent = lastSyncTime.toLocaleTimeString('pt-BR');
            }
        };

        // Modal functions
        function showConfirmDialog(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmButton').onclick = () => {
                hideConfirmModal();
                onConfirm();
            };
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.remove('hidden');
        }

        function hideAlertModal() {
            document.getElementById('alertModal').classList.add('hidden');
        }

        // Image view modal functions
        let currentImageData = null;
        let currentImageFilename = 'pedido.jpg';

        function showImageViewModal(imageData, filename) {
            currentImageData = imageData;
            currentImageFilename = filename || 'pedido.jpg';
            document.getElementById('imageViewContent').src = imageData;
            document.getElementById('imageViewModal').classList.remove('hidden');
        }

        function hideImageViewModal() {
            document.getElementById('imageViewModal').classList.add('hidden');
            currentImageData = null;
        }

        function downloadCurrentImage() {
            if (!currentImageData) return;

            const link = document.createElement('a');
            link.href = currentImageData;
            link.download = currentImageFilename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Tab management
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Refresh data if needed
            if (tabName === 'dashboard') {
                renderDashboard();
            } else if (tabName === 'fornecedores') {
                renderSuppliers();
            } else if (tabName === 'preparacoes') {
                renderPreparations();
            } else if (tabName === 'pizzas') {
                renderPizzas();
            } else if (tabName === 'plataformas') {
                renderPlatforms();
            } else if (tabName === 'custos') {
                renderOperationalCosts();
            } else if (tabName === 'gerencial') {
                renderManagementData();
            } else if (tabName === 'combos') {
                renderCombos();
            } else if (tabName === 'analise') {
                renderAnalysis();
            }
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            // Totals
            document.getElementById('dash-suppliers-count').textContent = suppliers.length;
            document.getElementById('dash-ingredients-count').textContent = ingredients.length;
            document.getElementById('dash-preparations-count').textContent = preparations.length;
            document.getElementById('dash-pizzas-count').textContent = pizzas.length;

            // Financial Analysis
            const financialAnalysis = document.getElementById('dash-financial-analysis');

            if (pizzas.length === 0) {
                financialAnalysis.innerHTML = '<p class="text-gray-500 text-gray-500 col-span-3">Nenhuma pizza cadastrada ainda</p>';
            } else {
                // Calculate metrics
                const mostProfitable = [...pizzas].sort((a, b) => b.profit - a.profit)[0];
                const leastProfitable = [...pizzas].sort((a, b) => a.profit - b.profit)[0];
                const mostExpensive = [...pizzas].sort((a, b) => b.salePrice - a.salePrice)[0];
                const cheapest = [...pizzas].sort((a, b) => a.salePrice - b.salePrice)[0];
                const avgProfit = pizzas.reduce((sum, p) => sum + p.profit, 0) / pizzas.length;
                const avgMargin = pizzas.reduce((sum, p) => sum + p.profitMargin, 0) / pizzas.length;
                const avgCost = pizzas.reduce((sum, p) => sum + p.totalCost, 0) / pizzas.length;

                financialAnalysis.innerHTML = `
                    <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üí∞ Mais Lucrativa</p>
                        <p class="text-lg font-bold text-green-600 dark:text-green-400">${mostProfitable.name}</p>
                        <p class="text-sm text-gray-500 text-gray-500">R$ ${mostProfitable.profit.toFixed(2)}</p>
                    </div>
                    <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üìâ Menos Lucrativa</p>
                        <p class="text-lg font-bold text-red-600 dark:text-red-400">${leastProfitable.name}</p>
                        <p class="text-sm text-gray-500 text-gray-500">R$ ${leastProfitable.profit.toFixed(2)}</p>
                    </div>
                    <div class="p-4 bg-gray-50 bg-white/20 rounded-lg border border-gray-300 border-gray-300">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üíµ Mais Cara</p>
                        <p class="text-lg font-bold text-gray-800 text-gray-600">${mostExpensive.name}</p>
                        <p class="text-sm text-gray-500 text-gray-500">R$ ${mostExpensive.salePrice.toFixed(2)}</p>
                    </div>
                    <div class="p-4 bg-blue-50 dark:bg-gray-100 rounded-lg border border-blue-200 dark:border-blue-200">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üè∑Ô∏è Mais Barata</p>
                        <p class="text-lg font-bold text-blue-600 dark:text-blue-400">${cheapest.name}</p>
                        <p class="text-sm text-gray-500 text-gray-500">R$ ${cheapest.salePrice.toFixed(2)}</p>
                    </div>
                    <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üìä Lucro M√©dio</p>
                        <p class="text-lg font-bold text-yellow-600 dark:text-yellow-400">R$ ${avgProfit.toFixed(2)}</p>
                        <p class="text-sm text-gray-500 text-gray-500">por pizza</p>
                    </div>
                    <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üìà Margem M√©dia</p>
                        <p class="text-lg font-bold text-indigo-600 dark:text-indigo-400">${avgMargin.toFixed(1)}%</p>
                        <p class="text-sm text-gray-500 text-gray-500">de lucro</p>
                    </div>
                    <div class="p-4 bg-gray-50 bg-white/20 rounded-lg border border-gray-300 border-gray-300">
                        <p class="text-sm text-gray-600 text-gray-500 mb-1">üí∏ Custo M√©dio</p>
                        <p class="text-lg font-bold text-gray-800 text-gray-600">R$ ${avgCost.toFixed(2)}</p>
                        <p class="text-sm text-gray-500 text-gray-500">por pizza</p>
                    </div>
                `;

                // Most expensive ingredient and preparation
                if (ingredients.length > 0) {
                    const mostExpensiveIng = [...ingredients].sort((a, b) => b.cost - a.cost)[0];
                    financialAnalysis.innerHTML += `
                        <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üî¥ Ingrediente Mais Caro</p>
                            <p class="text-lg font-bold text-orange-600 dark:text-orange-400">${mostExpensiveIng.name}</p>
                            <p class="text-sm text-gray-500 text-gray-500">R$ ${mostExpensiveIng.cost.toFixed(2)}/${mostExpensiveIng.unit}</p>
                        </div>
                    `;
                }

                if (preparations.length > 0) {
                    const mostExpensivePrep = [...preparations].sort((a, b) => b.unitCost - a.unitCost)[0];
                    financialAnalysis.innerHTML += `
                        <div class="p-4 bg-teal-50 dark:bg-teal-900/20 rounded-lg border border-teal-200 dark:border-teal-800">
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üü° Prepara√ß√£o Mais Cara</p>
                            <p class="text-lg font-bold text-teal-600 dark:text-teal-400">${mostExpensivePrep.name}</p>
                            <p class="text-sm text-gray-500 text-gray-500">R$ ${mostExpensivePrep.unitCost.toFixed(2)}/unidade</p>
                        </div>
                    `;
                }
            }

            // Alerts - Always show all 3 categories
            const alertsContainer = document.getElementById('dash-alerts');
            const minMargin = parseFloat(document.getElementById('minProfitMargin').value) || 40;

            // Category 1: Low margin pizzas
            const lowMarginPizzas = pizzas.filter(p => p.profitMargin < minMargin);
            const alert1HTML = lowMarginPizzas.length > 0 ? `
                <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="font-semibold text-gray-900 text-gray-900 mb-2">‚ö†Ô∏è Pizzas com margem abaixo de ${minMargin}%</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 text-gray-600 space-y-1">
                                ${lowMarginPizzas.map(p => `<li>${p.name} <span class="font-medium text-yellow-700 dark:text-yellow-400">(${p.profitMargin.toFixed(1)}%)</span></li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="font-semibold text-gray-900 text-gray-900 mb-1">‚úÖ Margens de Lucro</h4>
                            <p class="text-sm text-gray-700 text-gray-600">${pizzas.length > 0 ? `Todas as pizzas est√£o com margem acima de ${minMargin}%` : 'Nenhuma pizza cadastrada ainda'}</p>
                        </div>
                    </div>
                </div>
            `;

            // Category 2: Ingredients without supplier
            const ingredientsWithoutSupplier = ingredients.filter(i => !i.supplierId);
            const alert2HTML = ingredientsWithoutSupplier.length > 0 ? `
                <div class="p-4 bg-blue-50 dark:bg-gray-100 rounded-lg border border-blue-200 dark:border-blue-200">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="font-semibold text-gray-900 text-gray-900 mb-2">üîî Ingredientes sem fornecedor</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 text-gray-600 space-y-1">
                                ${ingredientsWithoutSupplier.map(i => `<li>${i.name}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="font-semibold text-gray-900 text-gray-900 mb-1">‚úÖ Fornecedores</h4>
                            <p class="text-sm text-gray-700 text-gray-600">${ingredients.length > 0 ? 'Todos os ingredientes possuem fornecedor definido' : 'Nenhum ingrediente cadastrado ainda'}</p>
                        </div>
                    </div>
                </div>
            `;

            // Category 3: Unused preparations
            const usedPrepIds = new Set();
            pizzas.forEach(pizza => {
                pizza.preparations.forEach(prep => {
                    usedPrepIds.add(prep.preparationId);
                });
            });
            const unusedPreparations = preparations.filter(p => !usedPrepIds.has(p.id));
            const alert3HTML = unusedPreparations.length > 0 ? `
                <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-800">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="font-semibold text-gray-900 text-gray-900 mb-2">üìã Prepara√ß√µes n√£o utilizadas</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 text-gray-600 space-y-1">
                                ${unusedPreparations.map(p => `<li>${p.name}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="font-semibold text-gray-900 text-gray-900 mb-1">‚úÖ Prepara√ß√µes</h4>
                            <p class="text-sm text-gray-700 text-gray-600">${preparations.length > 0 ? 'Todas as prepara√ß√µes est√£o sendo utilizadas em pizzas' : 'Nenhuma prepara√ß√£o cadastrada ainda'}</p>
                        </div>
                    </div>
                </div>
            `;

            alertsContainer.innerHTML = alert1HTML + alert2HTML + alert3HTML;

            // Pizza Distribution
            const distributionContainer = document.getElementById('dash-pizza-distribution');
            // Se type n√£o est√° definido, considera como salgada (padr√£o)
            const salgadas = pizzas.filter(p => !p.type || p.type === 'salgada').length;
            const doces = pizzas.filter(p => p.type === 'doce').length;

            if (pizzas.length === 0) {
                distributionContainer.innerHTML = '<p class="text-gray-500 text-gray-500">Nenhuma pizza cadastrada</p>';
            } else {
                const salgadasPercent = ((salgadas / pizzas.length) * 100).toFixed(1);
                const docesPercent = ((doces / pizzas.length) * 100).toFixed(1);

                distributionContainer.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700 text-gray-600">üßÇ Salgadas</span>
                                <span class="text-sm text-gray-600 text-gray-500">${salgadas} (${salgadasPercent}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 bg-gray-50 rounded-full h-3">
                                <div class="bg-orange-500 h-3 rounded-full" style="width: ${salgadasPercent}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700 text-gray-600">üç´ Doces</span>
                                <span class="text-sm text-gray-600 text-gray-500">${doces} (${docesPercent}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 bg-gray-50 rounded-full h-3">
                                <div class="bg-gray-500 h-3 rounded-full" style="width: ${docesPercent}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Next Orders
            const nextOrdersContainer = document.getElementById('dash-next-orders');
            const daysOfWeek = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const today = new Date().getDay();

            const suppliersWithOrders = suppliers.filter(s => s.orderDay).map(s => {
                const orderDayIndex = daysOfWeek.indexOf(s.orderDay);
                let daysUntil = orderDayIndex - today;
                if (daysUntil < 0) daysUntil += 7;
                return { ...s, daysUntil, orderDayIndex };
            }).sort((a, b) => a.daysUntil - b.daysUntil);

            if (suppliersWithOrders.length === 0) {
                nextOrdersContainer.innerHTML = '<p class="text-gray-500 text-gray-500">Nenhum fornecedor com dia de pedido definido</p>';
            } else {
                nextOrdersContainer.innerHTML = `
                    <div class="space-y-3">
                        ${suppliersWithOrders.slice(0, 5).map(s => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium text-gray-900 text-gray-900">${s.name}</p>
                                    <p class="text-sm text-gray-500 text-gray-500">${s.orderDay}${s.deliveryDay ? ` ‚Üí ${s.deliveryDay}` : ''}</p>
                                </div>
                                <span class="px-3 py-1 text-xs font-medium rounded-full ${s.daysUntil === 0 ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : s.daysUntil <= 2 ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400' : 'bg-gray-100 text-gray-700 dark:bg-gray-600 text-gray-600'}">
                                    ${s.daysUntil === 0 ? 'Hoje!' : s.daysUntil === 1 ? 'Amanh√£' : `${s.daysUntil} dias`}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Most used supplier
            if (suppliers.length > 0 && ingredients.length > 0) {
                const supplierUsage = {};
                suppliers.forEach(s => supplierUsage[s.id] = 0);
                ingredients.forEach(i => {
                    if (i.supplierId && supplierUsage[i.supplierId] !== undefined) {
                        supplierUsage[i.supplierId]++;
                    }
                });

                const mostUsedSupplierId = Object.keys(supplierUsage).reduce((a, b) =>
                    supplierUsage[a] > supplierUsage[b] ? a : b
                );
                const mostUsedSupplier = suppliers.find(s => s.id === parseInt(mostUsedSupplierId));
                const usageCount = supplierUsage[mostUsedSupplierId];

                if (mostUsedSupplier && usageCount > 0) {
                    nextOrdersContainer.innerHTML += `
                        <div class="mt-4 p-4 bg-gray-50 bg-white/20 rounded-lg border border-gray-300 border-gray-300">
                            <p class="text-sm text-gray-600 text-gray-500 mb-1">üèÜ Fornecedor Mais Utilizado</p>
                            <p class="font-bold text-gray-800 text-gray-600">${mostUsedSupplier.name}</p>
                            <p class="text-sm text-gray-500 text-gray-500">${usageCount} ingrediente(s)</p>
                        </div>
                    `;
                }
            }
        }

        // ==================== FORNECEDORES ====================
        function addSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const cnpj = document.getElementById('supplierCNPJ').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const contact = document.getElementById('supplierContact').value.trim();
            const address = document.getElementById('supplierAddress').value.trim();
            const city = document.getElementById('supplierCity').value.trim();
            const state = document.getElementById('supplierState').value.trim();
            const cep = document.getElementById('supplierCEP').value.trim();
            const orderDay = document.getElementById('supplierOrderDay').value;
            const deliveryDay = document.getElementById('supplierDeliveryDay').value;
            const lastOrderDate = document.getElementById('supplierLastOrderDate').value;
            const notes = document.getElementById('supplierNotes').value.trim();

            if (!name) {
                showAlert('Por favor, insira o nome do fornecedor');
                return;
            }

            // Handle image upload
            const imageInput = document.getElementById('supplierLastOrderImage');
            let imageData = null;

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    saveSupplier();
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                saveSupplier();
            }

            function saveSupplier() {
                suppliers.push({
                    id: Date.now(),
                    name,
                    cnpj,
                    phone,
                    email,
                    contact,
                    address,
                    city,
                    state,
                    cep,
                    orderDay,
                    deliveryDay,
                    lastOrderDate,
                    lastOrderImage: imageData,
                    notes
                });

                renderSuppliers();
                renderDashboard();

                // Clear form
                document.getElementById('supplierName').value = '';
                document.getElementById('supplierCNPJ').value = '';
                document.getElementById('supplierPhone').value = '';
                document.getElementById('supplierEmail').value = '';
                document.getElementById('supplierContact').value = '';
                document.getElementById('supplierAddress').value = '';
                document.getElementById('supplierCity').value = '';
                document.getElementById('supplierState').value = '';
                document.getElementById('supplierCEP').value = '';
                document.getElementById('supplierOrderDay').value = '';
                document.getElementById('supplierDeliveryDay').value = '';
                document.getElementById('supplierLastOrderDate').value = '';
                document.getElementById('supplierLastOrderImage').value = '';
                document.getElementById('supplierNotes').value = '';

                showAlert('Fornecedor cadastrado com sucesso!');
                setTimeout(() => {
                    hideAlertModal();
                }, 1500);
            }
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;

            // Fill modal with supplier data
            document.getElementById('editSupplierName').value = supplier.name;
            document.getElementById('editSupplierCNPJ').value = supplier.cnpj || '';
            document.getElementById('editSupplierPhone').value = supplier.phone || '';
            document.getElementById('editSupplierEmail').value = supplier.email || '';
            document.getElementById('editSupplierContact').value = supplier.contact || '';
            document.getElementById('editSupplierAddress').value = supplier.address || '';
            document.getElementById('editSupplierCity').value = supplier.city || '';
            document.getElementById('editSupplierState').value = supplier.state || '';
            document.getElementById('editSupplierCEP').value = supplier.cep || '';
            document.getElementById('editSupplierOrderDay').value = supplier.orderDay || '';
            document.getElementById('editSupplierDeliveryDay').value = supplier.deliveryDay || '';
            document.getElementById('editSupplierLastOrderDate').value = supplier.lastOrderDate || '';
            document.getElementById('editSupplierNotes').value = supplier.notes || '';

            editingSupplierId = id;
            document.getElementById('editSupplierModal').classList.remove('hidden');
            document.getElementById('editSupplierName').focus();
        }

        function hideEditSupplierModal() {
            document.getElementById('editSupplierModal').classList.add('hidden');
            editingSupplierId = null;
        }

        function saveEditSupplier() {
            const name = document.getElementById('editSupplierName').value.trim();
            const cnpj = document.getElementById('editSupplierCNPJ').value.trim();
            const phone = document.getElementById('editSupplierPhone').value.trim();
            const email = document.getElementById('editSupplierEmail').value.trim();
            const contact = document.getElementById('editSupplierContact').value.trim();
            const address = document.getElementById('editSupplierAddress').value.trim();
            const city = document.getElementById('editSupplierCity').value.trim();
            const state = document.getElementById('editSupplierState').value.trim();
            const cep = document.getElementById('editSupplierCEP').value.trim();
            const orderDay = document.getElementById('editSupplierOrderDay').value;
            const deliveryDay = document.getElementById('editSupplierDeliveryDay').value;
            const lastOrderDate = document.getElementById('editSupplierLastOrderDate').value;
            const notes = document.getElementById('editSupplierNotes').value.trim();

            if (!name) {
                showAlert('Por favor, insira o nome do fornecedor');
                return;
            }

            const supplier = suppliers.find(s => s.id === editingSupplierId);
            if (!supplier) return;

            // Handle image upload if new image selected
            const imageInput = document.getElementById('editSupplierLastOrderImage');

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateSupplier(e.target.result);
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                updateSupplier(supplier.lastOrderImage);
            }

            function updateSupplier(imageData) {
                supplier.name = name;
                supplier.cnpj = cnpj;
                supplier.phone = phone;
                supplier.email = email;
                supplier.contact = contact;
                supplier.address = address;
                supplier.city = city;
                supplier.state = state;
                supplier.cep = cep;
                supplier.orderDay = orderDay;
                supplier.deliveryDay = deliveryDay;
                supplier.lastOrderDate = lastOrderDate;
                supplier.lastOrderImage = imageData;
                supplier.notes = notes;

                renderSuppliers();
                renderDashboard();
                hideEditSupplierModal();

                showAlert('Fornecedor atualizado com sucesso!');
                setTimeout(() => {
                    hideAlertModal();
                }, 1500);
            }
        }

        function renderSuppliers() {
            const list = document.getElementById('suppliersList');

            if (suppliers.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-gray-500 text-center py-4 col-span-2">Nenhum fornecedor cadastrado ainda</p>';
                return;
            }

            list.innerHTML = suppliers.map(supplier => `
                <div class="bg-gray-50 bg-white rounded-lg shadow p-4 card-hover border border-gray-300 border-gray-200">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-900 text-gray-900 text-lg">${supplier.name}</h4>
                            ${supplier.cnpj ? `<p class="text-sm text-gray-500 text-gray-500">CNPJ: ${supplier.cnpj}</p>` : ''}
                        </div>
                        <div class="flex items-center space-x-1">
                            <button onclick="editSupplier(${supplier.id})" class="text-blue-500 hover:text-blue-700 p-1" title="Editar">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteSupplier(${supplier.id})" class="text-red-500 hover:text-red-700 p-1" title="Excluir">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-1 text-sm mb-3">
                        ${supplier.phone ? `<p class="text-gray-600 text-gray-500"><span class="font-medium">üìû</span> ${supplier.phone}</p>` : ''}
                        ${supplier.email ? `<p class="text-gray-600 text-gray-500"><span class="font-medium">‚úâÔ∏è</span> ${supplier.email}</p>` : ''}
                        ${supplier.contact ? `<p class="text-gray-600 text-gray-500"><span class="font-medium">üë§</span> ${supplier.contact}</p>` : ''}
                        ${supplier.address || supplier.city ? `<p class="text-gray-600 text-gray-500"><span class="font-medium">üìç</span> ${supplier.address ? supplier.address + (supplier.city ? ', ' : '') : ''}${supplier.city || ''}${supplier.state ? ' - ' + supplier.state : ''}</p>` : ''}
                    </div>
                    ${supplier.orderDay || supplier.deliveryDay ? `
                        <div class="border-t border-gray-300 border-gray-300 pt-2 space-y-1 mb-3">
                            ${supplier.orderDay ? `<p class="text-sm text-gray-600 text-gray-500"><span class="font-medium">üìÖ Pedido:</span> ${supplier.orderDay}</p>` : ''}
                            ${supplier.deliveryDay ? `<p class="text-sm text-gray-600 text-gray-500"><span class="font-medium">üöö Entrega:</span> ${supplier.deliveryDay}</p>` : ''}
                            ${supplier.lastOrderDate ? `<p class="text-sm text-gray-600 text-gray-500"><span class="font-medium">üóìÔ∏è √öltimo pedido:</span> ${new Date(supplier.lastOrderDate).toLocaleDateString('pt-BR')}</p>` : ''}
                        </div>
                    ` : ''}
                    ${supplier.lastOrderImage ? `
                        <details class="text-sm mb-2">
                            <summary class="cursor-pointer text-gray-800 text-gray-600 font-medium hover:text-blue-600 dark:hover:text-blue-400">‚ñº üì∏ Ver Imagem do √öltimo Pedido</summary>
                            <div class="mt-2 relative">
                                <img src="${supplier.lastOrderImage}" alt="√öltimo pedido" class="w-full h-auto rounded-lg border border-gray-300 border-gray-300 cursor-pointer hover:opacity-90 transition-opacity" onclick="viewImage('${supplier.lastOrderImage}', 'Pedido - ${supplier.name.replace(/'/g, "\\'")}')">
                                <div class="flex gap-2 mt-2">
                                    <button onclick="viewImage('${supplier.lastOrderImage}', 'Pedido - ${supplier.name.replace(/'/g, "\\'")}')" class="flex-1 bg-gray-100 hover:bg-gray-200 bg-gray-50 dark:hover:bg-gray-600 text-gray-700 text-gray-600 py-2 px-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        Visualizar
                                    </button>
                                    <button onclick="downloadImage('${supplier.lastOrderImage}', 'Pedido_${supplier.name.replace(/'/g, "\\'")}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        Baixar
                                    </button>
                                </div>
                            </div>
                        </details>
                    ` : ''}
                    ${supplier.notes ? `
                        <details class="text-sm">
                            <summary class="cursor-pointer text-gray-800 text-gray-600 font-medium hover:text-purple-800 dark:hover:text-purple-300">üìù Ver Observa√ß√µes</summary>
                            <div class="mt-2 p-3 bg-white bg-white rounded-lg border border-purple-100 border-gray-300">
                                <p class="text-gray-700 text-gray-600 whitespace-pre-wrap">${supplier.notes}</p>
                            </div>
                        </details>
                    ` : ''}
                </div>
            `).join('');
        }

        function deleteSupplier(id) {
            showConfirmDialog('Deseja realmente excluir este fornecedor?', () => {
                // Remove supplier link from all ingredients
                ingredients.forEach(ingredient => {
                    if (ingredient.supplierId === id || ingredient.supplierId === String(id)) {
                        ingredient.supplierId = null;
                        ingredient.supplierName = null;
                    }
                });

                // Remove supplier
                suppliers = suppliers.filter(s => s.id !== id);

                // Re-render both suppliers and ingredients
                renderSuppliers();
                renderIngredients();
                renderDashboard();

                showAlert('Fornecedor exclu√≠do e v√≠nculos com ingredientes removidos!');
                setTimeout(() => {
                    hideAlertModal();
                }, 2000);
            });
        }

        // ==================== INGREDIENTES ====================
        function populateSupplierOptions() {
            const ingredientSupplier = document.getElementById('ingredientSupplier');
            const editIngredientSupplier = document.getElementById('editIngredientSupplier');

            const options = '<option value="">Nenhum</option>' +
                suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            if (ingredientSupplier) ingredientSupplier.innerHTML = options;
            if (editIngredientSupplier) editIngredientSupplier.innerHTML = options;
        }

        function addIngredient() {
            const name = document.getElementById('ingredientName').value.trim();
            const cost = parseFloat(document.getElementById('ingredientCost').value);
            const unit = document.getElementById('ingredientUnit').value;
            const supplierId = document.getElementById('ingredientSupplier').value;

            if (!name) {
                showAlert('Por favor, insira o nome do ingrediente');
                return;
            }

            if (isNaN(cost) || cost < 0) {
                showAlert('Por favor, insira um custo v√°lido');
                return;
            }

            // Check for duplicate ingredient
            const existingIngredient = ingredients.find(ing => 
                ing.name.toLowerCase().trim() === name.toLowerCase().trim()
            );
            
            if (existingIngredient) {
                showConfirmDialog(
                    `J√° existe um ingrediente com o nome "${existingIngredient.name}" (R$ ${existingIngredient.cost.toFixed(2)}/${existingIngredient.unit}). Deseja editar o ingrediente existente?`,
                    () => {
                        editIngredient(existingIngredient.id);
                    }
                );
                return;
            }

            const supplier = supplierId ? suppliers.find(s => s.id === parseInt(supplierId)) : null;

            ingredients.push({
                id: Date.now(),
                name,
                cost,
                unit,
                supplierId: supplierId || null,
                supplierName: supplier ? supplier.name : null
            });

            renderIngredients();
            renderDashboard();

            // Clear form
            document.getElementById('ingredientName').value = '';
            document.getElementById('ingredientCost').value = '';
            document.getElementById('ingredientSupplier').value = '';
        }

        function editIngredient(id) {
            const ingredient = ingredients.find(ing => ing.id === id);
            if (!ingredient) return;

            // Populate supplier options
            populateSupplierOptions();

            // Fill modal with ingredient data
            document.getElementById('editIngredientName').value = ingredient.name;
            document.getElementById('editIngredientCost').value = ingredient.cost;
            document.getElementById('editIngredientUnit').value = ingredient.unit;
            document.getElementById('editIngredientSupplier').value = ingredient.supplierId || '';

            // Set editing mode
            editingIngredientId = id;

            // Show modal
            document.getElementById('editIngredientModal').classList.remove('hidden');
            document.getElementById('editIngredientName').focus();
        }

        function hideEditIngredientModal() {
            document.getElementById('editIngredientModal').classList.add('hidden');
            editingIngredientId = null;
        }

        function saveEditIngredient() {
            const name = document.getElementById('editIngredientName').value.trim();
            const cost = parseFloat(document.getElementById('editIngredientCost').value);
            const unit = document.getElementById('editIngredientUnit').value;
            const supplierId = document.getElementById('editIngredientSupplier').value;

            if (!name) {
                showAlert('Por favor, insira o nome do ingrediente');
                return;
            }

            if (isNaN(cost) || cost < 0) {
                showAlert('Por favor, insira um custo v√°lido');
                return;
            }

            const supplier = supplierId ? suppliers.find(s => s.id === parseInt(supplierId)) : null;

            const ingredient = ingredients.find(ing => ing.id === editingIngredientId);
            if (ingredient) {
                // Record price change if cost changed
                if (ingredient.cost !== cost) {
                    recordPriceChange(ingredient.id, ingredient.cost, cost);
                }
                ingredient.name = name;
                ingredient.cost = cost;
                ingredient.unit = unit;
                ingredient.supplierId = supplierId || null;
                ingredient.supplierName = supplier ? supplier.name : null;
            }

            renderIngredients();
            renderDashboard();
            renderPriceHistoryDropdown();
            hideEditIngredientModal();

            showAlert('Ingrediente atualizado com sucesso!');
            setTimeout(() => {
                hideAlertModal();
            }, 1500);
        }

        function renderIngredients() {
            const list = document.getElementById('ingredientsList');

            // Populate supplier options when rendering
            populateSupplierOptions();

            if (ingredients.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-gray-500 text-center py-4">Nenhum ingrediente cadastrado ainda</p>';
                return;
            }

            list.innerHTML = ingredients.map(ing => `
                <div class="flex items-center justify-between p-4 bg-gray-50 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <div>
                            <span class="font-medium text-gray-900 text-gray-900">${ing.name}</span>
                            <span class="text-sm text-gray-500 text-gray-500 ml-2">R$ ${ing.cost.toFixed(2)}/${ing.unit}</span>
                        </div>
                        ${ing.supplierName ? `<div class="text-xs text-gray-500 text-gray-500 mt-1">üè¢ ${ing.supplierName}</div>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="editIngredient(${ing.id})" class="text-blue-500 hover:text-blue-700 p-2" title="Editar">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteIngredient(${ing.id})" class="text-red-500 hover:text-red-700 p-2" title="Excluir">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteIngredient(id) {
            showConfirmDialog('Deseja realmente excluir este ingrediente?', () => {
                ingredients = ingredients.filter(ing => ing.id !== id);
                renderIngredients();
                renderDashboard();
            });
        }

        // ==================== PREPARA√á√ïES ====================
        function addPreparationIngredient() {
            if (ingredients.length === 0) {
                showAlert('Adicione ingredientes b√°sicos primeiro!');
                return;
            }

            const container = document.getElementById('preparationIngredients');
            const id = preparationIngredientsCount++;

            const div = document.createElement('div');
            div.id = `prepIng_${id}`;
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-50 bg-gray-50 rounded-lg slide-in';
            div.innerHTML = `
                <div>
                    <select id="prepIngSelect_${id}" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                        ${ingredients.map(ing => `<option value="${ing.id}">${ing.name} (${ing.unit})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <input type="number" id="prepIngQty_${id}" placeholder="Quantidade" step="0.01" min="0" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <button onclick="removePreparationIngredient(${id})" class="w-full px-3 py-2 text-base bg-red-500 text-gray-900 rounded-lg hover:bg-red-600 transition-colors">
                        Remover
                    </button>
                </div>
            `;

            container.appendChild(div);
        }

        function removePreparationIngredient(id) {
            const element = document.getElementById(`prepIng_${id}`);
            if (element) {
                element.remove();
            }
        }

        function addPreparation() {
            const name = document.getElementById('preparationName').value.trim();
            const yield_qty = parseFloat(document.getElementById('preparationYield').value) || 1;
            const instructions = document.getElementById('preparationInstructions').value.trim();

            if (!name) {
                showAlert('Por favor, insira o nome da prepara√ß√£o');
                return;
            }

            // Get preparation ingredients
            const prepIngredients = [];
            let totalCost = 0;

            for (let i = 0; i < preparationIngredientsCount; i++) {
                const selectElement = document.getElementById(`prepIngSelect_${i}`);
                const qtyElement = document.getElementById(`prepIngQty_${i}`);

                if (selectElement && qtyElement) {
                    const ingredientId = parseInt(selectElement.value);
                    const quantity = parseFloat(qtyElement.value);

                    if (isNaN(quantity) || quantity <= 0) {
                        showAlert('Por favor, insira quantidades v√°lidas para todos os ingredientes');
                        return;
                    }

                    const ingredient = ingredients.find(ing => ing.id === ingredientId);
                    if (ingredient) {
                        const cost = ingredient.cost * quantity;
                        totalCost += cost;

                        prepIngredients.push({
                            ingredientId,
                            name: ingredient.name,
                            quantity,
                            unit: ingredient.unit,
                            unitCost: ingredient.cost,
                            totalCost: cost
                        });
                    }
                }
            }

            if (prepIngredients.length === 0) {
                showAlert('Adicione pelo menos um ingrediente √† prepara√ß√£o');
                return;
            }

            const unitCost = totalCost / yield_qty;

            preparations.push({
                id: Date.now(),
                name,
                yield: yield_qty,
                ingredients: prepIngredients,
                totalCost,
                unitCost,
                instructions
            });

            renderPreparations();
            renderDashboard();

            // Clear form
            document.getElementById('preparationName').value = '';
            document.getElementById('preparationYield').value = '1';
            document.getElementById('preparationInstructions').value = '';
            document.getElementById('preparationIngredients').innerHTML = '';
            preparationIngredientsCount = 0;

            showAlert('Prepara√ß√£o criada com sucesso!');
            setTimeout(() => {
                hideAlertModal();
            }, 1500);
        }

        function editPreparation(id) {
            const preparation = preparations.find(prep => prep.id === id);
            if (!preparation) return;

            // Fill modal with preparation data
            document.getElementById('editPreparationName').value = preparation.name;
            document.getElementById('editPreparationYield').value = preparation.yield;
            document.getElementById('editPreparationInstructions').value = preparation.instructions || '';

            // Clear existing ingredients
            document.getElementById('editPreparationIngredients').innerHTML = '';
            editPreparationIngredientsCount = 0;

            // Add ingredients
            preparation.ingredients.forEach(ing => {
                addEditPreparationIngredient();
                const currentId = editPreparationIngredientsCount - 1;
                document.getElementById(`editPrepIngSelect_${currentId}`).value = ing.ingredientId;
                document.getElementById(`editPrepIngQty_${currentId}`).value = ing.quantity;
            });

            // Set editing mode
            editingPreparationId = id;

            // Show modal
            document.getElementById('editPreparationModal').classList.remove('hidden');
            document.getElementById('editPreparationName').focus();
        }

        function addEditPreparationIngredient() {
            if (ingredients.length === 0) {
                showAlert('Adicione ingredientes b√°sicos primeiro!');
                return;
            }

            const container = document.getElementById('editPreparationIngredients');
            const id = editPreparationIngredientsCount++;

            const div = document.createElement('div');
            div.id = `editPrepIng_${id}`;
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-50 bg-gray-50 rounded-lg slide-in';
            div.innerHTML = `
                <div>
                    <select id="editPrepIngSelect_${id}" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                        ${ingredients.map(ing => `<option value="${ing.id}">${ing.name} (${ing.unit})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <input type="number" id="editPrepIngQty_${id}" placeholder="Quantidade" step="0.01" min="0" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <button onclick="removeEditPreparationIngredient(${id})" class="w-full px-3 py-2 text-base bg-red-500 text-gray-900 rounded-lg hover:bg-red-600 transition-colors">
                        Remover
                    </button>
                </div>
            `;

            container.appendChild(div);
        }

        function removeEditPreparationIngredient(id) {
            const element = document.getElementById(`editPrepIng_${id}`);
            if (element) {
                element.remove();
            }
        }

        function hideEditPreparationModal() {
            document.getElementById('editPreparationModal').classList.add('hidden');
            editingPreparationId = null;
            editPreparationIngredientsCount = 0;
        }

        function saveEditPreparation() {
            const name = document.getElementById('editPreparationName').value.trim();
            const yield_qty = parseFloat(document.getElementById('editPreparationYield').value) || 1;
            const instructions = document.getElementById('editPreparationInstructions').value.trim();

            if (!name) {
                showAlert('Por favor, insira o nome da prepara√ß√£o');
                return;
            }

            // Get preparation ingredients
            const prepIngredients = [];
            let totalCost = 0;

            for (let i = 0; i < editPreparationIngredientsCount; i++) {
                const selectElement = document.getElementById(`editPrepIngSelect_${i}`);
                const qtyElement = document.getElementById(`editPrepIngQty_${i}`);

                if (selectElement && qtyElement) {
                    const ingredientId = parseInt(selectElement.value);
                    const quantity = parseFloat(qtyElement.value);

                    if (isNaN(quantity) || quantity <= 0) {
                        showAlert('Por favor, insira quantidades v√°lidas para todos os ingredientes');
                        return;
                    }

                    const ingredient = ingredients.find(ing => ing.id === ingredientId);
                    if (ingredient) {
                        const cost = ingredient.cost * quantity;
                        totalCost += cost;

                        prepIngredients.push({
                            ingredientId,
                            name: ingredient.name,
                            quantity,
                            unit: ingredient.unit,
                            unitCost: ingredient.cost,
                            totalCost: cost
                        });
                    }
                }
            }

            if (prepIngredients.length === 0) {
                showAlert('Adicione pelo menos um ingrediente √† prepara√ß√£o');
                return;
            }

            const unitCost = totalCost / yield_qty;

            const preparation = preparations.find(prep => prep.id === editingPreparationId);
            if (preparation) {
                preparation.name = name;
                preparation.yield = yield_qty;
                preparation.ingredients = prepIngredients;
                preparation.totalCost = totalCost;
                preparation.unitCost = unitCost;
                preparation.instructions = instructions;
            }

            renderPreparations();
            renderDashboard();
            hideEditPreparationModal();

            showAlert('Prepara√ß√£o atualizada com sucesso!');
            setTimeout(() => {
                hideAlertModal();
            }, 1500);
        }

        function renderPreparations() {
            const list = document.getElementById('preparationsList');

            if (preparations.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-gray-500 text-center py-4">Nenhuma prepara√ß√£o cadastrada ainda</p>';
                return;
            }

            list.innerHTML = preparations.map(prep => `
                <div class="bg-blue-50 bg-white rounded-lg shadow p-4 card-hover border border-blue-200 dark:border-blue-200">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="font-bold text-gray-900 text-gray-900">${prep.name}</h4>
                            <p class="text-sm text-gray-500 text-gray-500">Rendimento: ${prep.yield} unidade(s)</p>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button onclick="editPreparation(${prep.id})" class="text-blue-500 hover:text-blue-700 p-1" title="Editar">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deletePreparation(${prep.id})" class="text-red-500 hover:text-red-700 p-1" title="Excluir">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-1 mb-3 text-sm">
                        ${prep.ingredients.map(ing => `
                            <div class="flex justify-between text-gray-600 text-gray-500">
                                <span>${ing.name}</span>
                                <span>${ing.quantity} ${ing.unit}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="border-t border-blue-200 dark:border-blue-200 pt-2 space-y-1 mb-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 text-gray-500">Custo total:</span>
                            <span class="font-medium text-gray-900 text-gray-900">R$ ${prep.totalCost.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 text-gray-500">Custo unit√°rio:</span>
                            <span class="font-bold text-blue-600 dark:text-blue-400">R$ ${prep.unitCost.toFixed(2)}</span>
                        </div>
                    </div>
                    ${prep.instructions ? `
                        <details class="text-sm">
                            <summary class="cursor-pointer text-blue-600 dark:text-blue-400 font-medium hover:text-blue-800 dark:hover:text-blue-300">üìù Ver Modo de Preparo</summary>
                            <div class="mt-2 p-3 bg-white bg-white rounded-lg border border-blue-100 dark:border-blue-200">
                                <p class="text-gray-700 text-gray-600 whitespace-pre-wrap">${prep.instructions}</p>
                            </div>
                        </details>
                    ` : ''}
                </div>
            `).join('');
        }

        function deletePreparation(id) {
            showConfirmDialog('Deseja realmente excluir esta prepara√ß√£o?', () => {
                preparations = preparations.filter(prep => prep.id !== id);
                renderPreparations();
                renderDashboard();
            });
        }

        // ==================== PIZZAS ====================
        function addPizzaPreparation() {
            if (preparations.length === 0) {
                showAlert('Cadastre prepara√ß√µes primeiro!');
                return;
            }

            const container = document.getElementById('pizzaPreparations');
            const id = pizzaPreparationsCount++;

            const div = document.createElement('div');
            div.id = `pizzaPrep_${id}`;
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-blue-50 dark:bg-gray-100 rounded-lg slide-in border border-blue-200 dark:border-blue-200';
            div.innerHTML = `
                <div>
                    <select id="pizzaPrepSelect_${id}" class="w-full px-3 py-2 text-base border border-blue-300 dark:border-blue-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                        ${preparations.map(prep => `<option value="${prep.id}">${prep.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <input type="number" id="pizzaPrepQty_${id}" placeholder="Quantidade" step="0.01" min="0" class="w-full px-3 py-2 text-base border border-blue-300 dark:border-blue-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <button onclick="removePizzaPreparation(${id})" class="w-full px-3 py-2 text-base bg-red-500 text-gray-900 rounded-lg hover:bg-red-600 transition-colors">
                        Remover
                    </button>
                </div>
            `;

            container.appendChild(div);
        }

        function removePizzaPreparation(id) {
            const element = document.getElementById(`pizzaPrep_${id}`);
            if (element) {
                element.remove();
            }
        }

        function addPizzaIngredient() {
            if (ingredients.length === 0) {
                showAlert('Adicione ingredientes b√°sicos primeiro!');
                return;
            }

            const container = document.getElementById('pizzaIngredients');
            const id = pizzaIngredientsCount++;

            const div = document.createElement('div');
            div.id = `pizzaIng_${id}`;
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-50 bg-gray-50 rounded-lg slide-in';
            div.innerHTML = `
                <div>
                    <select id="pizzaIngSelect_${id}" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                        ${ingredients.map(ing => `<option value="${ing.id}">${ing.name} (${ing.unit})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <input type="number" id="pizzaIngQty_${id}" placeholder="Quantidade" step="0.01" min="0" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <button onclick="removePizzaIngredient(${id})" class="w-full px-3 py-2 text-base bg-red-500 text-gray-900 rounded-lg hover:bg-red-600 transition-colors">
                        Remover
                    </button>
                </div>
            `;

            container.appendChild(div);
        }

        function removePizzaIngredient(id) {
            const element = document.getElementById(`pizzaIng_${id}`);
            if (element) {
                element.remove();
            }
        }

        function addPizza() {
            const name = document.getElementById('pizzaName').value.trim();
            const size = document.getElementById('pizzaSize').value;
            const type = document.getElementById('pizzaType').value;
            const additionalCost = parseFloat(document.getElementById('additionalCost').value) || 0;
            const profitMargin = parseFloat(document.getElementById('profitMargin').value) || 0;
            const wastePercentage = parseFloat(document.getElementById('wastePercentage').value) || 0;

            if (!name) {
                showAlert('Por favor, insira o nome da pizza');
                return;
            }

            // Get preparations
            const pizzaPreparations = [];
            let preparationsCost = 0;

            for (let i = 0; i < pizzaPreparationsCount; i++) {
                const selectElement = document.getElementById(`pizzaPrepSelect_${i}`);
                const qtyElement = document.getElementById(`pizzaPrepQty_${i}`);

                if (selectElement && qtyElement) {
                    const preparationId = parseInt(selectElement.value);
                    const quantity = parseFloat(qtyElement.value);

                    if (isNaN(quantity) || quantity <= 0) {
                        showAlert('Por favor, insira quantidades v√°lidas para todas as prepara√ß√µes');
                        return;
                    }

                    const preparation = preparations.find(prep => prep.id === preparationId);
                    if (preparation) {
                        const cost = preparation.unitCost * quantity;
                        preparationsCost += cost;

                        pizzaPreparations.push({
                            preparationId,
                            name: preparation.name,
                            quantity,
                            unitCost: preparation.unitCost,
                            totalCost: cost
                        });
                    }
                }
            }

            // Get ingredients
            const pizzaIngredients = [];
            let ingredientsCost = 0;

            for (let i = 0; i < pizzaIngredientsCount; i++) {
                const selectElement = document.getElementById(`pizzaIngSelect_${i}`);
                const qtyElement = document.getElementById(`pizzaIngQty_${i}`);

                if (selectElement && qtyElement) {
                    const ingredientId = parseInt(selectElement.value);
                    const quantity = parseFloat(qtyElement.value);

                    if (isNaN(quantity) || quantity <= 0) {
                        showAlert('Por favor, insira quantidades v√°lidas para todos os ingredientes');
                        return;
                    }

                    const ingredient = ingredients.find(ing => ing.id === ingredientId);
                    if (ingredient) {
                        const cost = ingredient.cost * quantity;
                        ingredientsCost += cost;

                        pizzaIngredients.push({
                            ingredientId,
                            name: ingredient.name,
                            quantity,
                            unit: ingredient.unit,
                            unitCost: ingredient.cost,
                            totalCost: cost
                        });
                    }
                }
            }

            if (pizzaPreparations.length === 0 && pizzaIngredients.length === 0) {
                showAlert('Adicione pelo menos uma prepara√ß√£o ou ingrediente √† pizza');
                return;
            }

            // Calculate pricing
            const baseCost = preparationsCost + ingredientsCost;
            const wasteMultiplier = 1 + (wastePercentage / 100);
            const operationalCost = getOperationalCostForPizza(baseCost);
            const totalCost = (baseCost * wasteMultiplier) + additionalCost + operationalCost;
            const salePrice = totalCost * (1 + profitMargin / 100);
            const profit = salePrice - totalCost;

            // Handle image upload
            const imageInput = document.getElementById('pizzaImage');
            let imageData = null;

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    savePizza();
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                savePizza();
            }

            function savePizza() {
                pizzas.push({
                    id: Date.now(),
                    name,
                    size,
                    type,
                    image: imageData,
                    preparations: pizzaPreparations,
                    ingredients: pizzaIngredients,
                    preparationsCost,
                    ingredientsCost,
                    baseCost,
                    additionalCost,
                    operationalCost,
                    wastePercentage,
                    totalCost,
                    profitMargin,
                    salePrice,
                    profit
                });

                renderPizzas();
                renderDashboard();

                // Clear form
                document.getElementById('pizzaName').value = '';
                document.getElementById('pizzaImage').value = '';
                document.getElementById('pizzaPreparations').innerHTML = '';
                document.getElementById('pizzaIngredients').innerHTML = '';
                pizzaPreparationsCount = 0;
                pizzaIngredientsCount = 0;

                showAlert('Pizza criada com sucesso!');
                setTimeout(() => {
                    hideAlertModal();
                }, 1500);
            }
        }

        function changePizzaSort() {
            pizzaSortCriteria = document.getElementById('pizzaSortSelect').value;
            renderPizzas();
        }

        function sortPizzas(pizzasArray) {
            const sorted = [...pizzasArray];

            switch(pizzaSortCriteria) {
                case 'name-asc':
                    sorted.sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
                    break;
                case 'name-desc':
                    sorted.sort((a, b) => b.name.localeCompare(a.name, 'pt-BR'));
                    break;
                case 'price-asc':
                    sorted.sort((a, b) => a.salePrice - b.salePrice);
                    break;
                case 'price-desc':
                    sorted.sort((a, b) => b.salePrice - a.salePrice);
                    break;
                case 'profit-asc':
                    sorted.sort((a, b) => a.profit - b.profit);
                    break;
                case 'profit-desc':
                    sorted.sort((a, b) => b.profit - a.profit);
                    break;
            }

            return sorted;
        }

        function renderPizzas() {
            const list = document.getElementById('pizzasList');
            const emptyState = document.getElementById('emptyState');
            const totalPizzas = document.getElementById('totalPizzas');

            totalPizzas.textContent = pizzas.length;

            if (pizzas.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Apply sorting
            const sortedPizzas = sortPizzas(pizzas);

            list.innerHTML = sortedPizzas.map(pizza => `
                <div class="bg-white bg-white rounded-xl shadow-md overflow-hidden card-hover border border-gray-200 border-gray-300">
                    ${pizza.image ? `
                        <div class="relative h-48 overflow-hidden bg-gray-100 bg-gray-50">
                            <img src="${pizza.image}" alt="${pizza.name}" class="w-full h-full object-cover cursor-pointer" onclick="viewImage('${pizza.image}', '${pizza.name}')">
                            <div class="absolute top-2 right-2 flex gap-1">
                                <button onclick="viewImage('${pizza.image}', '${pizza.name}')" class="bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full p-2 transition-all" title="Visualizar">
                                    <svg class="w-4 h-4 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                                <button onclick="downloadImage('${pizza.image}', '${pizza.name}')" class="bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full p-2 transition-all" title="Baixar">
                                    <svg class="w-4 h-4 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="text-xl font-bold text-gray-900 text-gray-900">${pizza.name}</h3>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${pizza.type === 'doce' ? 'bg-gray-100 text-pink-700 dark:bg-pink-900/30 text-gray-600' : 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400'}">${pizza.type === 'doce' ? 'ÔøΩÔøΩÔøΩÔøΩ Doce' : 'üßÇ Salgada'}</span>
                                </div>
                                <p class="text-sm text-gray-500 text-gray-500">${pizza.size}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="editPizza(${pizza.id})" class="text-blue-500 hover:text-blue-700 p-2" title="Editar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="deletePizza(${pizza.id})" class="text-red-500 hover:text-red-700 p-2" title="Excluir">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                    <div class="space-y-2 mb-4 text-sm">
                        ${pizza.preparations.length > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600 text-gray-500">Custo prepara√ß√µes:</span>
                                <span class="font-medium text-gray-900 text-gray-900">R$ ${pizza.preparationsCost.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        ${pizza.ingredients.length > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600 text-gray-500">Custo ingredientes:</span>
                                <span class="font-medium text-gray-900 text-gray-900">R$ ${pizza.ingredientsCost.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="flex justify-between">
                            <span class="text-gray-600 text-gray-500">Desperd√≠cio (${pizza.wastePercentage}%):</span>
                            <span class="font-medium text-gray-900 text-gray-900">R$ ${(pizza.baseCost * pizza.wastePercentage / 100).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 text-gray-500">Custos adicionais:</span>
                            <span class="font-medium text-gray-900 text-gray-900">R$ ${pizza.additionalCost.toFixed(2)}</span>
                        </div>
                        ${(pizza.operationalCost && pizza.operationalCost > 0) ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600 text-gray-500">Custos operacionais:</span>
                                <span class="font-medium text-gray-900 text-gray-900">R$ ${pizza.operationalCost.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="border-t border-gray-200 border-gray-300 pt-2 flex justify-between">
                            <span class="font-medium text-gray-900 text-gray-900">Custo Total:</span>
                            <span class="font-bold text-red-600 dark:text-red-400">R$ ${pizza.totalCost.toFixed(2)}</span>
                        </div>
                    </div>

                    <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600 text-gray-500">Margem: ${pizza.profitMargin}%</span>
                            <span class="text-sm text-green-600 dark:text-green-400 font-medium">Lucro: R$ ${pizza.profit.toFixed(2)}</span>
                        </div>
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400">R$ ${pizza.salePrice.toFixed(2)}</div>
                        <div class="text-xs text-gray-500 text-gray-500">Pre√ßo de Venda</div>
                    </div>

                    <details class="text-sm">
                        <summary class="cursor-pointer text-primary font-medium hover:text-purple-700">Ver Composi√ß√£o</summary>
                        <div class="mt-3 space-y-2">
                            ${pizza.preparations.length > 0 ? `
                                <div class="pl-2">
                                    <p class="font-semibold text-blue-600 dark:text-blue-400 mb-1">Prepara√ß√µes:</p>
                                    ${pizza.preparations.map(prep => `
                                        <div class="flex justify-between text-gray-600 text-gray-500">
                                            <span>${prep.name}</span>
                                            <span>${prep.quantity}x (R$ ${prep.totalCost.toFixed(2)})</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${pizza.ingredients.length > 0 ? `
                                <div class="pl-2">
                                    <p class="font-semibold text-gray-700 text-gray-600 mb-1">Ingredientes Diretos:</p>
                                    ${pizza.ingredients.map(ing => `
                                        <div class="flex justify-between text-gray-600 text-gray-500">
                                            <span>${ing.name}</span>
                                            <span>${ing.quantity} ${ing.unit} (R$ ${ing.totalCost.toFixed(2)})</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </details>
                    </div>
                </div>
            `).join('');
        }

        function deletePizza(id) {
            showConfirmDialog('Deseja realmente excluir esta pizza?', () => {
                pizzas = pizzas.filter(pizza => pizza.id !== id);
                renderPizzas();
                renderDashboard();
            });
        }

        function editPizza(id) {
            const pizza = pizzas.find(p => p.id === id);
            if (!pizza) return;

            // Fill modal with pizza data
            document.getElementById('editPizzaName').value = pizza.name;
            document.getElementById('editPizzaSize').value = pizza.size;
            document.getElementById('editPizzaType').value = pizza.type || 'salgada';
            document.getElementById('editAdditionalCost').value = pizza.additionalCost;
            document.getElementById('editProfitMargin').value = pizza.profitMargin;
            document.getElementById('editWastePercentage').value = pizza.wastePercentage;

            // Clear existing lists
            document.getElementById('editPizzaPreparations').innerHTML = '';
            document.getElementById('editPizzaIngredients').innerHTML = '';
            editPizzaPreparationsCount = 0;
            editPizzaIngredientsCount = 0;

            // Add preparations
            pizza.preparations.forEach(prep => {
                addEditPizzaPreparation();
                const currentId = editPizzaPreparationsCount - 1;
                document.getElementById(`editPizzaPrepSelect_${currentId}`).value = prep.preparationId;
                document.getElementById(`editPizzaPrepQty_${currentId}`).value = prep.quantity;
            });

            // Add ingredients
            pizza.ingredients.forEach(ing => {
                addEditPizzaIngredient();
                const currentId = editPizzaIngredientsCount - 1;
                document.getElementById(`editPizzaIngSelect_${currentId}`).value = ing.ingredientId;
                document.getElementById(`editPizzaIngQty_${currentId}`).value = ing.quantity;
            });

            // Set editing mode
            editingPizzaId = id;

            // Show modal
            document.getElementById('editPizzaModal').classList.remove('hidden');
            document.getElementById('editPizzaName').focus();
        }

        function addEditPizzaPreparation() {
            if (preparations.length === 0) {
                showAlert('Cadastre prepara√ß√µes primeiro!');
                return;
            }

            const container = document.getElementById('editPizzaPreparations');
            const id = editPizzaPreparationsCount++;

            const div = document.createElement('div');
            div.id = `editPizzaPrep_${id}`;
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-blue-50 dark:bg-gray-100 rounded-lg slide-in border border-blue-200 dark:border-blue-200';
            div.innerHTML = `
                <div>
                    <select id="editPizzaPrepSelect_${id}" class="w-full px-3 py-2 text-base border border-blue-300 dark:border-blue-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                        ${preparations.map(prep => `<option value="${prep.id}">${prep.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <input type="number" id="editPizzaPrepQty_${id}" placeholder="Quantidade" step="0.01" min="0" class="w-full px-3 py-2 text-base border border-blue-300 dark:border-blue-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <button onclick="removeEditPizzaPreparation(${id})" class="w-full px-3 py-2 text-base bg-red-500 text-gray-900 rounded-lg hover:bg-red-600 transition-colors">
                        Remover
                    </button>
                </div>
            `;

            container.appendChild(div);
        }

        function removeEditPizzaPreparation(id) {
            const element = document.getElementById(`editPizzaPrep_${id}`);
            if (element) {
                element.remove();
            }
        }

        function addEditPizzaIngredient() {
            if (ingredients.length === 0) {
                showAlert('Adicione ingredientes b√°sicos primeiro!');
                return;
            }

            const container = document.getElementById('editPizzaIngredients');
            const id = editPizzaIngredientsCount++;

            const div = document.createElement('div');
            div.id = `editPizzaIng_${id}`;
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-50 bg-gray-50 rounded-lg slide-in';
            div.innerHTML = `
                <div>
                    <select id="editPizzaIngSelect_${id}" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                        ${ingredients.map(ing => `<option value="${ing.id}">${ing.name} (${ing.unit})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <input type="number" id="editPizzaIngQty_${id}" placeholder="Quantidade" step="0.01" min="0" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900">
                </div>
                <div>
                    <button onclick="removeEditPizzaIngredient(${id})" class="w-full px-3 py-2 text-base bg-red-500 text-gray-900 rounded-lg hover:bg-red-600 transition-colors">
                        Remover
                    </button>
                </div>
            `;

            container.appendChild(div);
        }

        function removeEditPizzaIngredient(id) {
            const element = document.getElementById(`editPizzaIng_${id}`);
            if (element) {
                element.remove();
            }
        }

        function hideEditPizzaModal() {
            document.getElementById('editPizzaModal').classList.add('hidden');
            editingPizzaId = null;
            editPizzaPreparationsCount = 0;
            editPizzaIngredientsCount = 0;
        }

        function saveEditPizza() {
            const name = document.getElementById('editPizzaName').value.trim();
            const size = document.getElementById('editPizzaSize').value;
            const type = document.getElementById('editPizzaType').value;
            const additionalCost = parseFloat(document.getElementById('editAdditionalCost').value) || 0;
            const profitMargin = parseFloat(document.getElementById('editProfitMargin').value) || 0;
            const wastePercentage = parseFloat(document.getElementById('editWastePercentage').value) || 0;

            if (!name) {
                showAlert('Por favor, insira o nome da pizza');
                return;
            }

            // Get preparations
            const pizzaPreparations = [];
            let preparationsCost = 0;

            for (let i = 0; i < editPizzaPreparationsCount; i++) {
                const selectElement = document.getElementById(`editPizzaPrepSelect_${i}`);
                const qtyElement = document.getElementById(`editPizzaPrepQty_${i}`);

                if (selectElement && qtyElement) {
                    const preparationId = parseInt(selectElement.value);
                    const quantity = parseFloat(qtyElement.value);

                    if (isNaN(quantity) || quantity <= 0) {
                        showAlert('Por favor, insira quantidades v√°lidas para todas as prepara√ß√µes');
                        return;
                    }

                    const preparation = preparations.find(prep => prep.id === preparationId);
                    if (preparation) {
                        const cost = preparation.unitCost * quantity;
                        preparationsCost += cost;

                        pizzaPreparations.push({
                            preparationId,
                            name: preparation.name,
                            quantity,
                            unitCost: preparation.unitCost,
                            totalCost: cost
                        });
                    }
                }
            }

            // Get ingredients
            const pizzaIngredients = [];
            let ingredientsCost = 0;

            for (let i = 0; i < editPizzaIngredientsCount; i++) {
                const selectElement = document.getElementById(`editPizzaIngSelect_${i}`);
                const qtyElement = document.getElementById(`editPizzaIngQty_${i}`);

                if (selectElement && qtyElement) {
                    const ingredientId = parseInt(selectElement.value);
                    const quantity = parseFloat(qtyElement.value);

                    if (isNaN(quantity) || quantity <= 0) {
                        showAlert('Por favor, insira quantidades v√°lidas para todos os ingredientes');
                        return;
                    }

                    const ingredient = ingredients.find(ing => ing.id === ingredientId);
                    if (ingredient) {
                        const cost = ingredient.cost * quantity;
                        ingredientsCost += cost;

                        pizzaIngredients.push({
                            ingredientId,
                            name: ingredient.name,
                            quantity,
                            unit: ingredient.unit,
                            unitCost: ingredient.cost,
                            totalCost: cost
                        });
                    }
                }
            }

            if (pizzaPreparations.length === 0 && pizzaIngredients.length === 0) {
                showAlert('Adicione pelo menos uma prepara√ß√£o ou ingrediente √† pizza');
                return;
            }

            // Calculate pricing
            const baseCost = preparationsCost + ingredientsCost;
            const wasteMultiplier = 1 + (wastePercentage / 100);
            const operationalCost = getOperationalCostForPizza(baseCost);
            const totalCost = (baseCost * wasteMultiplier) + additionalCost + operationalCost;
            const salePrice = totalCost * (1 + profitMargin / 100);
            const profit = salePrice - totalCost;

            // Handle image upload
            const imageInput = document.getElementById('editPizzaImage');

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updatePizza(e.target.result);
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                updatePizza(null);
            }

            function updatePizza(newImageData) {
                // Update pizza
                const pizza = pizzas.find(p => p.id === editingPizzaId);
                if (pizza) {
                    pizza.name = name;
                    pizza.size = size;
                    pizza.type = type;
                    if (newImageData) {
                        pizza.image = newImageData;
                    }
                    pizza.preparations = pizzaPreparations;
                    pizza.ingredients = pizzaIngredients;
                    pizza.preparationsCost = preparationsCost;
                    pizza.ingredientsCost = ingredientsCost;
                    pizza.baseCost = baseCost;
                    pizza.additionalCost = additionalCost;
                    pizza.operationalCost = operationalCost;
                    pizza.wastePercentage = wastePercentage;
                    pizza.totalCost = totalCost;
                    pizza.profitMargin = profitMargin;
                    pizza.salePrice = salePrice;
                    pizza.profit = profit;
                }

                renderPizzas();
                renderDashboard();
                hideEditPizzaModal();

                showAlert('Pizza atualizada com sucesso!');
                setTimeout(() => {
                    hideAlertModal();
                }, 1500);
            }
        }

        // ==================== PLATAFORMAS ====================
        function getPlatformColorClasses(color) {
            const colors = {
                red: { bg: 'bg-red-50 dark:bg-red-900/20', border: 'border-red-200 dark:border-red-800', text: 'text-red-600 dark:text-red-400', badge: 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-400' },
                green: { bg: 'bg-green-50 dark:bg-green-900/20', border: 'border-green-200 dark:border-green-800', text: 'text-green-600 dark:text-green-400', badge: 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400' },
                yellow: { bg: 'bg-yellow-50 dark:bg-yellow-900/20', border: 'border-yellow-200 dark:border-yellow-800', text: 'text-yellow-600 dark:text-yellow-400', badge: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-400' },
                blue: { bg: 'bg-blue-50 dark:bg-gray-100', border: 'border-blue-200 dark:border-blue-200', text: 'text-blue-600 dark:text-blue-400', badge: 'bg-blue-100 text-blue-700 dark:bg-blue-100 dark:text-blue-400' },
                purple: { bg: 'bg-gray-50 bg-white/20', border: 'border-gray-300 border-gray-300', text: 'text-gray-800 text-gray-600', badge: 'bg-gray-100 text-purple-700 bg-gray-50 text-gray-600' },
                orange: { bg: 'bg-orange-50 dark:bg-orange-900/20', border: 'border-orange-200 dark:border-orange-800', text: 'text-orange-600 dark:text-orange-400', badge: 'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-400' },
                pink: { bg: 'bg-gray-50 bg-white/20', border: 'border-gray-300 border-gray-300', text: 'text-gray-800 text-gray-600', badge: 'bg-gray-100 text-pink-700 dark:bg-pink-900/50 text-gray-600' },
                gray: { bg: 'bg-gray-50 bg-gray-100/20', border: 'border-gray-200 dark:border-gray-800', text: 'text-gray-600 text-gray-500', badge: 'bg-gray-100 text-gray-700 bg-gray-100/50 text-gray-500' }
            };
            return colors[color] || colors.blue;
        }

        function calculatePlatformPrice(basePrice, taxPercent) {
            if (taxPercent >= 100) return 0;
            return basePrice / (1 - (taxPercent / 100));
        }

        function addPlatform() {
            const name = document.getElementById('platformName').value.trim();
            const defaultTax = parseFloat(document.getElementById('platformDefaultTax').value);
            const taxMode = document.getElementById('platformTaxMode').value;
            const color = document.getElementById('platformColor').value;

            if (!name) {
                showAlert('Por favor, insira o nome da plataforma');
                return;
            }

            if (isNaN(defaultTax) || defaultTax < 0 || defaultTax >= 100) {
                showAlert('Por favor, insira uma taxa v√°lida entre 0 e 99.99%');
                return;
            }

            platforms.push({
                id: Date.now(),
                name,
                defaultTax,
                taxMode,
                color,
                pizzaTaxes: {} // For variable tax mode: { pizzaId: taxRate }
            });

            renderPlatforms();
            renderDashboard();

            // Clear form
            document.getElementById('platformName').value = '';
            document.getElementById('platformDefaultTax').value = '';
            document.getElementById('platformTaxMode').value = 'unique';
            document.getElementById('platformColor').value = 'red';

            showAlert('Plataforma cadastrada com sucesso!');
            setTimeout(() => {
                hideAlertModal();
            }, 1500);
        }

        function editPlatform(id) {
            const platform = platforms.find(p => p.id === id);
            if (!platform) return;

            document.getElementById('editPlatformName').value = platform.name;
            document.getElementById('editPlatformDefaultTax').value = platform.defaultTax;
            document.getElementById('editPlatformTaxMode').value = platform.taxMode;
            document.getElementById('editPlatformColor').value = platform.color;

            editingPlatformId = id;
            document.getElementById('editPlatformModal').classList.remove('hidden');
            document.getElementById('editPlatformName').focus();
        }

        function hideEditPlatformModal() {
            document.getElementById('editPlatformModal').classList.add('hidden');
            editingPlatformId = null;
        }

        function saveEditPlatform() {
            const name = document.getElementById('editPlatformName').value.trim();
            const defaultTax = parseFloat(document.getElementById('editPlatformDefaultTax').value);
            const taxMode = document.getElementById('editPlatformTaxMode').value;
            const color = document.getElementById('editPlatformColor').value;

            if (!name) {
                showAlert('Por favor, insira o nome da plataforma');
                return;
            }

            if (isNaN(defaultTax) || defaultTax < 0 || defaultTax >= 100) {
                showAlert('Por favor, insira uma taxa v√°lida entre 0 e 99.99%');
                return;
            }

            const platform = platforms.find(p => p.id === editingPlatformId);
            if (platform) {
                platform.name = name;
                platform.defaultTax = defaultTax;
                platform.taxMode = taxMode;
                platform.color = color;
            }

            renderPlatforms();
            renderDashboard();
            hideEditPlatformModal();

            showAlert('Plataforma atualizada com sucesso!');
            setTimeout(() => {
                hideAlertModal();
            }, 1500);
        }

        function deletePlatform(id) {
            showConfirmDialog('Deseja realmente excluir esta plataforma?', () => {
                platforms = platforms.filter(p => p.id !== id);
                renderPlatforms();
                renderDashboard();
            });
        }

        function configureVariableTaxes(platformId) {
            const platform = platforms.find(p => p.id === platformId);
            if (!platform) return;

            if (pizzas.length === 0) {
                showAlert('Nenhuma pizza cadastrada ainda. Cadastre pizzas primeiro.');
                return;
            }

            configuringTaxesPlatformId = platformId;

            // Build the list of pizzas with input fields
            const variableTaxList = document.getElementById('variableTaxList');
            variableTaxList.innerHTML = pizzas.map(pizza => {
                const currentTax = platform.pizzaTaxes[pizza.id] !== undefined ? platform.pizzaTaxes[pizza.id] : '';
                const effectiveTax = platform.pizzaTaxes[pizza.id] || platform.defaultTax;
                const platformPrice = calculatePlatformPrice(pizza.salePrice, effectiveTax);

                return `
                    <div class="p-4 bg-gray-50 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900 text-gray-900">${pizza.name}</p>
                                <p class="text-sm text-gray-500 text-gray-500">Pre√ßo Base: R$ ${pizza.salePrice.toFixed(2)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600 text-gray-500">Pre√ßo na Plataforma:</p>
                                <p class="font-bold text-primary text-lg" id="preview_${pizza.id}">R$ ${platformPrice.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-600 text-gray-500 mb-1">Taxa Personalizada (%) - Padr√£o: ${platform.defaultTax.toFixed(2)}%</label>
                                <input type="number" id="tax_${pizza.id}" data-pizza-id="${pizza.id}" data-base-price="${pizza.salePrice}" value="${currentTax}" placeholder="${platform.defaultTax.toFixed(2)}" step="0.01" min="0" max="99.99" class="w-full px-3 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-gray-900" oninput="updateTaxPreview(${pizza.id}, ${pizza.salePrice}, ${platform.defaultTax})">
                            </div>
                            <button onclick="clearPizzaTax(${pizza.id}, ${pizza.salePrice}, ${platform.defaultTax})" class="mt-5 px-3 py-2 text-sm bg-gray-500 text-gray-900 rounded-lg hover:bg-gray-600 transition-colors" title="Usar taxa padr√£o">
                                Limpar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('variableTaxModal').classList.remove('hidden');
        }

        function updateTaxPreview(pizzaId, basePrice, defaultTax) {
            const taxInput = document.getElementById(`tax_${pizzaId}`);
            const preview = document.getElementById(`preview_${pizzaId}`);

            const taxValue = parseFloat(taxInput.value);
            const effectiveTax = isNaN(taxValue) || taxInput.value.trim() === '' ? defaultTax : taxValue;
            const platformPrice = calculatePlatformPrice(basePrice, effectiveTax);

            preview.textContent = `R$ ${platformPrice.toFixed(2)}`;
        }

        function clearPizzaTax(pizzaId, basePrice, defaultTax) {
            const taxInput = document.getElementById(`tax_${pizzaId}`);
            taxInput.value = '';
            updateTaxPreview(pizzaId, basePrice, defaultTax);
        }

        function hideVariableTaxModal() {
            document.getElementById('variableTaxModal').classList.add('hidden');
            configuringTaxesPlatformId = null;
        }

        function saveVariableTaxes() {
            const platform = platforms.find(p => p.id === configuringTaxesPlatformId);
            if (!platform) return;

            // Update pizza taxes
            platform.pizzaTaxes = {};
            pizzas.forEach(pizza => {
                const taxInput = document.getElementById(`tax_${pizza.id}`);
                const taxValue = parseFloat(taxInput.value);

                // Only save if a custom value was entered
                if (!isNaN(taxValue) && taxInput.value.trim() !== '') {
                    platform.pizzaTaxes[pizza.id] = taxValue;
                }
            });

            renderPlatforms();
            hideVariableTaxModal();

            showAlert('Taxas vari√°veis salvas com sucesso!');
            setTimeout(() => {
                hideAlertModal();
            }, 1500);
        }

        function renderPlatforms() {
            const list = document.getElementById('platformsList');
            const emptyState = document.getElementById('emptyPlatformsState');

            if (platforms.length === 0) {
                list.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            emptyState.classList.add('hidden');

            list.innerHTML = platforms.map(platform => {
                const colorClasses = getPlatformColorClasses(platform.color);

                // Calculate example price with a sample base price of R$50
                const exampleBasePrice = 50;
                const examplePlatformPrice = calculatePlatformPrice(exampleBasePrice, platform.defaultTax);

                return `
                    <div class="bg-white rounded-lg shadow p-5 card-hover border ${colorClasses.border}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 text-gray-900 text-lg mb-1">${platform.name}</h4>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${colorClasses.badge}">
                                    ${platform.taxMode === 'unique' ? 'üìç Taxa √önica' : 'üîÑ Taxa Vari√°vel'}
                                </span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <button onclick="editPlatform(${platform.id})" class="text-blue-500 hover:text-blue-700 p-1" title="Editar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="deletePlatform(${platform.id})" class="text-red-500 hover:text-red-700 p-1" title="Excluir">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-2 mb-4">
                            <div class="flex items-center justify-between p-3 bg-white bg-white rounded-lg">
                                <span class="text-sm font-medium text-gray-600 text-gray-500">Taxa ${platform.taxMode === 'unique' ? '√önica' : 'Padr√£o'}:</span>
                                <span class="text-lg font-bold ${colorClasses.text}">${platform.defaultTax.toFixed(2)}%</span>
                            </div>
                            ${platform.taxMode === 'variable' ? `
                                <button onclick="configureVariableTaxes(${platform.id})" class="w-full p-3 bg-white bg-white rounded-lg hover:bg-gray-100 dark:hover:bg-gray-50 transition-colors border-2 border-dashed border-gray-300 border-gray-300">
                                    <div class="flex items-center justify-center space-x-2 ${colorClasses.text}">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <span class="font-medium">Configurar Taxas por Pizza</span>
                                    </div>
                                    ${Object.keys(platform.pizzaTaxes).length > 0 ? `<p class="text-xs mt-1">${Object.keys(platform.pizzaTaxes).length} pizza(s) com taxa personalizada</p>` : ''}
                                </button>
                            ` : `
                                <div class="p-3 bg-white bg-white rounded-lg">
                                    <p class="text-xs text-gray-500 text-gray-500 mb-1">Exemplo de c√°lculo:</p>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-600 text-gray-500">Pre√ßo Base: R$ ${exampleBasePrice.toFixed(2)}</span>
                                        <span class="text-gray-400">‚Üí</span>
                                        <span class="font-bold ${colorClasses.text}">Plataforma: R$ ${examplePlatformPrice.toFixed(2)}</span>
                                    </div>
                                </div>
                            `}
                        </div>

                        ${pizzas.length > 0 ? `
                            <details class="text-sm">
                                <summary class="cursor-pointer ${colorClasses.text} font-medium hover:opacity-80">ÔøΩÔøΩÔøΩÔøΩ Ver Pre√ßos das Pizzas (${pizzas.length})</summary>
                                <div class="mt-3 space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                    ${pizzas.map(pizza => {
                                        const tax = platform.pizzaTaxes[pizza.id] || platform.defaultTax;
                                        const platformPrice = calculatePlatformPrice(pizza.salePrice, tax);
                                        return `
                                            <div class="p-2 bg-white bg-white rounded flex items-center justify-between">
                                                <div class="flex-1">
                                                    <p class="font-medium text-gray-900 text-gray-900 text-xs">${pizza.name}</p>
                                                    <p class="text-xs text-gray-500 text-gray-500">Base: R$ ${pizza.salePrice.toFixed(2)}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="font-bold ${colorClasses.text} text-sm">R$ ${platformPrice.toFixed(2)}</p>
                                                    <p class="text-xs text-gray-500 text-gray-500">Taxa: ${tax.toFixed(1)}%</p>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </details>
                        ` : '<p class="text-xs text-gray-500 text-gray-500 italic">Nenhuma pizza cadastrada ainda</p>'}
                    </div>
                `;
            }).join('');
        }

        // ==================== IMPORT/EXPORT ====================
        function exportProject() {
            if (suppliers.length === 0 && ingredients.length === 0 && preparations.length === 0 && pizzas.length === 0 && platforms.length === 0 && managementData.length === 0) {
                showAlert('N√£o h√° dados para exportar! Adicione fornecedores, ingredientes, prepara√ß√µes, pizzas, plataformas ou dados gerenciais primeiro.');
                return;
            }

            const projectData = {
                version: '4.0',
                exportDate: new Date().toISOString(),
                data: {
                    suppliers,
                    ingredients,
                    preparations,
                    pizzas,
                    platforms,
                    operationalCosts,
                    managementData
                }
            };

            const jsonString = JSON.stringify(projectData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `precificacao-pizzas-${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showAlert('Projeto exportado com sucesso!');
            setTimeout(() => {
                hideAlertModal();
            }, 1500);

            // Also sync to Drive if logged in
            if (isLoggedIn) DriveSync.saveToDrive();
        }

        function triggerImport() {
            document.getElementById('importFileInput').click();
        }

        function importProject(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);

                    // Validate data structure
                    if (!projectData.data || !projectData.version) {
                        showAlert('Arquivo inv√°lido! O formato do arquivo n√£o √© reconhecido.');
                        return;
                    }

                    // Validate arrays
                    const { suppliers: impSuppliers, ingredients: impIngredients, preparations: impPreparations, pizzas: impPizzas, platforms: impPlatforms, operationalCosts: impOperationalCosts, managementData: impManagementData } = projectData.data;

                    // Support for older versions without suppliers, platforms, operationalCosts or managementData
                    const suppliersArray = impSuppliers || [];
                    const platformsArray = impPlatforms || [];
                    const managementDataArray = impManagementData || [];
                    const operationalCostsData = impOperationalCosts || {
                        method: null,
                        estimatedMonthlyProduction: 500,
                        percentage: 30,
                        rent: 0,
                        electricity: 0,
                        water: 0,
                        gas: 0,
                        salaries: 0,
                        internet: 0,
                        cleaning: 0,
                        marketing: 0,
                        bankFees: 0,
                        taxes: 0,
                        others: 0
                    };

                    if (!Array.isArray(impIngredients) || !Array.isArray(impPreparations) || !Array.isArray(impPizzas)) {
                        showAlert('Arquivo inv√°lido! Estrutura de dados incorreta.');
                        return;
                    }

                    // Show confirmation dialog
                    const totalItems = suppliersArray.length + impIngredients.length + impPreparations.length + impPizzas.length + platformsArray.length + managementDataArray.length;

                    showConfirmDialog(
                        `Deseja importar este projeto?\n\n` +
                        `${suppliersArray.length} fornecedor(es)\n` +
                        `${impIngredients.length} ingrediente(s)\n` +
                        `${impPreparations.length} prepara√ß√£o(√µes)\n` +
                        `${impPizzas.length} pizza(s)\n` +
                        `${platformsArray.length} plataforma(s)\n` +
                        `${managementDataArray.length} registro(s) gerencial(is)\n\n` +
                        `ATEN√á√ÉO: Isso substituir√° todos os dados atuais!`,
                        () => {
                            // Import data
                            suppliers = suppliersArray;
                            ingredients = impIngredients;
                            preparations = impPreparations;

                            // Normalizar pizzas: se n√£o tem type definido, assume 'salgada' como padr√£o
                            pizzas = impPizzas.map(pizza => {
                                if (!pizza.type) {
                                    pizza.type = 'salgada';
                                }
                                return pizza;
                            });

                            platforms = platformsArray;

                            // Import operational costs
                            operationalCosts = operationalCostsData;

                            // Import management data
                            managementData = managementDataArray;

                            // Recalcular todas as pizzas com os custos operacionais importados
                            recalculateAllPizzas();

                            // Reset counters
                            preparationIngredientsCount = 0;
                            pizzaPreparationsCount = 0;
                            pizzaIngredientsCount = 0;

                            // Render all
                            renderSuppliers();
                            renderIngredients();
                            renderPreparations();
                            renderPizzas();
                            renderOperationalCosts();
                            renderPlatforms();
                            renderManagementData();
                            renderDashboard();

                            // Clear forms
                            document.getElementById('preparationIngredients').innerHTML = '';
                            document.getElementById('pizzaPreparations').innerHTML = '';
                            document.getElementById('pizzaIngredients').innerHTML = '';

                            showAlert(`Projeto importado com sucesso!\n\n${totalItems} itens carregados.`);
                            setTimeout(() => {
                                hideAlertModal();
                            }, 2000);
                        }
                    );

                } catch (error) {
                    showAlert('Erro ao importar arquivo! Verifique se o arquivo √© v√°lido.');
                }
            };

            reader.onerror = function() {
                showAlert('Erro ao ler o arquivo!');
            };

            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // ==================== CUSTOS OPERACIONAIS ====================
        function updateCostMethod() {
            const fixedRadio = document.getElementById('costMethodFixed');
            const percentageRadio = document.getElementById('costMethodPercentage');
            const fixedConfig = document.getElementById('fixedMethodConfig');
            const percentageConfig = document.getElementById('percentageMethodConfig');

            if (fixedRadio.checked) {
                operationalCosts.method = 'fixed';
                fixedConfig.classList.remove('hidden');
                percentageConfig.classList.add('hidden');
            } else if (percentageRadio.checked) {
                operationalCosts.method = 'percentage';
                fixedConfig.classList.add('hidden');
                percentageConfig.classList.remove('hidden');
            }

            calculateOperationalCosts();
            renderPizzas(); // Recalculate all pizzas
        }

        function calculateOperationalCosts() {
            // Get all cost values
            operationalCosts.rent = parseFloat(document.getElementById('costRent')?.value || 0);
            operationalCosts.electricity = parseFloat(document.getElementById('costElectricity')?.value || 0);
            operationalCosts.water = parseFloat(document.getElementById('costWater')?.value || 0);
            operationalCosts.gas = parseFloat(document.getElementById('costGas')?.value || 0);
            operationalCosts.salaries = parseFloat(document.getElementById('costSalaries')?.value || 0);
            operationalCosts.internet = parseFloat(document.getElementById('costInternet')?.value || 0);
            operationalCosts.cleaning = parseFloat(document.getElementById('costCleaning')?.value || 0);
            operationalCosts.marketing = parseFloat(document.getElementById('costMarketing')?.value || 0);
            operationalCosts.bankFees = parseFloat(document.getElementById('costBankFees')?.value || 0);
            operationalCosts.taxes = parseFloat(document.getElementById('costTaxes')?.value || 0);
            operationalCosts.others = parseFloat(document.getElementById('costOthers')?.value || 0);

            // Get method-specific values
            operationalCosts.estimatedMonthlyProduction = parseInt(document.getElementById('estimatedMonthlyProduction')?.value || 500);
            operationalCosts.percentage = parseFloat(document.getElementById('operationalCostPercentage')?.value || 30);

            // Calculate total monthly cost
            const totalMonthlyCost = operationalCosts.rent + operationalCosts.electricity +
                operationalCosts.water + operationalCosts.gas + operationalCosts.salaries +
                operationalCosts.internet + operationalCosts.cleaning + operationalCosts.marketing +
                operationalCosts.bankFees + operationalCosts.taxes + operationalCosts.others;

            // Update display
            if (document.getElementById('totalMonthlyCost')) {
                document.getElementById('totalMonthlyCost').textContent = `R$ ${totalMonthlyCost.toFixed(2).replace('.', ',')}`;
            }

            // Calculate cost per pizza based on method
            let costPerPizza = 0;
            let methodText = 'Nenhum';

            if (operationalCosts.method === 'fixed' && operationalCosts.estimatedMonthlyProduction > 0) {
                costPerPizza = totalMonthlyCost / operationalCosts.estimatedMonthlyProduction;
                methodText = 'Fixo por Pizza';
                if (document.getElementById('costPerPizza')) {
                    document.getElementById('costPerPizza').textContent = `R$ ${costPerPizza.toFixed(2).replace('.', ',')}`;
                }
            } else if (operationalCosts.method === 'percentage') {
                methodText = `${operationalCosts.percentage}% sobre CMV`;
                if (document.getElementById('costPerPizza')) {
                    document.getElementById('costPerPizza').textContent = `${operationalCosts.percentage}%`;
                }
            } else {
                if (document.getElementById('costPerPizza')) {
                    document.getElementById('costPerPizza').textContent = 'R$ 0,00';
                }
            }

            if (document.getElementById('currentMethod')) {
                document.getElementById('currentMethod').textContent = methodText;
            }

            // Update pizzas with new costs
            recalculateAllPizzas();
            renderPizzas();
            renderDashboard();
        }

        function recalculateAllPizzas() {
            // Recalcular todas as pizzas existentes com os novos custos operacionais
            pizzas.forEach(pizza => {
                const baseCost = pizza.baseCost;
                const wasteMultiplier = 1 + (pizza.wastePercentage / 100);
                const operationalCost = getOperationalCostForPizza(baseCost);
                const totalCost = (baseCost * wasteMultiplier) + pizza.additionalCost + operationalCost;
                const salePrice = totalCost * (1 + pizza.profitMargin / 100);
                const profit = salePrice - totalCost;

                // Atualizar os valores na pizza
                pizza.operationalCost = operationalCost;
                pizza.totalCost = totalCost;
                pizza.salePrice = salePrice;
                pizza.profit = profit;
            });
        }

        function getOperationalCostForPizza(baseCost) {
            if (!operationalCosts.method) return 0;

            if (operationalCosts.method === 'fixed') {
                const totalMonthlyCost = operationalCosts.rent + operationalCosts.electricity +
                    operationalCosts.water + operationalCosts.gas + operationalCosts.salaries +
                    operationalCosts.internet + operationalCosts.cleaning + operationalCosts.marketing +
                    operationalCosts.bankFees + operationalCosts.taxes + operationalCosts.others;

                if (operationalCosts.estimatedMonthlyProduction > 0) {
                    return totalMonthlyCost / operationalCosts.estimatedMonthlyProduction;
                }
                return 0;
            } else if (operationalCosts.method === 'percentage') {
                return baseCost * (operationalCosts.percentage / 100);
            }

            return 0;
        }

        function renderOperationalCosts() {
            // Set radio buttons
            if (operationalCosts.method === 'fixed') {
                document.getElementById('costMethodFixed').checked = true;
                document.getElementById('fixedMethodConfig').classList.remove('hidden');
                document.getElementById('percentageMethodConfig').classList.add('hidden');
            } else if (operationalCosts.method === 'percentage') {
                document.getElementById('costMethodPercentage').checked = true;
                document.getElementById('fixedMethodConfig').classList.add('hidden');
                document.getElementById('percentageMethodConfig').classList.remove('hidden');
            } else {
                document.getElementById('fixedMethodConfig').classList.add('hidden');
                document.getElementById('percentageMethodConfig').classList.add('hidden');
            }

            // Set cost values
            document.getElementById('costRent').value = operationalCosts.rent;
            document.getElementById('costElectricity').value = operationalCosts.electricity;
            document.getElementById('costWater').value = operationalCosts.water;
            document.getElementById('costGas').value = operationalCosts.gas;
            document.getElementById('costSalaries').value = operationalCosts.salaries;
            document.getElementById('costInternet').value = operationalCosts.internet;
            document.getElementById('costCleaning').value = operationalCosts.cleaning;
            document.getElementById('costMarketing').value = operationalCosts.marketing;
            document.getElementById('costBankFees').value = operationalCosts.bankFees;
            document.getElementById('costTaxes').value = operationalCosts.taxes;
            document.getElementById('costOthers').value = operationalCosts.others;
            document.getElementById('estimatedMonthlyProduction').value = operationalCosts.estimatedMonthlyProduction;
            document.getElementById('operationalCostPercentage').value = operationalCosts.percentage;

            calculateOperationalCosts();
        }

        // ==================== √ÅREA GERENCIAL ====================
        function getMonthName(month) {
            const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return months[month - 1] || '';
        }

        function getMonthShortName(month) {
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                           'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            return months[month - 1] || '';
        }

        function addSalesRecord() {
            const month = parseInt(document.getElementById('salesMonth').value);
            const year = parseInt(document.getElementById('salesYear').value);
            const orders = parseInt(document.getElementById('salesOrders').value);
            const goal = parseInt(document.getElementById('salesGoal').value) || 0;
            const revenue = parseFloat(document.getElementById('salesRevenue').value);
            const pizzasSold = parseInt(document.getElementById('salesPizzas').value);
            const notes = document.getElementById('salesNotes').value.trim();

            // Validation
            if (!year || isNaN(year) || year < 2020 || year > 2100) {
                showAlert('Por favor, informe um ano v√°lido (2020-2100).');
                return;
            }
            if (isNaN(orders) || orders < 0) {
                showAlert('Por favor, informe a quantidade de pedidos.');
                return;
            }
            if (isNaN(revenue) || revenue < 0) {
                showAlert('Por favor, informe o faturamento.');
                return;
            }
            if (isNaN(pizzasSold) || pizzasSold < 0) {
                showAlert('Por favor, informe a quantidade de pizzas vendidas.');
                return;
            }

            // Check for duplicate month/year
            const exists = managementData.find(r => r.month === month && r.year === year);
            if (exists) {
                showConfirmDialog(
                    `J√° existe um registro para ${getMonthName(month)}/${year}. Deseja substituir?`,
                    () => {
                        // Remove existing and add new
                        managementData = managementData.filter(r => !(r.month === month && r.year === year));
                        saveNewRecord();
                    }
                );
                return;
            }

            saveNewRecord();

            function saveNewRecord() {
                const record = {
                    id: Date.now(),
                    month,
                    year,
                    orders,
                    goal,
                    revenue,
                    pizzasSold,
                    notes,
                    createdAt: new Date().toISOString()
                };

                managementData.push(record);
                managementData.sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    return b.month - a.month;
                });

                // Clear form
                document.getElementById('salesOrders').value = '';
                document.getElementById('salesGoal').value = '';
                document.getElementById('salesRevenue').value = '';
                document.getElementById('salesPizzas').value = '';
                document.getElementById('salesNotes').value = '';

                renderManagementData();
                showAlert(`Registro de ${getMonthName(month)}/${year} adicionado com sucesso!`);
            }
        }

        function deleteSalesRecord(id) {
            const record = managementData.find(r => r.id === id);
            if (!record) return;

            showConfirmDialog(
                `Deseja excluir o registro de ${getMonthName(record.month)}/${record.year}?`,
                () => {
                    managementData = managementData.filter(r => r.id !== id);
                    renderManagementData();
                }
            );
        }

        function getFilteredData() {
            const yearFilter = document.getElementById('filterYear')?.value || 'all';
            const periodFilter = document.getElementById('filterPeriod')?.value || 'all';

            let filtered = [...managementData];

            // Filter by year
            if (yearFilter !== 'all') {
                filtered = filtered.filter(r => r.year === parseInt(yearFilter));
            }

            // Filter by period
            if (periodFilter !== 'all') {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;

                if (periodFilter === 'last3') {
                    filtered = filtered.filter(r => {
                        const monthsAgo = (currentYear - r.year) * 12 + (currentMonth - r.month);
                        return monthsAgo >= 0 && monthsAgo < 3;
                    });
                } else if (periodFilter === 'last6') {
                    filtered = filtered.filter(r => {
                        const monthsAgo = (currentYear - r.year) * 12 + (currentMonth - r.month);
                        return monthsAgo >= 0 && monthsAgo < 6;
                    });
                } else if (periodFilter === 'last12') {
                    filtered = filtered.filter(r => {
                        const monthsAgo = (currentYear - r.year) * 12 + (currentMonth - r.month);
                        return monthsAgo >= 0 && monthsAgo < 12;
                    });
                } else if (periodFilter === 'q1') {
                    filtered = filtered.filter(r => r.month >= 1 && r.month <= 3);
                } else if (periodFilter === 'q2') {
                    filtered = filtered.filter(r => r.month >= 4 && r.month <= 6);
                } else if (periodFilter === 'q3') {
                    filtered = filtered.filter(r => r.month >= 7 && r.month <= 9);
                } else if (periodFilter === 'q4') {
                    filtered = filtered.filter(r => r.month >= 10 && r.month <= 12);
                }
            }

            return filtered.sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.month - b.month;
            });
        }

        function updateYearFilter() {
            const yearSelect = document.getElementById('filterYear');
            if (!yearSelect) return;

            const years = [...new Set(managementData.map(r => r.year))].sort((a, b) => b - a);
            const currentValue = yearSelect.value;

            yearSelect.innerHTML = '<option value="all">Todos</option>';
            years.forEach(year => {
                yearSelect.innerHTML += `<option value="${year}" ${currentValue == year ? 'selected' : ''}>${year}</option>`;
            });
        }

        function renderManagementData() {
            const filteredData = getFilteredData();

            // Set default year
            const yearInput = document.getElementById('salesYear');
            if (yearInput && !yearInput.value) {
                yearInput.value = new Date().getFullYear();
            }

            // Set default month
            const monthInput = document.getElementById('salesMonth');
            if (monthInput) {
                monthInput.value = new Date().getMonth() + 1;
            }

            // Update year filter options
            updateYearFilter();

            // Calculate KPIs
            const totalRevenue = filteredData.reduce((sum, r) => sum + r.revenue, 0);
            const totalOrders = filteredData.reduce((sum, r) => sum + r.orders, 0);
            const totalPizzasSold = filteredData.reduce((sum, r) => sum + r.pizzasSold, 0);
            const recordsWithGoal = filteredData.filter(r => r.goal > 0);
            const avgGoalAchievement = recordsWithGoal.length > 0
                ? recordsWithGoal.reduce((sum, r) => sum + (r.orders / r.goal * 100), 0) / recordsWithGoal.length
                : 0;
            const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;

            // Update KPI cards
            document.getElementById('kpi-total-revenue').textContent = `R$ ${totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('kpi-total-orders').textContent = totalOrders.toLocaleString('pt-BR');
            document.getElementById('kpi-avg-goal').textContent = `${avgGoalAchievement.toFixed(1)}%`;
            document.getElementById('kpi-avg-ticket').textContent = `R$ ${avgTicket.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

            // Profitability Analysis
            const avgPizzaCost = pizzas.length > 0
                ? pizzas.reduce((sum, p) => sum + p.totalCost, 0) / pizzas.length
                : 0;
            const estimatedCMV = avgPizzaCost * totalPizzasSold;
            const grossProfit = totalRevenue - estimatedCMV;
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;

            document.getElementById('profit-total-revenue').textContent = `R$ ${totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('profit-cmv-estimate').textContent = `R$ ${estimatedCMV.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('profit-gross-profit').textContent = `R$ ${grossProfit.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('profit-margin').textContent = `${grossMargin.toFixed(1)}%`;

            // Best/Worst month
            if (filteredData.length > 0) {
                const sortedByRevenue = [...filteredData].sort((a, b) => b.revenue - a.revenue);
                const best = sortedByRevenue[0];
                const worst = sortedByRevenue[sortedByRevenue.length - 1];

                document.getElementById('best-month-info').innerHTML = `
                    <p class="text-2xl font-bold text-green-600 dark:text-green-400">${getMonthName(best.month)}/${best.year}</p>
                    <p class="text-lg font-semibold text-gray-700 text-gray-600 mt-2">R$ ${best.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                    <p class="text-sm text-gray-500 text-gray-500 mt-1">${best.orders} pedidos | ${best.pizzasSold} pizzas</p>
                    ${best.notes ? `<p class="text-xs text-gray-400 dark:text-gray-500 mt-2 italic">"${best.notes}"</p>` : ''}
                `;

                document.getElementById('worst-month-info').innerHTML = `
                    <p class="text-2xl font-bold text-red-600 dark:text-red-400">${getMonthName(worst.month)}/${worst.year}</p>
                    <p class="text-lg font-semibold text-gray-700 text-gray-600 mt-2">R$ ${worst.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                    <p class="text-sm text-gray-500 text-gray-500 mt-1">${worst.orders} pedidos | ${worst.pizzasSold} pizzas</p>
                    ${worst.notes ? `<p class="text-xs text-gray-400 dark:text-gray-500 mt-2 italic">"${worst.notes}"</p>` : ''}
                `;
            } else {
                document.getElementById('best-month-info').innerHTML = '<p class="text-sm">Nenhum dado dispon√≠vel</p>';
                document.getElementById('worst-month-info').innerHTML = '<p class="text-sm">Nenhum dado dispon√≠vel</p>';
            }

            // Annual Projection
            const currentYear = new Date().getFullYear();
            const currentYearData = managementData.filter(r => r.year === currentYear);
            const monthsWithData = currentYearData.length;

            if (monthsWithData > 0) {
                const avgMonthlyRevenue = currentYearData.reduce((sum, r) => sum + r.revenue, 0) / monthsWithData;
                const avgMonthlyOrders = currentYearData.reduce((sum, r) => sum + r.orders, 0) / monthsWithData;
                const avgMonthlyPizzas = currentYearData.reduce((sum, r) => sum + r.pizzasSold, 0) / monthsWithData;

                document.getElementById('projection-months').textContent = `${monthsWithData}/12`;
                document.getElementById('projection-revenue').textContent = `R$ ${(avgMonthlyRevenue * 12).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                document.getElementById('projection-orders').textContent = Math.round(avgMonthlyOrders * 12).toLocaleString('pt-BR');
                document.getElementById('projection-pizzas').textContent = Math.round(avgMonthlyPizzas * 12).toLocaleString('pt-BR');
            } else {
                document.getElementById('projection-months').textContent = '0/12';
                document.getElementById('projection-revenue').textContent = 'R$ 0,00';
                document.getElementById('projection-orders').textContent = '0';
                document.getElementById('projection-pizzas').textContent = '0';
            }

            // Render table
            const tableBody = document.getElementById('sales-table-body');
            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-8 text-center text-gray-500 text-gray-500">
                            Nenhum registro de vendas cadastrado
                        </td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = filteredData.map(record => {
                    const goalIndex = record.goal > 0 ? ((record.orders / record.goal) * 100) : 0;
                    const ticket = record.orders > 0 ? record.revenue / record.orders : 0;
                    const pizzasPerOrder = record.orders > 0 ? record.pizzasSold / record.orders : 0;

                    // Goal index color
                    let goalClass = 'text-gray-600 text-gray-500';
                    if (record.goal > 0) {
                        if (goalIndex >= 100) goalClass = 'text-green-600 dark:text-green-400 font-bold';
                        else if (goalIndex >= 80) goalClass = 'text-yellow-600 dark:text-yellow-400';
                        else goalClass = 'text-red-600 dark:text-red-400';
                    }

                    return `
                        <tr class="border-b border-gray-100 border-gray-200 hover:bg-gray-50 dark:hover:bg-gray-50/50 transition-colors">
                            <td class="py-3 px-4">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-gray-900 text-gray-900">${getMonthName(record.month)}/${record.year}</span>
                                    ${record.notes ? `<span class="text-xs text-gray-400" title="${record.notes}">üìù</span>` : ''}
                                </div>
                            </td>
                            <td class="py-3 px-4 text-right font-semibold text-gray-900 text-gray-900">${record.orders.toLocaleString('pt-BR')}</td>
                            <td class="py-3 px-4 text-right text-gray-600 text-gray-500">${record.goal > 0 ? record.goal.toLocaleString('pt-BR') : '-'}</td>
                            <td class="py-3 px-4 text-right ${goalClass}">${record.goal > 0 ? `${goalIndex.toFixed(1)}%` : '-'}</td>
                            <td class="py-3 px-4 text-right font-semibold text-green-600 dark:text-green-400">R$ ${record.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                            <td class="py-3 px-4 text-right text-gray-600 text-gray-500">${record.pizzasSold.toLocaleString('pt-BR')}</td>
                            <td class="py-3 px-4 text-right text-gray-600 text-gray-500">R$ ${ticket.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                            <td class="py-3 px-4 text-right text-gray-600 text-gray-500">${pizzasPerOrder.toFixed(2)}</td>
                            <td class="py-3 px-4 text-center">
                                <button onclick="deleteSalesRecord(${record.id})" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1" title="Excluir">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Render charts
            renderManagementCharts(filteredData);
        }

        function renderManagementCharts(data) {
            const chartOrdersGoal = document.getElementById('chart-orders-goal');
            const chartRevenue = document.getElementById('chart-revenue');

            if (data.length === 0) {
                chartOrdersGoal.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500 text-gray-500">
                        <p>Adicione registros de vendas para ver o gr√°fico</p>
                    </div>
                `;
                chartRevenue.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500 text-gray-500">
                        <p>Adicione registros de vendas para ver o gr√°fico</p>
                    </div>
                `;
                return;
            }

            const labels = data.map(r => `${getMonthShortName(r.month)}/${r.year.toString().slice(-2)}`);
            const ordersData = data.map(r => r.orders);
            const goalsData = data.map(r => r.goal || 0);
            const pizzasData = data.map(r => r.pizzasSold);
            const revenueData = data.map(r => r.revenue);

            const maxOrders = Math.max(...ordersData, ...goalsData, ...pizzasData);
            const maxRevenue = Math.max(...revenueData);

            // Simple bar chart for orders vs goal vs pizzas
            const barWidth = Math.max(15, Math.min(40, (chartOrdersGoal.clientWidth - 80) / (data.length * 3) - 4));
            const chartHeight = 200;
            const padding = 40;

            chartOrdersGoal.innerHTML = `
                <svg viewBox="0 0 ${data.length * barWidth * 3 + padding * 2 + 40} ${chartHeight + padding * 2}" class="w-full h-full" style="background-color: white;">
                    <!-- Y axis -->
                    <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${chartHeight + padding}" stroke="currentColor" stroke-opacity="0.2" />

                    <!-- X axis -->
                    <line x1="${padding}" y1="${chartHeight + padding}" x2="${data.length * barWidth * 3 + padding + 40}" y2="${chartHeight + padding}" stroke="currentColor" stroke-opacity="0.2" />

                    <!-- Bars -->
                    ${data.map((r, i) => {
                        const x = padding + i * barWidth * 3 + 20;
                        const ordersHeight = maxOrders > 0 ? (r.orders / maxOrders) * chartHeight : 0;
                        const goalsHeight = maxOrders > 0 ? ((r.goal || 0) / maxOrders) * chartHeight : 0;
                        const pizzasHeight = maxOrders > 0 ? (r.pizzasSold / maxOrders) * chartHeight : 0;

                        return `
                            <!-- Orders bar -->
                            <rect x="${x}" y="${chartHeight + padding - ordersHeight}" width="${barWidth - 2}" height="${ordersHeight}" fill="#3b82f6" rx="2">
                                <title>Pedidos: ${r.orders}</title>
                            </rect>
                            <!-- Goals bar -->
                            <rect x="${x + barWidth}" y="${chartHeight + padding - goalsHeight}" width="${barWidth - 2}" height="${goalsHeight}" fill="#a855f7" rx="2" opacity="0.7">
                                <title>Meta: ${r.goal || 0}</title>
                            </rect>
                            <!-- Pizzas bar -->
                            <rect x="${x + barWidth * 2}" y="${chartHeight + padding - pizzasHeight}" width="${barWidth - 2}" height="${pizzasHeight}" fill="#f97316" rx="2">
                                <title>Pizzas: ${r.pizzasSold}</title>
                            </rect>
                            <!-- Label -->
                            <text x="${x + barWidth * 1.5}" y="${chartHeight + padding + 15}" text-anchor="middle" class="text-xs fill-current text-gray-500 text-gray-500" style="font-size: 10px">${getMonthShortName(r.month)}</text>
                        `;
                    }).join('')}
                </svg>
                <div class="flex justify-center gap-4 mt-2 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-500 rounded"></span> Pedidos</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-gray-500 rounded opacity-70"></span> Meta</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-500 rounded"></span> Pizzas</span>
                </div>
            `;

            // Line chart for revenue
            const lineChartWidth = chartRevenue.clientWidth - padding * 2 || 400;
            const pointSpacing = data.length > 1 ? lineChartWidth / (data.length - 1) : lineChartWidth;

            const revenuePoints = data.map((r, i) => {
                const x = padding + i * pointSpacing;
                const y = chartHeight + padding - (maxRevenue > 0 ? (r.revenue / maxRevenue) * chartHeight : 0);
                return { x, y, value: r.revenue };
            });

            const linePath = revenuePoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
            const areaPath = `${linePath} L ${revenuePoints[revenuePoints.length - 1].x} ${chartHeight + padding} L ${padding} ${chartHeight + padding} Z`;

            chartRevenue.innerHTML = `
                <svg viewBox="0 0 ${lineChartWidth + padding * 2} ${chartHeight + padding * 2}" class="w-full h-full" style="background-color: white;">
                    <!-- Grid lines -->
                    ${[0, 25, 50, 75, 100].map(pct => {
                        const y = chartHeight + padding - (chartHeight * pct / 100);
                        return `<line x1="${padding}" y1="${y}" x2="${lineChartWidth + padding}" y2="${y}" stroke="currentColor" stroke-opacity="0.1" stroke-dasharray="4" />`;
                    }).join('')}

                    <!-- Area fill -->
                    <path d="${areaPath}" fill="url(#revenueGradient)" />

                    <!-- Line -->
                    <path d="${linePath}" fill="none" stroke="#10b981" stroke-width="2" />

                    <!-- Points -->
                    ${revenuePoints.map((p, i) => `
                        <circle cx="${p.x}" cy="${p.y}" r="4" fill="#10b981" stroke="white" stroke-width="2">
                            <title>${getMonthName(data[i].month)}/${data[i].year}: R$ ${p.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</title>
                        </circle>
                    `).join('')}

                    <!-- X Labels -->
                    ${data.map((r, i) => `
                        <text x="${padding + i * pointSpacing}" y="${chartHeight + padding + 15}" text-anchor="middle" class="fill-current text-gray-500 text-gray-500" style="font-size: 10px">${getMonthShortName(r.month)}</text>
                    `).join('')}

                    <!-- Gradient definition -->
                    <defs>
                        <linearGradient id="revenueGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="#10b981" stop-opacity="0.3" />
                            <stop offset="100%" stop-color="#10b981" stop-opacity="0.05" />
                        </linearGradient>
                    </defs>
                </svg>
                <div class="flex justify-center gap-4 mt-2 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-500 rounded-full"></span> Faturamento</span>
                </div>
            `;
        }

        function printManagementReport() {
            const filteredData = getFilteredData();

            if (filteredData.length === 0) {
                showAlert('Nenhum registro para imprimir. Adicione registros de vendas primeiro.');
                return;
            }

            // Calculate totals
            const totalRevenue = filteredData.reduce((sum, r) => sum + r.revenue, 0);
            const totalOrders = filteredData.reduce((sum, r) => sum + r.orders, 0);
            const totalPizzas = filteredData.reduce((sum, r) => sum + r.pizzasSold, 0);
            const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;

            const printContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Relat√≥rio Gerencial - Pizzaria</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; padding: 30px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1a1a1a; padding-bottom: 15px; }
                        .header h1 { font-size: 28px; color: #1a1a1a; margin-bottom: 5px; }
                        .header p { color: #666; font-size: 12px; }
                        .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
                        .kpi { background: #f9fafb; padding: 15px; border-radius: 8px; text-align: center; }
                        .kpi-label { font-size: 12px; color: #666; margin-bottom: 5px; }
                        .kpi-value { font-size: 20px; font-weight: bold; color: #1a1a1a; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb; }
                        th { background: #f3f4f6; font-weight: 600; text-align: left; }
                        th:first-child, td:first-child { text-align: left; }
                        .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #e5e7eb; color: #999; font-size: 11px; }
                        @media print { body { padding: 20px; } }
                    
        /* Sidebar Navigation */
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item.active {
            background-color: #374151;
            border-left: 3px solid #f59e0b;
        }
        
        .nav-item:not(.active) {
            border-left: 3px solid transparent;
        }
        
        /* Hide tab buttons since we use sidebar */
        .tab-button {
            display: none;
        }
        
        /* Cream accent for inputs */
        input:focus, select:focus, textarea:focus {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
        }
    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìà Relat√≥rio Gerencial</h1>
                        <p>Gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
                    </div>

                    <div class="kpis">
                        <div class="kpi">
                            <div class="kpi-label">üí∞ Faturamento Total</div>
                            <div class="kpi-value">R$ ${totalRevenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">üì¶ Total de Pedidos</div>
                            <div class="kpi-value">${totalOrders.toLocaleString('pt-BR')}</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">üçï Pizzas Vendidas</div>
                            <div class="kpi-value">${totalPizzas.toLocaleString('pt-BR')}</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">üßæ Ticket M√©dio</div>
                            <div class="kpi-value">R$ ${avgTicket.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>

                    <h2 style="font-size: 18px; color: #333; margin-bottom: 10px;">üìä Detalhamento por Per√≠odo</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>M√™s/Ano</th>
                                <th>Pedidos</th>
                                <th>Meta</th>
                                <th>√çndice %</th>
                                <th>Faturamento</th>
                                <th>Pizzas</th>
                                <th>Ticket M√©dio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredData.map(r => {
                                const goalIndex = r.goal > 0 ? ((r.orders / r.goal) * 100).toFixed(1) + '%' : '-';
                                const ticket = r.orders > 0 ? r.revenue / r.orders : 0;
                                return `
                                    <tr>
                                        <td>${getMonthName(r.month)}/${r.year}</td>
                                        <td>${r.orders.toLocaleString('pt-BR')}</td>
                                        <td>${r.goal > 0 ? r.goal.toLocaleString('pt-BR') : '-'}</td>
                                        <td>${goalIndex}</td>
                                        <td>R$ ${r.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                        <td>${r.pizzasSold.toLocaleString('pt-BR')}</td>
                                        <td>R$ ${ticket.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div class="footer">
                        Relat√≥rio gerado pelo Sistema de Precifica√ß√£o de Pizzas
                    </div>
                
    <!-- Modal de Visualiza√ß√£o de Imagem -->
    <div id="imageViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" onclick="closeImageViewer()">
        <div class="relative max-w-4xl max-h-full">
            <button onclick="closeImageViewer()" class="absolute -top-10 right-0 text-gray-900 text-3xl hover:text-gray-300">&times;</button>
            <img id="imageViewerImg" src="" alt="" class="max-w-full max-h-[80vh] object-contain rounded-lg">
            <p id="imageViewerTitle" class="text-gray-900 text-center mt-4 text-lg"></p>
            <div class="flex justify-center mt-4 space-x-4">
                <a id="imageViewerDownload" href="" download="" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    ‚¨áÔ∏è Baixar Imagem
                </a>
            </div>
        </div>
    </div>

</body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 300);
        }

        // ==================== FICHAS T√âCNICAS ====================
        function printTechnicalSheets() {
            if (pizzas.length === 0) {
                showAlert('Nenhuma pizza cadastrada para gerar fichas t√©cnicas!');
                return;
            }

            // Create print content
            const printContent = pizzas.map(pizza => {
                // Build preparations list (simplified - unit√°rio)
                const preparationsList = pizza.preparations.map(prep => {
                    const preparation = preparations.find(p => p.id === prep.preparationId);
                    if (preparation) {
                        const unitCost = preparation.unitCost * prep.quantity;
                        return {
                            name: preparation.name,
                            quantity: prep.quantity,
                            cost: unitCost
                        };
                    }
                    return null;
                }).filter(p => p !== null);

                // Build direct ingredients list
                const directIngredients = pizza.ingredients.map(ing => {
                    return {
                        name: ing.name,
                        quantity: ing.quantity,
                        unit: ing.unit,
                        cost: ing.totalCost
                    };
                });

                return `
                    <div class="technical-sheet">
                        ${pizza.image ? `
                            <div class="pizza-image-container">
                                <img src="${pizza.image}" alt="${pizza.name}" class="pizza-image" />
                            </div>
                        ` : ''}
                        <div class="sheet-header">
                            <h1>${pizza.name}</h1>
                            <div class="pizza-info">
                                <span class="badge">${pizza.size}</span>
                                <span class="badge badge-type">${pizza.type === 'doce' ? 'üç´ Doce' : 'üßÇ Salgada'}</span>
                            </div>
                        </div>

                        ${preparationsList.length > 0 ? `
                            <div class="sheet-section">
                                <h2>üç¥ Prepara√ß√µes</h2>
                                <table class="ingredients-table">
                                    <thead>
                                        <tr>
                                            <th>Prepara√ß√£o</th>
                                            <th>Quantidade</th>
                                            <th>Custo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${preparationsList.map(prep => `
                                            <tr>
                                                <td>${prep.name}</td>
                                                <td>${prep.quantity}x</td>
                                                <td>R$ ${prep.cost.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${directIngredients.length > 0 ? `
                            <div class="sheet-section">
                                <h2>üìã Ingredientes Diretos</h2>
                                <table class="ingredients-table">
                                    <thead>
                                        <tr>
                                            <th>Ingrediente</th>
                                            <th>Quantidade</th>
                                            <th>Custo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${directIngredients.map(ing => `
                                            <tr>
                                                <td>${ing.name}</td>
                                                <td>${ing.quantity.toFixed(2)} ${ing.unit}</td>
                                                <td>R$ ${ing.cost.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        <div class="sheet-section">
                            <h2>üí∞ Informa√ß√µes de Custo</h2>
                            <div class="cost-grid">
                                <div class="cost-item">
                                    <span class="cost-label">CMV (Custo Ingredientes):</span>
                                    <span class="cost-value">R$ ${pizza.baseCost.toFixed(2)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">Desperd√≠cio (${pizza.wastePercentage}%):</span>
                                    <span class="cost-value">R$ ${(pizza.baseCost * pizza.wastePercentage / 100).toFixed(2)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">Custos Adicionais:</span>
                                    <span class="cost-value">R$ ${pizza.additionalCost.toFixed(2)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">Custos Operacionais:</span>
                                    <span class="cost-value">R$ ${(pizza.operationalCost || 0).toFixed(2)}</span>
                                </div>
                                <div class="cost-item total">
                                    <span class="cost-label">Custo Total:</span>
                                    <span class="cost-value">R$ ${pizza.totalCost.toFixed(2)}</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">Margem de Lucro:</span>
                                    <span class="cost-value">${pizza.profitMargin}%</span>
                                </div>
                                <div class="cost-item highlight">
                                    <span class="cost-label">Pre√ßo de Venda:</span>
                                    <span class="cost-value">R$ ${pizza.salePrice.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>

                        <div class="sheet-footer">
                            <p>Ficha T√©cnica gerada em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Fichas T√©cnicas - Pizzas</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
                        .technical-sheet { background: white; padding: 30px; margin: 20px auto; max-width: 800px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); page-break-after: always; }
                        .technical-sheet:last-child { page-break-after: auto; }
                        .pizza-image-container { text-align: center; margin-bottom: 20px; }
                        .pizza-image { max-width: 400px; max-height: 300px; width: 100%; height: auto; border-radius: 8px; object-fit: cover; }
                        .sheet-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #6b46c1; padding-bottom: 15px; }
                        .sheet-header h1 { font-size: 32px; color: #6b46c1; margin-bottom: 10px; }
                        .pizza-info { display: flex; justify-content: center; gap: 10px; }
                        .badge { display: inline-block; padding: 5px 15px; background: #e5e7eb; border-radius: 20px; font-size: 14px; font-weight: 600; }
                        .badge-type { background: #fbbf24; color: #78350f; }
                        .sheet-section { margin-bottom: 25px; }
                        .sheet-section h2 { font-size: 18px; color: #6b46c1; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
                        .ingredients-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        .ingredients-table th, .ingredients-table td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                        .ingredients-table th { background: #f3f4f6; font-weight: 600; color: #6b46c1; }
                        .ingredients-table tr:hover { background: #f9fafb; }
                        .cost-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
                        .cost-item { display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 6px; }
                        .cost-item.total { background: #fee2e2; border-left: 4px solid #ef4444; }
                        .cost-item.highlight { background: #d1fae5; border-left: 4px solid #10b981; font-weight: bold; }
                        .cost-label { font-weight: 600; color: #4b5563; }
                        .cost-value { color: #1f2937; font-weight: 600; }
                        .sheet-footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #e5e7eb; color: #6b7280; font-size: 12px; }

                        @media print {
                            body { background: white; }
                            .technical-sheet { box-shadow: none; margin: 0; padding: 20px; page-break-after: always; }
                            .technical-sheet:last-child { page-break-after: auto; }
                        }
                    
        /* Sidebar Navigation */
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item.active {
            background-color: #374151;
            border-left: 3px solid #f59e0b;
        }
        
        .nav-item:not(.active) {
            border-left: 3px solid transparent;
        }
        
        /* Hide tab buttons since we use sidebar */
        .tab-button {
            display: none;
        }
        
        /* Cream accent for inputs */
        input:focus, select:focus, textarea:focus {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
        }
    </style>
                </head>
                <body>
                    ${printContent}
                
    <!-- Modal de Visualiza√ß√£o de Imagem -->
    <div id="imageViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" onclick="closeImageViewer()">
        <div class="relative max-w-4xl max-h-full">
            <button onclick="closeImageViewer()" class="absolute -top-10 right-0 text-gray-900 text-3xl hover:text-gray-300">&times;</button>
            <img id="imageViewerImg" src="" alt="" class="max-w-full max-h-[80vh] object-contain rounded-lg">
            <p id="imageViewerTitle" class="text-gray-900 text-center mt-4 text-lg"></p>
            <div class="flex justify-center mt-4 space-x-4">
                <a id="imageViewerDownload" href="" download="" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    ‚¨áÔ∏è Baixar Imagem
                </a>
            </div>
        </div>
    </div>

</body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus();

            // Wait for images to load before printing
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // ==================== COMBOS ====================
        function addComboPizza() {
            comboPizzaCount++;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-50 bg-gray-50 rounded-lg slide-in';
            div.id = `combo-pizza-${comboPizzaCount}`;
            div.innerHTML = `
                <select onchange="updateComboPreview()" class="combo-pizza-select px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-600 text-gray-900">
                    <option value="">Selecione a pizza...</option>
                    ${pizzas.map(p => `<option value="${p.id}">${p.name} (${p.size}) - R$ ${p.salePrice.toFixed(2)}</option>`).join('')}
                </select>
                <input type="number" onchange="updateComboPreview()" class="combo-pizza-qty px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-600 text-gray-900" placeholder="Quantidade" min="1" value="1">
                <button onclick="removeComboPizza(${comboPizzaCount})" class="px-4 py-2 text-base bg-red-500 text-gray-900 rounded-lg hover:bg-red-600 transition-colors">‚ùå Remover</button>
            `;
            document.getElementById('comboPizzasList').appendChild(div);
            updateComboPreview();
        }

        function removeComboPizza(id) {
            document.getElementById(`combo-pizza-${id}`)?.remove();
            updateComboPreview();
        }

        function addComboExtra() {
            comboExtraCount++;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-4 gap-3 p-3 bg-gray-50 bg-gray-50 rounded-lg slide-in';
            div.id = `combo-extra-${comboExtraCount}`;
            div.innerHTML = `
                <input type="text" onchange="updateComboPreview()" class="combo-extra-name px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-600 text-gray-900" placeholder="Nome (ex: Refrigerante 2L)">
                <input type="number" onchange="updateComboPreview()" class="combo-extra-cost px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-600 text-gray-900" placeholder="Custo (R$)" step="0.01" min="0">
                <input type="number" onchange="updateComboPreview()" class="combo-extra-price px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-600 text-gray-900" placeholder="Pre√ßo Venda (R$)" step="0.01" min="0">
                <button onclick="removeComboExtra(${comboExtraCount})" class="px-4 py-2 text-base bg-red-500 text-gray-900 rounded-lg hover:bg-red-600 transition-colors">‚ùå Remover</button>
            `;
            document.getElementById('comboExtrasList').appendChild(div);
            updateComboPreview();
        }

        function removeComboExtra(id) {
            document.getElementById(`combo-extra-${id}`)?.remove();
            updateComboPreview();
        }

        function updateComboPreview() {
            let totalCost = 0;
            let totalNormalPrice = 0;

            // Sum pizzas
            document.querySelectorAll('#comboPizzasList > div').forEach(div => {
                const select = div.querySelector('.combo-pizza-select');
                const qty = parseInt(div.querySelector('.combo-pizza-qty')?.value) || 1;
                if (select && select.value) {
                    const pizza = pizzas.find(p => p.id == select.value);
                    if (pizza) {
                        totalCost += pizza.totalCost * qty;
                        totalNormalPrice += pizza.salePrice * qty;
                    }
                }
            });

            // Sum extras
            document.querySelectorAll('#comboExtrasList > div').forEach(div => {
                const cost = parseFloat(div.querySelector('.combo-extra-cost')?.value) || 0;
                const price = parseFloat(div.querySelector('.combo-extra-price')?.value) || 0;
                totalCost += cost;
                totalNormalPrice += price;
            });

            const comboPrice = parseFloat(document.getElementById('comboPrice').value) || 0;
            const discount = totalNormalPrice > 0 ? ((totalNormalPrice - comboPrice) / totalNormalPrice * 100) : 0;
            const profit = comboPrice - totalCost;

            document.getElementById('comboCostPreview').textContent = `R$ ${totalCost.toFixed(2)}`;
            document.getElementById('comboNormalPrice').textContent = `R$ ${totalNormalPrice.toFixed(2)}`;
            document.getElementById('comboDiscount').textContent = `${discount.toFixed(1)}%`;
            document.getElementById('comboProfitPreview').textContent = `R$ ${profit.toFixed(2)}`;
            document.getElementById('comboProfitPreview').className = `font-bold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}`;

            if (totalCost > 0 || comboPrice > 0) {
                document.getElementById('comboPreview').classList.remove('hidden');
            }
        }

        function addCombo() {
            const name = document.getElementById('comboName').value.trim();
            const price = parseFloat(document.getElementById('comboPrice').value) || 0;

            if (!name || price <= 0) {
                showAlert('Preencha o nome e o pre√ßo do combo!');
                return;
            }

            const comboPizzasData = [];
            document.querySelectorAll('#comboPizzasList > div').forEach(div => {
                const select = div.querySelector('.combo-pizza-select');
                const qty = parseInt(div.querySelector('.combo-pizza-qty')?.value) || 1;
                if (select && select.value) {
                    comboPizzasData.push({ pizzaId: parseInt(select.value), quantity: qty });
                }
            });

            const comboExtrasData = [];
            document.querySelectorAll('#comboExtrasList > div').forEach(div => {
                const itemName = div.querySelector('.combo-extra-name')?.value.trim();
                const cost = parseFloat(div.querySelector('.combo-extra-cost')?.value) || 0;
                const itemPrice = parseFloat(div.querySelector('.combo-extra-price')?.value) || 0;
                if (itemName) {
                    comboExtrasData.push({ name: itemName, cost, price: itemPrice });
                }
            });

            if (comboPizzasData.length === 0) {
                showAlert('Adicione pelo menos uma pizza ao combo!');
                return;
            }

            let totalCost = 0;
            let totalNormalPrice = 0;
            comboPizzasData.forEach(cp => {
                const pizza = pizzas.find(p => p.id === cp.pizzaId);
                if (pizza) {
                    totalCost += pizza.totalCost * cp.quantity;
                    totalNormalPrice += pizza.salePrice * cp.quantity;
                }
            });
            comboExtrasData.forEach(ce => {
                totalCost += ce.cost;
                totalNormalPrice += ce.price;
            });

            const combo = {
                id: Date.now(),
                name,
                price,
                pizzas: comboPizzasData,
                extras: comboExtrasData,
                totalCost,
                normalPrice: totalNormalPrice,
                profit: price - totalCost,
                discount: totalNormalPrice > 0 ? ((totalNormalPrice - price) / totalNormalPrice * 100) : 0
            };

            combos.push(combo);
            renderCombos();
            clearComboForm();
            showAlert('Combo criado com sucesso!');
        }

        function clearComboForm() {
            document.getElementById('comboName').value = '';
            document.getElementById('comboPrice').value = '';
            document.getElementById('comboPizzasList').innerHTML = '';
            document.getElementById('comboExtrasList').innerHTML = '';
            document.getElementById('comboPreview').classList.add('hidden');
            comboPizzaCount = 0;
            comboExtraCount = 0;
        }

        function renderCombos() {
            const container = document.getElementById('combosList');
            if (combos.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-gray-500 col-span-full text-center py-8">Nenhum combo cadastrado ainda</p>';
                return;
            }

            container.innerHTML = combos.map(combo => {
                const pizzaNames = combo.pizzas.map(cp => {
                    const pizza = pizzas.find(p => p.id === cp.pizzaId);
                    return pizza ? `${cp.quantity}x ${pizza.name}` : '';
                }).filter(n => n).join(', ');

                const extraNames = combo.extras.map(e => e.name).join(', ');

                return `
                    <div class="bg-gray-50 bg-white rounded-xl shadow-lg p-4 border border-gray-300 border-gray-200 card-hover">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-bold text-lg text-gray-900 text-gray-900">üéÅ ${combo.name}</h4>
                            <div class="flex space-x-1">
                                <button onclick="editCombo(${combo.id})" class="text-blue-500 hover:text-blue-700 p-1" title="Editar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                                <button onclick="deleteCombo(${combo.id})" class="text-red-500 hover:text-red-700 p-1" title="Excluir">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 text-gray-500 mb-2">üçï ${pizzaNames}</p>
                        ${extraNames ? `<p class="text-sm text-gray-600 text-gray-500 mb-2">ü•§ ${extraNames}</p>` : ''}
                        <div class="grid grid-cols-2 gap-2 text-sm mt-3 pt-3 border-t border-gray-200 border-gray-200">
                            <div>
                                <p class="text-gray-500">Pre√ßo Normal</p>
                                <p class="font-semibold line-through text-gray-400">R$ ${combo.normalPrice.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Pre√ßo Combo</p>
                                <p class="font-bold text-green-600 text-lg">R$ ${combo.price.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Desconto</p>
                                <p class="font-semibold text-orange-600">${combo.discount.toFixed(1)}%</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Lucro</p>
                                <p class="font-semibold ${combo.profit >= 0 ? 'text-green-600' : 'text-red-600'}">R$ ${combo.profit.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteCombo(id) {
            showConfirmDialog('Tem certeza que deseja excluir este combo?', () => {
                combos = combos.filter(c => c.id !== id);
                renderCombos();
            });
        }

        let editingComboId = null;

        function editCombo(id) {
            const combo = combos.find(c => c.id === id);
            if (!combo) return;

            editingComboId = id;

            // Fill form with combo data
            document.getElementById('comboName').value = combo.name;
            document.getElementById('comboPrice').value = combo.price;

            // Clear and populate pizzas
            document.getElementById('comboPizzasList').innerHTML = '';
            comboPizzaCount = 0;
            combo.pizzas.forEach(cp => {
                addComboPizza();
                const lastDiv = document.querySelector('#comboPizzasList > div:last-child');
                if (lastDiv) {
                    const select = lastDiv.querySelector('.combo-pizza-select');
                    const qtyInput = lastDiv.querySelector('.combo-pizza-qty');
                    if (select) select.value = cp.pizzaId;
                    if (qtyInput) qtyInput.value = cp.quantity;
                }
            });

            // Clear and populate extras
            document.getElementById('comboExtrasList').innerHTML = '';
            comboExtraCount = 0;
            combo.extras.forEach(ce => {
                addComboExtra();
                const lastDiv = document.querySelector('#comboExtrasList > div:last-child');
                if (lastDiv) {
                    const nameInput = lastDiv.querySelector('.combo-extra-name');
                    const costInput = lastDiv.querySelector('.combo-extra-cost');
                    const priceInput = lastDiv.querySelector('.combo-extra-price');
                    if (nameInput) nameInput.value = ce.name;
                    if (costInput) costInput.value = ce.cost;
                    if (priceInput) priceInput.value = ce.price;
                }
            });

            // Update preview
            updateComboPreview();

            // Change button text to indicate editing
            const submitBtn = document.querySelector('#content-combos button[onclick="addCombo()"]');
            if (submitBtn) {
                submitBtn.innerHTML = '‚úì Atualizar Combo';
                submitBtn.setAttribute('onclick', 'saveEditedCombo()');
            }

            // Scroll to form
            document.getElementById('comboName').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function saveEditedCombo() {
            const name = document.getElementById('comboName').value.trim();
            const price = parseFloat(document.getElementById('comboPrice').value);

            if (!name || isNaN(price) || price <= 0) {
                showAlert('Preencha o nome e o pre√ßo do combo!');
                return;
            }

            const comboPizzasData = [];
            document.querySelectorAll('#comboPizzasList > div').forEach(div => {
                const select = div.querySelector('.combo-pizza-select');
                const qty = parseInt(div.querySelector('.combo-pizza-qty')?.value) || 1;
                if (select && select.value) {
                    comboPizzasData.push({ pizzaId: parseInt(select.value), quantity: qty });
                }
            });

            const comboExtrasData = [];
            document.querySelectorAll('#comboExtrasList > div').forEach(div => {
                const itemName = div.querySelector('.combo-extra-name')?.value.trim();
                const cost = parseFloat(div.querySelector('.combo-extra-cost')?.value) || 0;
                const itemPrice = parseFloat(div.querySelector('.combo-extra-price')?.value) || 0;
                if (itemName) {
                    comboExtrasData.push({ name: itemName, cost, price: itemPrice });
                }
            });

            if (comboPizzasData.length === 0) {
                showAlert('Adicione pelo menos uma pizza ao combo!');
                return;
            }

            let totalCost = 0;
            let totalNormalPrice = 0;
            comboPizzasData.forEach(cp => {
                const pizza = pizzas.find(p => p.id === cp.pizzaId);
                if (pizza) {
                    totalCost += pizza.totalCost * cp.quantity;
                    totalNormalPrice += pizza.salePrice * cp.quantity;
                }
            });
            comboExtrasData.forEach(ce => {
                totalCost += ce.cost;
                totalNormalPrice += ce.price;
            });

            // Find and update the combo
            const comboIndex = combos.findIndex(c => c.id === editingComboId);
            if (comboIndex !== -1) {
                combos[comboIndex] = {
                    id: editingComboId,
                    name,
                    price,
                    pizzas: comboPizzasData,
                    extras: comboExtrasData,
                    totalCost,
                    normalPrice: totalNormalPrice,
                    profit: price - totalCost,
                    discount: totalNormalPrice > 0 ? ((totalNormalPrice - price) / totalNormalPrice * 100) : 0
                };
            }

            renderCombos();
            clearComboForm();
            cancelComboEdit();
            showAlert('Combo atualizado com sucesso!');
        }

        function cancelComboEdit() {
            editingComboId = null;
            const submitBtn = document.querySelector('#content-combos button[onclick="saveEditedCombo()"]');
            if (submitBtn) {
                submitBtn.innerHTML = '‚úì Criar Combo';
                submitBtn.setAttribute('onclick', 'addCombo()');
            }
        }

        // ==================== AN√ÅLISE DE PRODUTOS ====================
        function calculateBreakeven() {
            const totalFixedCosts = operationalCosts.rent + operationalCosts.electricity + operationalCosts.water +
                operationalCosts.gas + operationalCosts.salaries + operationalCosts.internet +
                operationalCosts.cleaning + operationalCosts.marketing + operationalCosts.bankFees +
                operationalCosts.taxes + operationalCosts.others;

            if (pizzas.length === 0) {
                return { breakeven: 0, breakevenPizzas: 0, avgMargin: 0 };
            }

            const avgSalePrice = pizzas.reduce((sum, p) => sum + p.salePrice, 0) / pizzas.length;
            const avgCost = pizzas.reduce((sum, p) => sum + p.totalCost, 0) / pizzas.length;
            const avgProfit = avgSalePrice - avgCost;
            const avgMargin = avgSalePrice > 0 ? (avgProfit / avgSalePrice * 100) : 0;

            const breakeven = avgMargin > 0 ? (totalFixedCosts / (avgMargin / 100)) : 0;
            const breakevenPizzas = avgSalePrice > 0 ? Math.ceil(breakeven / avgSalePrice) : 0;

            return { breakeven, breakevenPizzas, avgMargin, totalFixedCosts };
        }

        function calculateCurvaABC() {
            if (pizzas.length === 0) return [];

            const sortedPizzas = [...pizzas].sort((a, b) => b.profit - a.profit);
            const totalProfit = sortedPizzas.reduce((sum, p) => sum + Math.max(0, p.profit), 0);

            let accumulated = 0;
            return sortedPizzas.map(pizza => {
                accumulated += Math.max(0, pizza.profit);
                const percentAccumulated = totalProfit > 0 ? (accumulated / totalProfit * 100) : 0;
                let classification = 'C';
                if (percentAccumulated <= 80) classification = 'A';
                else if (percentAccumulated <= 95) classification = 'B';

                const margin = pizza.salePrice > 0 ? (pizza.profit / pizza.salePrice * 100) : 0;

                return {
                    ...pizza,
                    percentAccumulated,
                    classification,
                    margin
                };
            });
        }

        function renderAnalysis() {
            // Calculate breakeven
            const { breakeven, breakevenPizzas, avgMargin } = calculateBreakeven();
            const kpiBreakeven = document.getElementById('kpi-breakeven');
            const kpiBreakevenPizzas = document.getElementById('kpi-breakeven-pizzas');
            const kpiAvgMargin = document.getElementById('kpi-avg-margin');
            const kpiClassA = document.getElementById('kpi-class-a');
            
            if (kpiBreakeven) kpiBreakeven.textContent = `R$ ${breakeven.toFixed(2)}`;
            if (kpiBreakevenPizzas) kpiBreakevenPizzas.textContent = breakevenPizzas.toString();
            if (kpiAvgMargin) kpiAvgMargin.textContent = `${avgMargin.toFixed(1)}%`;

            // Calculate Curva ABC
            const curvaABC = calculateCurvaABC();
            const classACount = curvaABC.filter(p => p.classification === 'A').length;
            if (kpiClassA) kpiClassA.textContent = classACount.toString();

            // Render Curva ABC table
            const tableBody = document.getElementById('curvaAbcTable');
            if (!tableBody) return; // Elements don't exist yet
            if (curvaABC.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500 text-gray-500">Cadastre pizzas para ver a an√°lise</td></tr>';
            } else {
                tableBody.innerHTML = curvaABC.map(pizza => {
                    const classColors = {
                        'A': 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-400',
                        'B': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-400',
                        'C': 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-400'
                    };
                    return `
                        <tr class="border-b border-gray-100 border-gray-200 hover:bg-gray-50 dark:hover:bg-gray-50">
                            <td class="py-3 px-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${classColors[pizza.classification]}">${pizza.classification}</span></td>
                            <td class="py-3 px-4 font-medium text-gray-900 text-gray-900">${pizza.name} (${pizza.size})</td>
                            <td class="py-3 px-4 text-right">R$ ${pizza.salePrice.toFixed(2)}</td>
                            <td class="py-3 px-4 text-right ${pizza.profit >= 0 ? 'text-green-600' : 'text-red-600'}">R$ ${pizza.profit.toFixed(2)}</td>
                            <td class="py-3 px-4 text-right">${pizza.margin.toFixed(1)}%</td>
                            <td class="py-3 px-4 text-right">${pizza.percentAccumulated.toFixed(1)}%</td>
                        </tr>
                    `;
                }).join('');
            }

            // Render sales forecast list
            renderSalesForecast();

            // Render price history dropdown
            renderPriceHistoryDropdown();
        }

        function renderSalesForecast() {
            const container = document.getElementById('salesForecastList');
            if (!container) return; // Element doesn't exist yet
            if (pizzas.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-gray-500">Cadastre pizzas primeiro</p>';
                return;
            }

            container.innerHTML = pizzas.map(pizza => `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-50 bg-gray-50 rounded-lg">
                    <span class="font-medium text-gray-900 text-gray-900 self-center">${pizza.name} (${pizza.size})</span>
                    <input type="number" id="forecast-${pizza.id}" class="px-4 py-2 text-base border border-gray-300 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-600 text-gray-900" placeholder="Quantidade prevista" min="0" value="0">
                    <span class="text-sm text-gray-500 text-gray-500 self-center">unidades</span>
                </div>
            `).join('');
        }

        function generateShoppingList() {
            const ingredientNeeds = {};

            pizzas.forEach(pizza => {
                const qty = parseInt(document.getElementById(`forecast-${pizza.id}`)?.value) || 0;
                if (qty <= 0) return;

                // From preparations
                pizza.preparations?.forEach(prep => {
                    const preparation = preparations.find(p => p.id === prep.preparationId);
                    if (preparation) {
                        preparation.ingredients?.forEach(ing => {
                            const ingredient = ingredients.find(i => i.id === ing.ingredientId);
                            if (ingredient) {
                                const neededQty = ing.quantity * qty;
                                if (!ingredientNeeds[ingredient.id]) {
                                    ingredientNeeds[ingredient.id] = { ingredient, quantity: 0 };
                                }
                                ingredientNeeds[ingredient.id].quantity += neededQty;
                            }
                        });
                    }
                });

                // From direct ingredients
                pizza.ingredients?.forEach(ing => {
                    const ingredient = ingredients.find(i => i.id === ing.ingredientId);
                    if (ingredient) {
                        const neededQty = ing.quantity * qty;
                        if (!ingredientNeeds[ingredient.id]) {
                            ingredientNeeds[ingredient.id] = { ingredient, quantity: 0 };
                        }
                        ingredientNeeds[ingredient.id].quantity += neededQty;
                    }
                });
            });

            const shoppingList = Object.values(ingredientNeeds);
            if (shoppingList.length === 0) {
                showAlert('Informe a quantidade prevista de vendas para pelo menos uma pizza!');
                return;
            }

            let totalCost = 0;
            const tableBody = document.getElementById('shoppingListTable');
            tableBody.innerHTML = shoppingList.map(item => {
                const cost = item.ingredient.cost * item.quantity;
                totalCost += cost;
                const supplier = suppliers.find(s => s.id === item.ingredient.supplierId);
                return `
                    <tr class="border-b border-gray-100 border-gray-200">
                        <td class="py-3 px-4 font-medium text-gray-900 text-gray-900">${item.ingredient.name}</td>
                        <td class="py-3 px-4 text-right">${item.quantity.toFixed(3)}</td>
                        <td class="py-3 px-4">${item.ingredient.unit}</td>
                        <td class="py-3 px-4 text-right">R$ ${cost.toFixed(2)}</td>
                        <td class="py-3 px-4">${supplier ? supplier.name : '-'}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('shoppingListTotal').textContent = `R$ ${totalCost.toFixed(2)}`;
            document.getElementById('shoppingListResult').classList.remove('hidden');
        }

        // ==================== HIST√ìRICO DE PRE√áOS ====================
        function recordPriceChange(ingredientId, oldPrice, newPrice) {
            if (!priceHistory[ingredientId]) {
                priceHistory[ingredientId] = [];
            }
            priceHistory[ingredientId].push({
                date: new Date().toISOString(),
                oldPrice,
                newPrice
            });
        }

        function renderPriceHistoryDropdown() {
            // This function is now replaced by renderPriceHistoryList
            renderPriceHistoryList();
        }

        function renderPriceHistoryList() {
            const container = document.getElementById('priceHistoryList');
            if (!container) return;

            // Get ingredients that have price history
            const ingredientsWithHistory = ingredients.filter(ing => {
                const history = priceHistory[ing.id] || [];
                return history.length > 0;
            });

            if (ingredientsWithHistory.length === 0) {
                container.innerHTML = '<p class="text-center py-8 text-gray-500 text-gray-500">Nenhum ingrediente com hist√≥rico de pre√ßos</p>';
                return;
            }

            container.innerHTML = ingredientsWithHistory.map(ing => {
                const history = priceHistory[ing.id] || [];
                // Include BOTH old prices and new prices in calculations
                const allPrices = [];
                history.forEach(h => {
                    if (h.oldPrice > 0) allPrices.push(h.oldPrice);
                    if (h.newPrice > 0) allPrices.push(h.newPrice);
                });
                // Also include current price
                const currentPrice = ing.cost;
                if (currentPrice > 0) allPrices.push(currentPrice);
                
                const minPrice = allPrices.length > 0 ? Math.min(...allPrices) : 0;
                const maxPrice = allPrices.length > 0 ? Math.max(...allPrices) : 0;
                const avgPrice = allPrices.length > 0 ? allPrices.reduce((a, b) => a + b, 0) / allPrices.length : 0;

                return `
                    <div class="border border-gray-200 border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 bg-gray-50 p-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="togglePriceHistory('${ing.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-lg" id="price-arrow-${ing.id}">‚ñ∂</span>
                                    <span class="font-semibold text-gray-900 text-gray-900">${ing.name}</span>
                                    <span class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded text-gray-600 text-gray-600">${history.length} altera√ß√µes</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-4 mt-3 text-sm">
                                <div class="text-center">
                                    <p class="text-gray-500 text-gray-500">Menor</p>
                                    <p class="font-bold text-green-600">R$ ${minPrice.toFixed(2)}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-gray-500 text-gray-500">Maior</p>
                                    <p class="font-bold text-red-600">R$ ${maxPrice.toFixed(2)}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-gray-500 text-gray-500">M√©dio</p>
                                    <p class="font-bold text-blue-600">R$ ${avgPrice.toFixed(2)}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-gray-500 text-gray-500">Atual</p>
                                    <p class="font-bold text-gray-900 text-gray-900">R$ ${currentPrice.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        <div id="price-history-${ing.id}" class="hidden bg-white bg-white p-4 border-t border-gray-200 border-gray-200">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-gray-500 text-gray-500 border-b border-gray-200 border-gray-200">
                                        <th class="py-2 px-3 text-left">Data</th>
                                        <th class="py-2 px-3 text-right">Pre√ßo Anterior</th>
                                        <th class="py-2 px-3 text-right">Novo Pre√ßo</th>
                                        <th class="py-2 px-3 text-right">Varia√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${history.slice().reverse().map(h => {
                                        const variation = h.oldPrice > 0 ? ((h.newPrice - h.oldPrice) / h.oldPrice * 100) : 0;
                                        const variationClass = variation > 0 ? 'text-red-600' : variation < 0 ? 'text-green-600' : 'text-gray-600';
                                        return `
                                            <tr class="border-b border-gray-100 border-gray-200">
                                                <td class="py-2 px-3">${new Date(h.date).toLocaleDateString('pt-BR')} ${new Date(h.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</td>
                                                <td class="py-2 px-3 text-right">R$ ${h.oldPrice.toFixed(2)}</td>
                                                <td class="py-2 px-3 text-right">R$ ${h.newPrice.toFixed(2)}</td>
                                                <td class="py-2 px-3 text-right ${variationClass}">${variation > 0 ? '+' : ''}${variation.toFixed(1)}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function togglePriceHistory(ingredientId) {
            const content = document.getElementById(`price-history-${ingredientId}`);
            const arrow = document.getElementById(`price-arrow-${ingredientId}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.textContent = '‚ñº';
            } else {
                content.classList.add('hidden');
                arrow.textContent = '‚ñ∂';
            }
        }

        // ==================== IMAGE VIEWING AND DOWNLOAD ====================
        function viewImage(imageUrl, title) {
            // Create modal for image viewing
            const modal = document.createElement('div');
            modal.id = 'imageViewModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full">
                    <div class="bg-white bg-white rounded-lg shadow-2xl overflow-hidden">
                        <div class="flex items-center justify-between p-4 border-b border-gray-200 border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 text-gray-900">${title}</h3>
                            <div class="flex items-center gap-2">
                                <button onclick="downloadImage('${imageUrl}', '${title.replace(/'/g, "\\'")}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Baixar
                                </button>
                                <button onclick="document.getElementById('imageViewModal').remove()" class="text-gray-500 hover:text-gray-700 text-gray-500 dark:hover:text-gray-200 p-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <img src="${imageUrl}" alt="${title}" class="max-w-full max-h-[70vh] object-contain mx-auto rounded-lg">
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function downloadImage(imageUrl, filename) {
            // Create a temporary link to download the image
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = filename.replace(/[^a-zA-Z0-9_-]/g, '_') + '.jpg';
            link.target = '_blank';
            
            // For data URLs or same-origin images, download directly
            if (imageUrl.startsWith('data:') || imageUrl.startsWith(window.location.origin)) {
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // For external URLs, try to fetch and download
                fetch(imageUrl)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    })
                    .catch(() => {
                        // If fetch fails, open in new tab
                        window.open(imageUrl, '_blank');
                    });
            }
        }

        // ==================== EXPORTA√á√ÉO CSV ====================
        function exportAnalysisCSV() {
            const curvaABC = calculateCurvaABC();
            if (curvaABC.length === 0) {
                showAlert('N√£o h√° dados para exportar!');
                return;
            }

            let csv = 'Classe,Pizza,Tamanho,Pre√ßo Venda,Lucro Unit√°rio,Margem %,% Acumulado\n';
            curvaABC.forEach(p => {
                csv += `${p.classification},"${p.name}",${p.size},${p.salePrice.toFixed(2)},${p.profit.toFixed(2)},${p.margin.toFixed(1)},${p.percentAccumulated.toFixed(1)}\n`;
            });

            downloadCSV(csv, 'curva_abc_produtos.csv');
        }

        function exportShoppingListCSV() {
            const rows = document.querySelectorAll('#shoppingListTable tr');
            if (rows.length === 0) {
                showAlert('Gere a lista de compras primeiro!');
                return;
            }

            let csv = 'Ingrediente,Quantidade,Unidade,Custo Estimado,Fornecedor\n';
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    csv += `"${cells[0].textContent}",${cells[1].textContent},${cells[2].textContent},"${cells[3].textContent}","${cells[4].textContent}"\n`;
                }
            });

            downloadCSV(csv, 'lista_compras.csv');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // ==================== ATUALIZA√á√ÉO DO EXPORT/IMPORT ====================
        // Override exportProject to include new data
        const originalExportProject = typeof exportProject === 'function' ? exportProject : null;
        function exportProjectEnhanced() {
            const data = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                suppliers,
                ingredients,
                preparations,
                pizzas,
                platforms,
                operationalCosts,
                managementData,
                combos,
                priceHistory
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pizzaria_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Override the export button
        window.exportProject = exportProjectEnhanced;

        // Update import to handle new data
        const originalImportProject = typeof importProject === 'function' ? importProject : null;
        function importProjectEnhanced(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Handle both old format (direct data) and new format (data wrapper)
                    let data;
                    if (jsonData.data) {
                        // New format with data wrapper (version 4.0+)
                        data = jsonData.data;
                    } else {
                        // Old format without data wrapper (version 2.0)
                        data = jsonData;
                    }
                    
                    suppliers = data.suppliers || [];
                    ingredients = data.ingredients || [];
                    preparations = data.preparations || [];
                    pizzas = data.pizzas || [];
                    platforms = data.platforms || [];
                    if (data.operationalCosts) {
                        operationalCosts = data.operationalCosts;
                    }
                    managementData = data.managementData || [];
                    combos = data.combos || [];
                    priceHistory = data.priceHistory || {};

                    renderSuppliers();
                    renderIngredients();
                    renderPreparations();
                    renderPizzas();
                    renderPlatforms();
                    renderCombos();
                    renderAnalysis();
                    renderOperationalCosts();
                    if (typeof renderManagementData === 'function') renderManagementData();
                    if (typeof updateDashboard === 'function') updateDashboard();
                    renderDashboard();

                    showAlert('Dados importados com sucesso!');
                } catch (error) {
                    showAlert('Erro ao importar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        window.importProject = importProjectEnhanced;

        // Initialize
        renderSuppliers();
        renderIngredients();
        renderPreparations();
        renderPizzas();
        renderPlatforms();
        renderCombos();
        renderAnalysis();

        // Set initial tab to dashboard
        switchTab('dashboard');
        // Activate dashboard nav item on load
        document.getElementById('nav-dashboard').classList.add('active');

        // Initialize Google Auth when page loads with robust polling
        function waitForGoogleApi(callback, maxAttempts = 20) {
            let attempts = 0;
            const checkGoogle = () => {
                attempts++;
                if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                    console.log('Google API ready after ' + attempts + ' attempts');
                    callback(true);
                } else if (window.googleApiLoadError) {
                    console.error('Google API load error detected');
                    callback(false);
                } else if (attempts >= maxAttempts) {
                    console.warn('Google API not available after ' + maxAttempts + ' attempts');
                    callback(false);
                } else {
                    setTimeout(checkGoogle, 500);
                }
            };
            checkGoogle();
        }

        window.onload = function() {
            // Set callback for when Google API loads (if not already loaded)
            window.onGoogleReady = () => {
                if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                    GoogleAuth.init();
                }
            };

            // Start polling for Google API
            waitForGoogleApi((success) => {
                if (success) {
                    GoogleAuth.init();
                } else {
                    GoogleAuth.continueOffline();
                }
            });
        };
    </script>




    <!-- Modal de Visualiza√ß√£o de Imagem -->
    <div id="imageViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" onclick="closeImageViewer()">
        <div class="relative max-w-4xl max-h-full">
            <button onclick="closeImageViewer()" class="absolute -top-10 right-0 text-gray-900 text-3xl hover:text-gray-300">&times;</button>
            <img id="imageViewerImg" src="" alt="" class="max-w-full max-h-[80vh] object-contain rounded-lg">
            <p id="imageViewerTitle" class="text-gray-900 text-center mt-4 text-lg"></p>
            <div class="flex justify-center mt-4 space-x-4">
                <a id="imageViewerDownload" href="" download="" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    ‚¨áÔ∏è Baixar Imagem
                </a>
            </div>
        </div>
    </div>

</body></html>